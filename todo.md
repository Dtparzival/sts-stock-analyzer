# 美股投資分析平台 TODO

## 核心功能

- [x] 股票搜尋功能
  - [x] 股票代碼搜尋
  - [x] 公司名稱搜尋
  - [x] 搜尋結果展示

- [x] 股票資訊展示
  - [x] 即時股價資訊
  - [x] 歷史價格圖表
  - [x] 公司基本資料
  - [x] 財務指標

- [x] 投資分析功能
  - [x] 技術分析指標
  - [x] 基本面分析
  - [x] AI 驅動的投資建議
  - [x] 風險評估

- [x] 未來趨勢預測
  - [x] 價格趨勢預測
  - [x] 市場情緒分析
  - [x] 行業比較分析

- [x] 用戶功能
  - [x] 收藏股票列表
  - [x] 個人投資組合追蹤
  - [x] 歷史查詢記錄

## 技術實作

- [x] 整合股票數據API
- [x] 設計資料庫架構
- [x] 實作後端 tRPC procedures
- [x] 設計前端 UI/UX
- [x] 實作圖表視覺化
- [x] 整合 LLM 進行分析析

## 優化與測試

- [x] 效能優化
- [x] 錯誤處理
- [x] 響應式設計
- [x] 跨瀏覽器測試

## 新增功能：互動式股價走勢圖

- [x] 安裝 Recharts 圖表庫
- [x] 創建股價走勢圖表組件
- [x] 實作多時間範圍切換（1天、5天、1個月、3個月、1年、5年）
- [x] 整合圖表到股票詳情頁面
- [x] 添加圖表互動功能（懸停顯示數據點）
- [x] 優化圖表載入狀態和錯誤處理
- [x] 測試圖表在不同時間範圍的顯示效果

## 新增功能：自訂日期範圍查詢

- [x] 安裝日期選擇器組件庫
- [x] 創建日期範圍選擇器UI
- [x] 實作日期驗證邏輯（起始日期不能晚於結束日期）
- [x] 整合日期選擇器到股價圖表組件
- [x] 更新後端API支援自訂日期範圍查詢
- [x] 添加日期格式化和顯示
- [x] 測試不同日期範圍的查詢功能

## 新增功能：主題調整與功能完善

### 淺色主題
- [x] 更新 App.tsx 主題設定為 light
- [x] 調整 index.css 淺色主題配色
- [x] 測試所有頁面在淺色主題下的顯示效果

### 投資組合功能完善
- [x] 設計投資組合資料庫表結構
- [x] 實作新增持股功能（股票代碼、購買價格、數量、購買日期）
- [x] 實作編輯持股功能（可通過刪除再新增實現）
- [x] 實作刪除持股功能
- [x] 計算投資組合總價值和損益
- [x] 顯示每支股票的當前價格和損益百分比
- [x] 添加投資組合圖表視覺化

### AI 投資顧問
- [x] 整合 AIChatBox 組件
- [x] 創建 AI 顧問頁面或側邊欄
- [x] 實作後端 LLM 整合處理用戶提問
- [x] 支援股票相關問題回答
- [x] 測試 AI 對話功能（需要用戶登入）

## 新增需求：UI/UX 改進

- [x] 修正首頁功能卡片點擊事件（即時股票數據、AI 投資分析）
- [x] 新增用戶登出按鈕到頂部導航欄
- [x] 將 AI 投資顧問改為浮動聊天按鈕（右下角）
- [x] 實作 AI 顧問彈出視窗功能
- [x] 測試所有點擊和互動功能

## 新增需求：修正顯示問題與功能增強

- [x] 修正 AI 投資顧問聊天視窗的文字排版問題
- [x] 為投資分析頁面添加「重新生成分析」按鈕
- [x] 為投資分析頁面添加「下載 PDF 報告」按鈕
- [x] 實作 PDF 報告生成功能
- [x] 測試所有新增功能

## 新增需求：修正功能問題

- [x] 修正未登入用戶無法使用網站基本功能的問題
- [x] 允許未登入用戶查看股票資訊和AI分析
- [x] 修正 PDF 下載功能錯誤（已移除功能）
- [x] 移除投資分析和趨勢預測的「重新生成」按鈕
- [x] 調整緩存機制確保分析結果為最新時間
- [x] 測試所有修正功能

## 新增問題：圖表時間區間切換無反應

- [x] 檢查 StockChart 組件的時間範圍切換邏輯
- [x] 修正時間區間按鈕點擊無反應的問題
- [x] 確保圖表數據根據選擇的時間範圍正確更新
- [x] 測試所有時間範圍按鈕（1天、5天、1個月、3個月、1年、5年）

## 新增問題：圖表時間區間按鈕選中狀態不同步

- [x] 修正 StockChart 組件的按鈕選中狀態同步問題
- [x] 確保按鈕高亮狀態跟隨用戶選擇更新
- [x] 測試所有時間範圍按鈕的選中狀態顯示

## 新增需求：未來趨勢預測以系統日期為起算點

- [x] 檢查當前趨勢預測的實作邏輯
- [x] 修正趨勢預測 prompt，明確指定以系統當前日期為起算點
- [x] 確保預測結果包含具體的未來日期範圍
- [x] 測試趨勢預測功能確認日期正確

## 新增需求：更新版權年份

- [x] 將首頁頁尾的版權年份從 2024 更新為 2025
- [x] 測試頁面顯示確認修改正確

## 新增問題：未來趨勢預測數據不是最新的

- [x] 檢查趨勢預測的數據來源和緩存機制
- [x] 確保趨勢預測使用最新的股價數據
- [x] 在 prompt 中明確說明當前最新的股價和日期
- [x] 調整緩存策略確保數據時效性
- [x] 測試修正後的趨勢預測功能

## 新增問題：投資組合當前價格無法顯示

- [x] 檢查投資組合頁面的當前價格獲取邏輯
- [x] 修正股票即時價格 API 調用問題
- [x] 確保損益和報酬率能正確計算
- [x] 測試投資組合頁面的所有功能

## 新增功能：投資組合歷史追蹤

- [x] 設計 portfolioHistory 資料庫表結構
- [x] 實作每日記錄投資組合價值的後端邏輯
- [x] 開發獲取歷史數據的 tRPC API
- [x] 實作績效曲線圖組件（使用 recharts）
- [x] 添加時間範圍選擇器（7天、30天、90天、全部）
- [x] 顯示累計報酬率變化趨勢
- [x] 測試歷史追蹤功能

## 新增功能：持倉分析儀表板

- [x] 實作持倉分布圓餅圖（按股票代碼）
- [x] 開發產業配置分析功能
- [x] 實作風險評估指標（集中度、波動性）
- [x] 設計並實作分析儀表板 UI
- [x] 添加投資建議功能
- [x] 測試分析儀表板功能

## 新增問題：手機版頂部導航欄跑版

- [x] 檢查頂部導航欄的響應式設計
- [x] 修正手機版標題和按鈕的排版
- [x] 確保所有導航按鈕在小螢幕上完整顯示
- [x] 調整按鈕間距和大小適應手機螢幕
- [x] 測試修正後的手機顯示效果

## 新增問題：投資組合頁面手機版時間範圍選擇器跑版

- [x] 檢查投資組合績效圖表組件的響應式設計
- [x] 修正標題和時間按鈕的排列方式（改為上下排列）
- [x] 調整時間選擇按鈕的大小和間距
- [x] 確保所有按鈕在小螢幕上完整顯示
- [x] 測試修正後的手機顯示效果

## 新增功能：台灣股票市場支援

- [x] 研究台股數據 API（Yahoo Finance Taiwan 或其他數據源）
- [x] 設計市場切換功能的資料結構
- [x] 實作前端市場選擇器 UI（美股/台股切換）
- [x] 修改股票搜尋功能支援台股代碼格式（xxxx.TW）
- [x] 整合台股數據 API 到後端
- [x] 添加台股熱門標的列表（台積電、鴻海、聯發科等）
- [x] 實作台幣（TWD）價格顯示格式
- [x] 測試台股數據獲取和顯示功能
- [x] 測試市場切換功能
- [x] 測試台股 AI 投資分析功能
- [x] 測試台股未來趨勢預測功能
- [ ] 調整交易時間顯示（台股 09:00-13:30）

## 新增需求：全面檢查並完善台股市場支援

- [x] 檢查收藏列表頁面是否支援台股
- [x] 檢查投資組合頁面是否支援台股
- [x] 檢查搜尋歷史頁面是否支援台股
- [x] 為收藏列表添加市場標籤顯示
- [x] 為搜尋歷史添加市場標籤顯示
- [x] 為投資組合添加市場標籤和台幣貨幣符號支援
- [x] 確保所有價格顯示都能正確處理台幣格式
- [x] 測試收藏列表的台股功能
- [x] 測試搜尋歷史的台股功能
- [x] 測試投資組合的台股功能

## 新增功能：市場篩選、匯率轉換和即時報價

### 市場篩選功能
- [x] 在收藏列表頁面添加市場篩選器（全部/美股/台股）
- [x] 在搜尋歷史頁面添加市場篩選器（全部/美股/台股）
- [x] 實作篩選逻輯和狀態管理
- [x] 測試市場篩選功能

### 匯率轉換功能
- [x] 研究台幣/美元匯率 API 或使用固定匯率（使用固定匯率 1 USD = 31.5 TWD）
- [x] 在投資組合頁面添加貨幣切換按鈕（TWD/USD）
- [x] 實作匯率轉換計算逻輯
- [x] 更新所有統計卡片支援貨幣切換
- [x] 測試匯率轉換功能

### 台股即時報價功能
- [x] 實作盤中時間判斷逻輯（09:00-13:30）
- [x] 添加自動刷新機制（盤中每 60 秒更新）
- [x] 在股票詳情頁顯示即時報價狀態（盤中時段顯示綠色標籤）
- [x] 測試台股即時報價功能（非交易時間不顯示標籤）

## 新增需求：整合即時匯率 API

- [x] 研究並選擇合適的免費匯率 API（使用 ExchangeRate-API）
- [x] 在後端實作匯率獲取功能
- [x] 實作匯率數據緩存機制（1小時有效期）
- [x] 創建 tRPC API 提供即時匯率數據
- [x] 更新投資組合頁面使用即時匯率替換固定匯率
- [x] 添加匯率更新時間顯示
- [x] 測試即時匯率功能（確認使用 1 USD = 30.6437 TWD 即時匯率）

## 新增需求：投資組合 AI 分析功能

### 功能設計
- [x] 設計 AI 分析的數據結構和分析維度
- [x] 定義風險評估指標（風險等級、分散程度、波動率等）
- [x] 定義資產配置分析維度（行業分布、市場分布、個股集中度）
- [x] 設計優化建議的輸出格式

### 後端實作
- [x] 創建 tRPC API endpoint（portfolio.getAIAnalysis）
- [x] 實作持倉數據收集和整理逻輯
- [x] 整合 LLM API 進行智能分析
- [x] 實作風險評估計算逻輯
- [x] 實作資產配置分析逻輯
- [x] 生成具體的優化建議和再平衡建議

### 前端實作
- [x] 在投資組合頁面添加「AI 智能分析」按鈕
- [x] 創建 AI 分析結果顯示組件（使用 Streamdown 渲染 Markdown）
- [x] 添加載入狀態和錯誤處理

### 測試
- [x] 測試 AI 分析功能的準確性
- [x] 測試持倉組合的分析結果（TSLA, 2330.TW, AAPL）
- [x] 測試 UI 顯示和交互體驗

## 修正需求：投資組合頁面匯率切換問題

- [x] 檢查投資組合頁面的匯率轉換逻輯
- [x] 找出未即時更新的數值欄位（持倉明細表格）
- [x] 修正持倉明細表格的貨幣顯示（購買價格、當前價格、成本、市值、損益）
- [x] 實作美股/台股的匯率轉換逻輯（美股轉台幣、台股轉美元）
- [x] 確保所有價格欄位都能正確響應匯率切換
- [x] 測試 USD 和 TWD 切換功能
- [x] 確認統計卡片和持倉明細表格的數值同步更新

## 修正需求：Yahoo Finance API 速率限制錯誤

- [x] 檢查當前的 API 請求逻輯
- [x] 實作股票數據記憶體緩存機制（5 分鐘有效期）
- [x] 為 getStockData, getStockInsights, getStockHolders 添加緩存
- [x] 實作 429 錯誤的友好提示
- [x] 添加緩存回退機制（當 429 錯誤時嘗試返回緩存數據）
- [x] 優化搜尋歷史記錄（異步處理，不阻塞主請求）

**說明：**
緩存機制已實作完成，但由於 Yahoo Finance API 的速率限制非常嚴格，第一次請求仍可能觸發 429 錯誤。第二次請求相同股票時，會從緩存返回數據，不會再觸發 API 請求。建議等待 5-10 分鐘讓 API 速率限制重置後再試。

## 新增需求：資料庫緩存系統和 UI 改進

### 資料庫緩存系統
- [x] 設計 stockDataCache 資料庫表結構（cacheKey, apiEndpoint, data, createdAt, expiresAt）
- [x] 實作資料庫緩存服務模組（dbStockDataCache.ts）
- [x] 將 getStockData API 整合資料庫緩存
- [x] 將 getStockInsights API 整合資料庫緩存
- [x] 將 getStockHolders API 整合資料庫緩存
- [x] 將搜尋歷史記錄的公司名稱緩存整合資料庫
- [x] 實作自動清理過期緩存的機制（cleanup 方法）
- [x] 移除舊的記憶體緩存模組（stockDataCache.ts）

### UI 改進
- [x] 為股票詳情頁面添加載入狀態提示
- [x] 為 API 請求失敗添加友好錯誤提示（Toast 通知）
- [x] 添加「使用緩存數據」的提示（fromCache 標記）
- [x] 改進 AI 分析和趨勢預測的錯誤提示

**說明：**
資料庫緩存系統已實作完成，所有股票數據現在會儲存到資料庫，實現跨服務器重啟的持久化緩存。緩存有效期為 5 分鐘，當 API 速率限制觸發時，會嘗試返回過期緩存數據。UI 提示已改進，當 API 請求失敗時會顯示明確的錯誤訊息。由於 Yahoo Finance API 的速率限制非常嚴格，建議等待 10-15 分鐘讓 API 速率限制完全重置後再試。

## 新增需求：搜尋歷史刪除功能

- [x] 實作後端刪除單筆搜尋記錄 API（searchHistory.deleteOne）
- [x] 實作後端清空所有搜尋記錄 API（searchHistory.deleteAll）
- [x] 在搜尋歷史頁面添加單筆刪除按鈕
- [x] 在搜尋歷史頁面添加「清空所有歷史」按鈕
- [x] 實作刪除確認對話框
- [x] 實作樂觀更新（刪除後立即更新 UI）
- [x] 測試單筆刪除功能
- [x] 測試批量刪除功能

## 新增問題：搜尋一檔股票產生兩筆搜尋歷史記錄

- [x] 調查搜尋歷史記錄的觸發時機
- [x] 檢查 StockDetail 頁面的搜尋歷史記錄邏輯
- [x] 檢查是否有多個地方調用 addSearchHistory API
- [x] 找出重複記錄的根本原因
- [x] 修正搜尋歷史記錄邏輯，確保每次搜尋只產生一筆記錄
- [x] 測試修正後的功能

## 後續優化功能

### 1. 搜尋歷史統計功能
- [x] 創建後端 API 獲取最常查看的股票排行榜（searchHistory.getTopStocks）
- [x] 在搜尋歷史頁面頂部添加「熱門追蹤」區塊
- [x] 顯示前 10 名最常查看的股票及查看次數
- [x] 點擊排行榜中的股票可直接跳轉到股票詳情頁

### 2. 移除盤中自動刷新機制
- [x] 移除 StockDetail 頁面中的盤中自動刷新邏輯（每 60 秒刷新）
- [x] 移除 isLiveUpdating 狀態和相關 UI 提示
- [x] 移除 refreshIntervalRef 和相關的 useEffect
- [x] 保留手動刷新按鈕（如果有的話）

### 3. 搜尋建議優化
- [x] 創建後端 API 獲取個人化股票推薦（使用現有的 history.list API）
- [x] 基於用戶搜尋歷史分析常查看的市場和產業
- [x] 在首頁搜尋框下方添加「為您推薦」區塊
- [x] 顯示 5-8 支推薦股票（基於搜尋歷史的相關股票）
- [x] 實作推薦演算法（顯示最近查看的股票）
