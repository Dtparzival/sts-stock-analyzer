# 美股投資分析平台 - 任務清單 (v5.0 雙市場版)

## 專案目標
根據三份交付文件建立台股與美股投資分析平台,包含資料庫架構、API 整合、資料同步機制、tRPC API 介面和基礎前端介面。排除長期目標(1-2個月)的進階功能如技術指標計算、基本面分析、跨市場比較等。

---

## 階段一:資料庫架構與基礎設定 ✅

### 台股資料庫架構 (已完成)
- [x] twStocks 資料表已建立
- [x] twStockPrices 資料表已建立
- [x] twDataSyncStatus 資料表已建立
- [x] twDataSyncErrors 資料表已建立
- [x] 台股資料庫操作層 (server/db.ts) 已完成
- [x] FinMind API 整合層已完成
- [x] 台股資料同步機制已完成
- [x] 台股排程已設定 (每週日 02:00 基本資料, 每交易日 02:00 價格)

### 美股資料庫架構
- [x] 建立 usStocks 資料表
- [x] 建立 usStockPrices 資料表
- [x] 建立 usDataSyncStatus 資料表
- [x] 建立 usDataSyncErrors 資料表
- [x] 建立 stockDataCache 快取資料表
- [x] 實作美股資料庫操作層函數 (server/db_us.ts)

## 階段二:美股 API 整合與快取機制

### TwelveData API 整合
- [x] 建立 server/integrations/twelvedata.ts
- [x] 實作 getTwelveDataQuote 函數
- [x] 實作 getTwelveDataTimeSeries 函數
- [x] 實作指數退避重試機制
- [x] 實作價格轉換輔助函數

### 快取機制
- [ ] 實作 MySQL 快取層 (stockDataCache)
- [ ] 實作 Redis 快取層整合
- [ ] 實作快取檢查與更新邏輯
- [ ] 實作快取過期處理

## 階段三:統一 tRPC API 介面

### 台股 API (已完成)
- [x] twStock.search - 搜尋股票
- [x] twStock.getDetail - 股票詳情
- [x] twStock.getHistorical - 歷史價格
- [x] twStock.getLatestPrice - 最新價格
- [x] twStock.getBatchLatestPrices - 批次價格
- [x] twStock.getSyncStatus - 同步狀態
- [x] twStock.triggerSync - 手動觸發同步

### 美股 API
- [x] 實作 usStock.search - 搜尋股票
- [x] 實作 usStock.getDetail - 股票詳情 (含即時報價)
- [x] 實作 usStock.getHistorical - 歷史價格
- [x] 實作 usStock.getLatestPrice - 最新價格
- [x] 實作 usStock.getCacheStatus - 快取狀態
- [x] 實作 usStock.clearCache - 清除快取
- [x] 實作 usStock.getSyncStatus - 同步狀態
- [x] 實作 usStock.getSyncErrors - 同步錯誤
- [x] 實作 usStock.getStatistics - 統計資訊

### 通用 API
- [x] 實作錯誤查詢 API (雙市場)
- [x] 實作 API 參數驗證 (Zod Schema)
- [ ] 優化分頁查詢功能

## 階段四:工具腳本與資料驗證

### 初始化腳本
- [x] scripts/initTwStockData.mjs - 台股初始化 (已完成)
- [ ] scripts/initUsStockData.mjs - 美股初始化

### 維護腳本
- [x] scripts/syncSpecificData.mjs - 特定資料同步 (已完成)
- [x] scripts/validateData.mjs - 資料驗證 (已完成)
- [x] server/integrations/twelvedata.test.ts - 美股 API vitest 測試 (5/7 通過)
- [ ] scripts/cleanupCache.mjs - 快取清理

## 階段五:前端介面開發

### 設計與規劃
- [x] 設計整體 UI 風格與配色 (已採用漸層設計)
- [x] 規劃導航結構 (已採用公開網站風格)
- [x] 設計雙市場切換介面 (Tabs 元件)

### 基礎頁面
- [x] 首頁 (Home.tsx) - 已包含搜尋、AI 推薦、熱門股票
- [x] 股票搜尋頁面 (StockSearch.tsx) - 雙市場搜尋介面
- [x] 股票詳情頁面 (StockDetail.tsx) - 已包含 AI 分析功能
- [ ] 建立台股搜尋頁面
- [ ] 建立美股搜尋頁面
- [ ] 建立台股詳情頁面
- [ ] 建立美股詳情頁面

### 圖表與視覺化
- [ ] 整合圖表庫 (Chart.js 或 Recharts)
- [ ] 實作價格走勢圖表元件
- [ ] 實作歷史價格圖表
- [ ] 實作成交量圖表

### 管理介面
- [ ] 建立資料同步管理頁面
- [ ] 建立台股同步狀態監控
- [ ] 建立美股快取狀態監控
- [ ] 建立錯誤記錄查詢頁面

### 路由與導航
- [ ] 更新 App.tsx 路由配置
- [ ] 設定雙市場導航結構
- [ ] 實作麵包屑導航 (如需要)

## 階段六:測試與優化

### 單元測試 (Vitest)
- [ ] 撰寫台股 API 整合測試
- [ ] 撰寫美股 API 整合測試
- [ ] 撰寫資料轉換函數測試
- [ ] 撰寫 tRPC API 測試
- [ ] 撰寫快取機制測試

### 整合測試
- [ ] 測試台股資料同步流程
- [ ] 測試美股即時查詢流程
- [ ] 測試快取機制 (Redis + MySQL)
- [ ] 測試錯誤處理與重試
- [ ] 測試前端與後端整合

### 效能優化
- [ ] 資料庫查詢優化
- [ ] 索引調整與驗證
- [ ] 快取策略優化
- [ ] API 回應時間優化

---

## 已完成的台股功能 ✅

### 資料庫層
- [x] 4 個台股資料表已建立並測試
- [x] 所有索引已設定
- [x] 資料庫操作層已完成 (server/db.ts)

### API 整合層
- [x] FinMind API 整合模組 (server/integrations/finmind.ts)
- [x] 資料轉換與驗證 (server/integrations/dataTransformer.ts)
- [x] 指數退避重試機制
- [x] 錯誤處理與記錄

### 資料同步機制
- [x] 資料同步主程式 (server/jobs/syncTwStockData.ts)
- [x] 股票基本資料同步功能
- [x] 歷史價格資料同步功能 (T+1 模式)
- [x] 排程設定 (每週日 02:00 基本資料, 每交易日 02:00 價格)
- [x] 交易日判斷邏輯
- [x] 同步狀態記錄
- [x] 錯誤通知機制

### tRPC API
- [x] 7 個台股 API 端點已實作
- [x] 分頁查詢支援
- [x] 參數驗證 (Zod Schema)

### 工具腳本
- [x] 初始化腳本 (已載入 2,725 筆股票 + 1,308 筆價格)
- [x] 特定資料同步腳本
- [x] 資料驗證腳本

---

## 備註

### 實作優先順序
1. **高優先級 🔴**: 美股資料庫架構、API 整合、快取機制
2. **中優先級 🟡**: 統一 tRPC API 介面、工具腳本
3. **低優先級 🟢**: 前端介面、測試與優化

### 不包含的長期功能 (1-2個月)
- ❌ 技術指標計算
- ❌ 基本面分析
- ❌ 跨市場比較
- ❌ 投資組合分析
- ❌ 財務報表分析
- ❌ 股利資訊分析

### 資料來源
- **台股**: FinMind API (定期批次同步, T+1 模式)
- **美股**: TwelveData API (即時查詢 + 快取)


---

## 更新記錄

### 2024-12-03
- [x] 建立美股資料庫架構 (usStocks, usStockPrices, usDataSyncStatus, usDataSyncErrors, stockDataCache)
- [x] 執行資料庫遷移成功
- [x] 實作美股資料庫操作層 (server/db_us.ts) - 包含 CRUD、統計、快取等 20+ 函數
- [x] 實作 TwelveData API 整合模組 (server/integrations/twelvedata.ts)
- [x] 實作美股 tRPC API (server/routers/usStock.ts) - 包含 9 個 API 端點
- [x] 在 server/routers.ts 中註冊 usStock router
- [x] 建立美股 API vitest 測試檔案 (server/integrations/twelvedata.test.ts)
- [x] 建立股票搜尋頁面 (client/src/pages/StockSearch.tsx)
- [x] 在 App.tsx 中註冊新路由 (/search, /stock/:market/:symbol)
- [x] 重啟開發伺服器並驗證功能

### 2025-01-03 資料同步測試與擴展
- [x] 測試定期同步功能 - 成功建立並測試同步腳本,修正 API 端點問題
- [x] 擴展 S&P 500 清單 - 補充完整 501 支股票清單 (從 Wikipedia 提取)
- [x] 驗證資料同步結果 - 已建立測試報告,確認功能正常運作

### 2025-01-03 Critical 修復 (v5.0 混合同步架構)
- [x] 修復 server/_core/index.ts 未註冊美股定期同步排程的問題
- [x] 驗證排程在系統啟動時正確註冊並執行
- [x] 確認 S&P 500 與主要 ETF 的自動同步機制正常運作


---

## 階段七:短期優化 (1-2 週) 🔴

### 首次資料同步執行
- [ ] 執行完整美股資料同步 (預計 2.4 小時)
- [ ] 驗證 S&P 500 股票資料完整性
- [ ] 驗證主要 ETF 資料完整性
- [ ] 檢查資料同步錯誤記錄

### 同步狀態監控
- [ ] 建立即時同步狀態儀表板
- [ ] 實作同步進度追蹤功能
- [ ] 設定同步失敗告警機制
- [ ] 建立同步歷史記錄查詢功能

### API 使用量監控
- [ ] 實作 TwelveData API 使用量追蹤
- [ ] 建立 API 配額監控儀表板
- [ ] 設定 API 使用量告警 (接近上限時)
- [ ] 實作 API 使用統計報表

### 自動化測試建立
- [ ] 完善美股 API vitest 測試 (目前 5/7 通過)
- [ ] 新增資料同步流程測試
- [ ] 新增快取機制測試
- [ ] 新增錯誤處理測試
- [ ] 設定 CI/CD 自動測試流程

---

## 階段八:中期改善 (3-4 週) 🟡

### 快取機制優化
- [ ] 實作 MySQL 快取層 (stockDataCache)
- [ ] 整合 Redis 快取層
- [ ] 實作多層快取策略 (Redis → MySQL → API)
- [ ] 實作快取預熱機制
- [ ] 實作快取失效與更新策略
- [ ] 優化快取命中率監控

### 效能優化
- [ ] 資料庫查詢效能分析
- [ ] 新增必要的資料庫索引
- [ ] 優化批次查詢邏輯
- [ ] 實作資料分頁載入
- [ ] 優化 API 回應時間

### 資料品質改善
- [ ] 實作資料驗證規則
- [ ] 建立資料品質監控
- [ ] 實作異常資料偵測
- [ ] 建立資料修復機制

---

## 更新記錄 (續)

### 2025-01-03 新增後續優化計劃
- [ ] 新增階段七:短期優化 (1-2 週) - 包含首次資料同步、監控與自動化測試
- [ ] 新增階段八:中期改善 (3-4 週) - 包含快取機制優化與效能改善


### 2025-01-03 執行首次完整資料同步
- [ ] 檢查現有美股同步腳本與機制
- [ ] 確認 S&P 500 股票清單完整性
- [ ] 執行首次完整資料同步（預計 2.4 小時）
- [ ] 監控同步進度與 API 使用量
- [ ] 驗證同步結果與資料完整性
- [ ] 記錄同步統計資訊（成功/失敗筆數、API 呼叫次數等）


---

## 階段九:首頁優化與配色方案 v3.0 實施 🔴

### 配色方案 v3.0 實施
- [x] 依據配色方案 v3.0 更新全站主題色彩變數 (client/src/index.css)
- [x] 確保深色/淺色主題配色一致性
- [x] 驗證文字與背景對比度符合無障礙標準
- [x] 更新所有元件使用語意化色彩變數

### 首頁功能優化
- [x] 移除「為您推薦」功能區塊
- [x] 實作台美股融合顯示邏輯
- [x] 重新設計首頁佈局（台美股整合）
- [x] 優化首頁股票卡片元件
- [x] 實作市場切換標籤（台股/美股/全部）

### 響應式設計強化
- [x] 驗證手機版顯示效果（< 640px）
- [x] 驗證平板版顯示效果（640px - 1024px）
- [x] 驗證桌面版顯示效果（> 1024px）
- [x] 優化觸控操作體驗
- [x] 確保跨裝置使用者體驗一致性

### 視覺美觀性提升
- [x] 優化資訊層級與視覺層次
- [x] 改善間距與排版一致性
- [x] 優化載入狀態與骨架屏
- [x] 改善錯誤狀態顯示
- [x] 優化動畫與過渡效果



---

## 階段十:首頁搜尋功能優化與標籤修正 ✅

### 智能搜尋功能實作
- [x] 移除首頁市場切換按鈕（美股市場/台股市場）
- [x] 實作智能搜尋 API 支援台美股代號或名稱模糊比對
- [x] 實作搜尋下拉選單元件（顯示比對結果）
- [x] 優化搜尋輸入框 UI 與互動體驗
- [x] 實作搜尋結果點選導航功能

### 熱門股票標籤修正
- [x] 修正熱門股票區域市場切換標籤(全部/美股/台股)被遮蔽問題
- [x] 調整標籤 z-index 與定位
- [x] 驗證標籤在各裝置尺寸下的顯示效果
- [x] 修正熱門股票區域市場切換標籤（全部/美股/台股）被遮蔽的問題（二次修正）
- [x] 修正美股（AAPL、MSFT等）標籤錯誤顯示為「台股」的問題

### 響應式設計驗證
- [x] 驗證手機版搜尋功能顯示效果
- [x] 驗證平板版搜尋功能顯示效果
- [x] 驗證桌面版搜尋功能顯示效果
- [x] 確保配色方案 v3.0 一致性

---

## 階段十一:熱門股票區塊優化 (2025-01-03) 🔴

### 市場切換標籤修正
- [x] 修正市場切換標籤（全部/美股/台股）被點選時字體無法顯示的問題
- [x] 修正市場切換標籤被點選時按鈕呈現灰白的問題
- [x] 驗證標籤在各裝置尺寸下的顯示效果

### 手機版輪播指示器優化
- [x] 使用進度條取代多個點點指示器
- [x] 優化指示器在股票數量較多時的視覺簡潔度
- [x] 驗證手機版輪播體驗

### 市場切換記憶功能
- [x] 使用 localStorage 記住使用者最後選擇的市場
- [x] 實作頁面載入時自動恢復偏好設定
- [x] 測試跨頁面市場偏好持久性


---

## 階段十二:手機版市場切換標籤優化 (2025-01-04) 🔴

### 底部彈出選單實作
- [x] 實作底部彈出選單元件 (BottomSheet)
- [x] 設計選單項目與互動效果
- [x] 整合市場切換邏輯到彈出選單
- [x] 實作遮罩層與關閉手勢

### 響應式切換邏輯
- [x] 手機版 (< 640px) 使用底部彈出選單
- [x] 平板與桌面版 (≥ 640px) 保持原有標籤設計
- [x] 驗證切換邏輯在各裝置尺寸下的正確性

### 觸控體驗優化
- [x] 優化觸控區域大小與間距
- [x] 實作滑動關閉手勢
- [x] 優化動畫與過渡效果
- [x] 確保配色方案 v3.0 一致性

### 跨裝置測試
- [x] 測試手機版底部選單功能
- [x] 測試平板版標籤顯示
- [x] 測試桌面版標籤顯示
- [x] 驗證市場偏好記憶功能正常運作


---

## 階段十三:搜尋框手機版體驗優化與歷史記錄功能 (2025-01-04) 🔴

### 全螢幕搜尋介面實作
- [ ] 設計全螢幕搜尋介面 UI (手機版專用)
- [ ] 實作點擊搜尋框後全螢幕展開動畫
- [ ] 優化全螢幕模式下的搜尋結果顯示
- [ ] 實作關閉按鈕與返回手勢
- [ ] 確保配色方案 v3.0 一致性

### 搜尋歷史記錄功能
- [ ] 設計搜尋歷史資料結構 (localStorage)
- [ ] 實作搜尋歷史記錄儲存邏輯
- [ ] 實作最近搜尋記錄顯示 (最多 10 筆)
- [ ] 實作搜尋歷史刪除功能 (單筆/全部清除)
- [ ] 實作點擊歷史記錄快速搜尋

### 熱門搜尋建議功能
- [ ] 設計熱門搜尋資料來源 (後端統計或預設清單)
- [ ] 實作熱門搜尋建議顯示
- [ ] 實作點擊熱門搜尋快速查詢
- [ ] 優化熱門搜尋與歷史記錄的視覺層級

### 響應式設計強化
- [ ] 驗證手機版全螢幕搜尋體驗 (< 640px)
- [ ] 驗證平板版搜尋框保持原有設計 (≥ 640px)
- [ ] 驗證桌面版搜尋框保持原有設計 (≥ 1024px)
- [ ] 優化觸控操作與鍵盤互動
- [ ] 確保跨裝置使用者體驗一致性

### 效能與體驗優化
- [ ] 實作搜尋輸入防抖 (debounce) 優化
- [ ] 優化搜尋結果載入狀態顯示
- [ ] 實作搜尋結果快取機制
- [ ] 優化動畫與過渡效果流暢度


---

## 更新記錄 (2025-01-04)

### 階段十三:搜尋框手機版體驗優化與歷史記錄功能 - 已完成 ✅
- [x] 設計搜尋歷史資料結構 (localStorage)
- [x] 實作搜尋歷史記錄儲存邏輯
- [x] 實作最近搜尋記錄顯示 (最多 10 筆)
- [x] 實作搜尋歷史刪除功能 (單筆/全部清除)
- [x] 實作點擊歷史記錄快速搜尋
- [x] 實作熱門搜尋建議顯示 (預設 8 支熱門股票)
- [x] 實作點擊熱門搜尋快速查詢
- [x] 設計全螢幕搜尋介面 UI (手機版專用)
- [x] 實作點擊搜尋框後全螢幕展開動畫
- [x] 優化全螢幕模式下的搜尋結果顯示
- [x] 實作關閉按鈕與返回手勢
- [x] 確保配色方案 v3.0 一致性
- [x] 驗證手機版全螢幕搜尋體驗 (< 640px)
- [x] 驗證平板版搜尋框保持原有設計 (≥ 640px)
- [x] 驗證桌面版搜尋框保持原有設計 (≥ 1024px)
- [x] 優化觸控操作與鍵盤互動
- [x] 確保跨裝置使用者體驗一致性
- [x] 優化動畫與過渡效果流暢度


---

## 階段十四:配色方案 v3.0 全站優化與搜尋個人化 (2025-12-04) 🔴

### 配色方案 v3.0 全站實施
- [x] 引入 IBM Plex Mono 字體並套用於所有數字顯示
- [x] 實作金色點綴效果(漸層按鈕、重要指標卡片)
- [x] 實作進場動畫(fade-in、slide-up)
- [x] 優化字體層級系統(display、heading、body 等)
- [x] 優化色彩對比度(確保 WCAG AA 標準)
- [x] 統一全站視覺元素(圓角、間距、陰影)
- [x] 實作藍色系漸層效果強化視覺層次
- [x] 統一載入動畫風格(藍色系脈衝/旋轉效果)

### 響應式設計全面強化
- [ ] 驗證並優化手機版配色與佈局
- [ ] 驗證並優化平板版配色與佈局
- [ ] 驗證並優化桌面版配色與佈局
- [ ] 確保跨裝置色彩一致性
- [ ] 優化觸控區域視覺反饋
- [ ] 簡化手機版色彩層級

### 搜尋功能個人化優化
- [x] 實作使用者搜尋頻率追蹤(資料庫層)
- [x] 實作搜尋結果個人化排序演算法
- [x] 整合收藏狀態影響搜尋排序(已準備資料結構)
- [x] 整合瀏覽歷史影響搜尋排序(已準備資料結構)
- [x] 實作個人化熱門搜尋建議(基於搜尋頻率)
- [x] 優化搜尋建議演算法(頻率+時間衰減)
- [x] 測試個人化搜尋功能完整性

### 無障礙設計驗證
- [ ] 驗證所有文字與背景對比度達標
- [ ] 實作色盲友善設計(圖標+文字輔助)
- [ ] 測試鍵盤導航完整性
- [ ] 驗證螢幕閱讀器相容性


---

## 更新記錄 (2025-12-06)

### 快取機制實作完成 ✅
- [x] 建立多層快取管理器 (server/cache/cacheManager.ts)
- [x] 整合 Redis 快取層 (記憶體快取)
- [x] 整合 MySQL 快取層 (資料庫快取)
- [x] 實作快取降級機制 (Redis 不可用時自動使用 MySQL)
- [x] 實作快取清理排程 (server/jobs/cacheCleanup.ts)
- [x] 更新 usStock router 使用多層快取
- [x] 建立快取管理器單元測試 (7/7 通過)
- [x] 修正 stockDataCache 資料表 schema
- [x] 在 server/_core/index.ts 中啟動 Redis 與快取清理排程

### 快取策略
- 即時報價: 快取 1 分鐘 (Redis + MySQL)
- 歷史價格: 快取 24 小時 (Redis + MySQL)
- 股票基本資料: 快取 7 天 (Redis + MySQL)
- 快取清理: 每天凌晨 03:00 自動清理過期快取

### 測試結果
- ✅ 快取設定與取得功能正常
- ✅ 快取不存在時正確返回 null
- ✅ 快取清除功能正常
- ✅ 批次取得快取功能正常
- ✅ 批次設定快取功能正常
- ✅ TTL 設定正確
- ✅ Redis 不可用時自動降級到 MySQL


### 美股資料初始化腳本完成 ✅
- [x] 建立 scripts/initUsStockData.mjs
- [x] 實作股票基本資料同步功能
- [x] 實作歷史價格資料同步功能 (最近 30 天)
- [x] 實作進度顯示與錯誤統計
- [x] 實作使用者確認機制

### 初始化腳本功能
- 同步 S&P 500 + 主要 ETF (532 支股票)
- 預估執行時間: 2-3 小時
- API 限流控制: 每次請求間隔 8 秒
- 錯誤記錄與統計
- 使用方式: `node scripts/initUsStockData.mjs`


---

## 更新記錄 (2025-12-06 續)

### 首次美股資料同步執行中 🔄
- [x] 修改 initUsStockData.mjs 腳本移除互動式確認
- [x] 啟動美股資料初始化腳本
- [ ] 等待同步完成（預計 1-2 小時）
- [ ] 驗證同步結果與資料完整性
- [ ] 記錄同步統計資訊

### 同步執行資訊
- 執行時間：2025-12-06 22:47
- 同步範圍：532 支股票（S&P 500 + 主要 ETF）
- 預計完成：約 1-2 小時
- 日誌檔案：/tmp/us-stock-sync.log
- 執行模式：背景自動執行


---

## 更新記錄 (2025-12-06 續)

### 資料同步狀態查詢功能完成 ✅
- [x] 建立 syncStatus router (server/routers/syncStatus.ts)
- [x] 實作 getOverview API - 取得台美股同步狀態概覽
- [x] 實作 getSyncHistory API - 取得同步歷史記錄
- [x] 實作 getSyncErrors API - 取得同步錯誤記錄
- [x] 實作 getPriceCoverage API - 取得價格覆蓋率詳情
- [x] 在 routers.ts 中註冊 syncStatus router
- [x] 建立 SyncStatus 頁面 (client/src/pages/SyncStatus.tsx)
- [x] 在 App.tsx 中註冊 /sync-status 路由
- [x] 建立 syncStatus router 單元測試 (18/18 通過)

### 測試結果
- ✅ getOverview API 測試通過 (5/5)
- ✅ getSyncHistory API 測試通過 (4/4)
- ✅ getSyncErrors API 測試通過 (4/4)
- ✅ getPriceCoverage API 測試通過 (5/5)
- ✅ 所有測試執行時間: 8.86 秒

### 功能特點
- 📊 即時顯示台美股資料統計（股票總數、價格記錄數、覆蓋率等）
- 📅 顯示資料日期範圍（最早/最新資料日期）
- ⏰ 顯示最後同步時間
- 📝 查看同步歷史記錄（台股/美股分別顯示）
- ⚠️ 查看同步錯誤記錄（未解決錯誤提醒）
- 🎨 使用配色方案 v3.0 設計
- 📱 響應式設計支援各種裝置
