# 台股資料整合優化方案

## 一、現況分析

### 1.1 現有專案結構

本專案已建立完整的資料庫架構，包含以下核心資料表：

#### 用戶相關資料表
- **users**：用戶基本資料
- **watchlist**：用戶收藏的股票
- **searchHistory**：用戶的股票查詢歷史
- **userBehavior**：用戶行為數據追蹤（查看、搜尋、停留時間、點擊）

#### 投資組合相關資料表
- **portfolio**：用戶投資組合
- **portfolioHistory**：投資組合歷史記錄
- **portfolioTransactions**：投資組合交易歷史

#### 資料快取相關資料表
- **stockDataCache**：股票數據緩存表
- **twseStockList**：TWSE 股票列表緩存（**已存在，可直接使用**）
- **analysisCache**：AI 分析結果緩存
- **analysisHistory**：AI 分析歷史記錄

#### 推薦系統相關資料表
- **questionStats**：AI 投資顧問快速問題使用統計

### 1.2 現有資料來源

目前專案主要使用美股資料來源（Twelve Data API），環境變數已配置：
- `TWELVEDATA_BASE_URL`
- `TWELVEDATA_TOKEN`

### 1.3 待整合的台股資料來源

#### 資料來源一：TWSE（台灣證券交易所）開放資料
**API 基本資訊**
- 官方網站：https://www.twse.com.tw/
- 開放資料平台：https://openapi.twse.com.tw/
- 資料格式：JSON
- 更新頻率：即時（交易時間）、每日收盤後
- 授權方式：免費開放，無需 API Key

**主要資料端點**
1. **上市股票基本資料**
   - 端點：`/v1/exchangeReport/STOCK_DAY_ALL`
   - 資料內容：股票代號、名稱、收盤價、漲跌、成交量等
   - 更新頻率：每日收盤後

2. **上市股票即時報價**
   - 端點：`/v1/exchangeReport/MI_INDEX`
   - 資料內容：即時價格、漲跌幅、成交量、最高最低價
   - 更新頻率：交易時間每 5 秒

3. **上市股票歷史價格**
   - 端點：`/v1/exchangeReport/STOCK_DAY`
   - 資料內容：日期、開盤價、最高價、最低價、收盤價、成交量
   - 更新頻率：每日收盤後

4. **產業分類資訊**
   - 端點：`/v1/exchangeReport/BWIBBU_ALL`
   - 資料內容：產業別、股票代號、產業指數
   - 更新頻率：每日收盤後

#### 資料來源二：TPEx（櫃買中心）開放資料
**API 基本資訊**
- 官方網站：https://www.tpex.org.tw/
- 開放資料平台：https://www.tpex.org.tw/openapi/
- 資料格式：JSON
- 更新頻率：即時（交易時間）、每日收盤後
- 授權方式：免費開放，無需 API Key

**主要資料端點**
1. **上櫃股票基本資料**
   - 端點：`/web/stock/aftertrading/daily_trading_info/st43_result.php`
   - 資料內容：股票代號、名稱、收盤價、漲跌、成交量等
   - 更新頻率：每日收盤後

2. **上櫃股票即時報價**
   - 端點：`/web/stock/aftertrading/otc_quotes_no1430/stk_wn1430_result.php`
   - 資料內容：即時價格、漲跌幅、成交量、最高最低價
   - 更新頻率：交易時間每 5 秒

3. **上櫃股票歷史價格**
   - 端點：`/web/stock/historical/trading_info/st43_result.php`
   - 資料內容：日期、開盤價、最高價、最低價、收盤價、成交量
   - 更新頻率：每日收盤後

#### 資料來源三：FinMind API
**API 基本資訊**
- 官方網站：https://finmindtrade.com/
- API 文件：https://api.finmindtrade.com/docs
- 資料格式：JSON
- 更新頻率：每日收盤後
- 授權方式：免費版有請求限制，付費版無限制

**主要資料端點**
1. **台股財務報表**
   - 端點：`/api/v4/data?dataset=TaiwanStockFinancialStatement`
   - 資料內容：資產負債表、損益表、現金流量表
   - 更新頻率：每季財報公布後

2. **台股股利資訊**
   - 端點：`/api/v4/data?dataset=TaiwanStockDividend`
   - 資料內容：現金股利、股票股利、除息日、殖利率
   - 更新頻率：每年股東會後

3. **台股技術指標**
   - 端點：`/api/v4/data?dataset=TaiwanStockPrice`
   - 資料內容：MA、RSI、MACD、KD 等技術指標
   - 更新頻率：每日收盤後

4. **台股基本面指標**
   - 端點：`/api/v4/data?dataset=TaiwanStockPER`
   - 資料內容：本益比、股價淨值比、EPS
   - 更新頻率：每日收盤後

---

## 二、統一資料整合架構設計

### 2.1 架構概覽

```
┌─────────────────────────────────────────────────────────────┐
│                         前端應用層                            │
│  (為您推薦、我的收藏、投資組合管理、搜尋歷史、股票詳情頁)      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                       tRPC API 層                            │
│  (twStock.search, twStock.getDetail, twStock.getHistorical)  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Redis 快取層 (TTL 策略)                   │
│  - 基本資料快取 (24 小時)                                     │
│  - 即時報價快取 (1 分鐘)                                      │
│  - 歷史價格快取 (6 小時)                                      │
│  - 技術指標快取 (6 小時)                                      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    資料庫層 (MySQL/TiDB)                     │
│  - twStocks (台股基本資料)                                    │
│  - twStockPrices (台股歷史價格)                               │
│  - twStockIndicators (台股技術指標)                           │
│  - twStockFundamentals (台股基本面資料)                       │
│  - twDataSyncStatus (資料同步狀態)                            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    統一資料轉換層                             │
│  (dataTransformer.ts)                                        │
│  - 統一資料格式                                               │
│  - 資料驗證與清洗                                             │
│  - 錯誤處理與重試                                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    資料來源整合層                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  TWSE API    │  │  TPEx API    │  │ FinMind API  │      │
│  │  (上市股票)   │  │  (上櫃股票)   │  │  (財報/股利)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 資料流程說明

#### 2.2.1 查詢流程（以股票詳情頁為例）

1. **前端發起請求**
   ```typescript
   const { data } = trpc.twStock.getDetail.useQuery({ symbol: '2330' });
   ```

2. **tRPC API 層處理**
   - 檢查 Redis 快取是否存在
   - 若快取存在且未過期，直接返回快取資料
   - 若快取不存在或已過期，查詢資料庫

3. **資料庫層查詢**
   - 查詢 `twStocks` 表取得基本資料
   - 查詢 `twStockPrices` 表取得歷史價格
   - 查詢 `twStockIndicators` 表取得技術指標
   - 查詢 `twStockFundamentals` 表取得基本面資料

4. **資料不存在時的處理**
   - 呼叫資料來源整合層取得最新資料
   - 經過統一資料轉換層處理
   - 寫入資料庫
   - 寫入 Redis 快取
   - 返回前端

#### 2.2.2 資料更新流程

1. **定期更新排程**
   - 使用 Node.js `node-cron` 套件建立排程任務
   - 交易日收盤後（14:30）更新歷史價格
   - 每週日凌晨更新基本面資料
   - 交易日收盤後（15:00）更新技術指標

2. **增量更新策略**
   - 檢查 `twDataSyncStatus` 表取得最後更新時間
   - 僅更新有變動的資料（比對 `updatedAt` 欄位）
   - 更新成功後記錄同步狀態

3. **即時更新策略**
   - 交易時間內，即時報價使用短 TTL 快取（1 分鐘）
   - 快取過期後自動呼叫 TWSE/TPEx API 更新
   - 使用 Redis 分散式鎖避免重複請求

---

## 三、資料庫 Schema 設計

### 3.1 台股基本資料表（twStocks）

```typescript
export const twStocks = mysqlTable("twStocks", {
  id: int("id").autoincrement().primaryKey(),
  symbol: varchar("symbol", { length: 10 }).notNull().unique(), // 股票代號（例如：2330）
  name: text("name").notNull(), // 公司全名（例如：台灣積體電路製造股份有限公司）
  shortName: text("shortName"), // 公司簡稱（例如：台積電）
  market: mysqlEnum("market", ["上市", "上櫃", "興櫃"]).notNull(), // 市場類別
  industry: varchar("industry", { length: 100 }), // 產業別
  type: mysqlEnum("type", ["股票", "ETF"]).default("股票").notNull(), // 股票類型
  listedDate: timestamp("listedDate"), // 上市日期
  isActive: boolean("isActive").default(true).notNull(), // 是否活躍（下市則為 false）
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
}, (table) => ({
  symbolIdx: index("symbol_idx").on(table.symbol),
  marketIdx: index("market_idx").on(table.market),
  industryIdx: index("industry_idx").on(table.industry),
}));
```

**設計說明**
- `symbol`：使用 `varchar(10)` 儲存股票代號，設定為 `unique` 確保唯一性
- `market`：使用 `enum` 類型區分上市、上櫃、興櫃
- `type`：使用 `enum` 類型區分股票與 ETF
- `isActive`：標記股票是否活躍，下市股票設為 `false`
- 索引設計：在 `symbol`、`market`、`industry` 欄位建立索引，加速查詢

### 3.2 台股歷史價格表（twStockPrices）

```typescript
export const twStockPrices = mysqlTable("twStockPrices", {
  id: int("id").autoincrement().primaryKey(),
  symbol: varchar("symbol", { length: 10 }).notNull(), // 股票代號
  date: timestamp("date").notNull(), // 交易日期
  open: int("open").notNull(), // 開盤價（以分為單位，例如 100.50 元存為 10050）
  high: int("high").notNull(), // 最高價
  low: int("low").notNull(), // 最低價
  close: int("close").notNull(), // 收盤價
  volume: int("volume").notNull(), // 成交量（張）
  amount: int("amount").notNull(), // 成交金額（以分為單位）
  change: int("change").notNull(), // 漲跌（以分為單位）
  changePercent: int("changePercent").notNull(), // 漲跌幅（以萬分之一為單位，例如 1.5% 存為 150）
  createdAt: timestamp("createdAt").defaultNow().notNull(),
}, (table) => ({
  symbolIdx: index("symbol_idx").on(table.symbol),
  dateIdx: index("date_idx").on(table.date),
  symbolDateIdx: index("symbol_date_idx").on(table.symbol, table.date),
}));
```

**設計說明**
- 價格欄位使用 `int` 類型儲存，以「分」為單位，避免浮點數精度問題
- `changePercent` 使用萬分之一為單位，例如 1.5% 存為 150
- 複合索引 `symbol_date_idx` 加速特定股票的歷史價格查詢

### 3.3 台股技術指標表（twStockIndicators）

```typescript
export const twStockIndicators = mysqlTable("twStockIndicators", {
  id: int("id").autoincrement().primaryKey(),
  symbol: varchar("symbol", { length: 10 }).notNull(), // 股票代號
  date: timestamp("date").notNull(), // 計算日期
  ma5: int("ma5"), // 5 日均線（以分為單位）
  ma10: int("ma10"), // 10 日均線
  ma20: int("ma20"), // 20 日均線
  ma60: int("ma60"), // 60 日均線
  rsi14: int("rsi14"), // 14 日 RSI（以萬分之一為單位，例如 70.5 存為 705000）
  macd: int("macd"), // MACD 值（以分為單位）
  macdSignal: int("macdSignal"), // MACD 信號線
  macdHistogram: int("macdHistogram"), // MACD 柱狀圖
  kValue: int("kValue"), // KD 指標 K 值（以萬分之一為單位）
  dValue: int("dValue"), // KD 指標 D 值
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
}, (table) => ({
  symbolIdx: index("symbol_idx").on(table.symbol),
  dateIdx: index("date_idx").on(table.date),
  symbolDateIdx: index("symbol_date_idx").on(table.symbol, table.date),
}));
```

**設計說明**
- 所有技術指標使用 `int` 類型儲存，避免浮點數精度問題
- RSI、KD 等百分比指標使用萬分之一為單位
- 複合索引 `symbol_date_idx` 加速特定股票的技術指標查詢

### 3.4 台股基本面資料表（twStockFundamentals）

```typescript
export const twStockFundamentals = mysqlTable("twStockFundamentals", {
  id: int("id").autoincrement().primaryKey(),
  symbol: varchar("symbol", { length: 10 }).notNull(), // 股票代號
  year: int("year").notNull(), // 年度
  quarter: int("quarter").notNull(), // 季度（1-4）
  eps: int("eps"), // 每股盈餘（以分為單位）
  pe: int("pe"), // 本益比（以萬分之一為單位）
  pb: int("pb"), // 股價淨值比（以萬分之一為單位）
  roe: int("roe"), // 股東權益報酬率（以萬分之一為單位）
  dividend: int("dividend"), // 股利（以分為單位）
  yieldRate: int("yieldRate"), // 殖利率（以萬分之一為單位）
  revenue: int("revenue"), // 營收（以千元為單位）
  netIncome: int("netIncome"), // 淨利（以千元為單位）
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
}, (table) => ({
  symbolIdx: index("symbol_idx").on(table.symbol),
  yearQuarterIdx: index("year_quarter_idx").on(table.year, table.quarter),
  symbolYearQuarterIdx: index("symbol_year_quarter_idx").on(table.symbol, table.year, table.quarter),
}));
```

**設計說明**
- 財務數據使用 `int` 類型儲存，避免浮點數精度問題
- `revenue` 和 `netIncome` 使用千元為單位，減少儲存空間
- 複合索引 `symbol_year_quarter_idx` 加速特定股票的財報查詢

### 3.5 資料同步狀態表（twDataSyncStatus）

```typescript
export const twDataSyncStatus = mysqlTable("twDataSyncStatus", {
  id: int("id").autoincrement().primaryKey(),
  dataType: varchar("dataType", { length: 50 }).notNull(), // 資料類型（stocks/prices/indicators/fundamentals）
  source: mysqlEnum("source", ["TWSE", "TPEx", "FinMind"]).notNull(), // 資料來源
  lastSyncAt: timestamp("lastSyncAt").notNull(), // 最後同步時間
  status: mysqlEnum("status", ["success", "failed", "in_progress"]).notNull(), // 同步狀態
  recordCount: int("recordCount").default(0).notNull(), // 同步記錄數
  errorMessage: text("errorMessage"), // 錯誤訊息
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
}, (table) => ({
  dataTypeIdx: index("dataType_idx").on(table.dataType),
  sourceIdx: index("source_idx").on(table.source),
  lastSyncAtIdx: index("lastSyncAt_idx").on(table.lastSyncAt),
}));
```

**設計說明**
- 記錄每個資料類型的同步狀態，便於監控和除錯
- `status` 欄位使用 `enum` 類型標記同步狀態
- `recordCount` 記錄每次同步的資料筆數，便於驗證資料完整性

---

## 四、統一資料來源整合層實作

### 4.1 TWSE API 整合模組（server/integrations/twse.ts）

```typescript
import axios from 'axios';

const TWSE_BASE_URL = 'https://openapi.twse.com.tw/v1';

/**
 * 取得上市股票基本資料
 */
export async function fetchTwseStockList() {
  const response = await axios.get(`${TWSE_BASE_URL}/exchangeReport/STOCK_DAY_ALL`);
  return response.data;
}

/**
 * 取得上市股票即時報價
 */
export async function fetchTwseQuote(symbol: string) {
  const response = await axios.get(`${TWSE_BASE_URL}/exchangeReport/MI_INDEX`, {
    params: { response: 'json', type: 'ALLBUT0999' }
  });
  const data = response.data.msgArray.find((item: any) => item.c === symbol);
  return data;
}

/**
 * 取得上市股票歷史價格
 */
export async function fetchTwseHistoricalPrices(symbol: string, date: string) {
  const response = await axios.get(`${TWSE_BASE_URL}/exchangeReport/STOCK_DAY`, {
    params: { stockNo: symbol, date }
  });
  return response.data;
}
```

**實作重點**
- 使用 `axios` 發送 HTTP 請求
- 統一錯誤處理與重試機制
- 支援參數化查詢

### 4.2 TPEx API 整合模組（server/integrations/tpex.ts）

```typescript
import axios from 'axios';

const TPEX_BASE_URL = 'https://www.tpex.org.tw';

/**
 * 取得上櫃股票基本資料
 */
export async function fetchTpexStockList() {
  const response = await axios.get(`${TPEX_BASE_URL}/web/stock/aftertrading/daily_trading_info/st43_result.php`, {
    params: { l: 'zh-tw', d: new Date().toISOString().split('T')[0].replace(/-/g, '/') }
  });
  return response.data;
}

/**
 * 取得上櫃股票即時報價
 */
export async function fetchTpexQuote(symbol: string) {
  const response = await axios.get(`${TPEX_BASE_URL}/web/stock/aftertrading/otc_quotes_no1430/stk_wn1430_result.php`, {
    params: { l: 'zh-tw', se: 'EW' }
  });
  const data = response.data.aaData.find((item: any) => item[0] === symbol);
  return data;
}

/**
 * 取得上櫃股票歷史價格
 */
export async function fetchTpexHistoricalPrices(symbol: string, startDate: string, endDate: string) {
  const response = await axios.get(`${TPEX_BASE_URL}/web/stock/historical/trading_info/st43_result.php`, {
    params: { l: 'zh-tw', stkno: symbol, startDate, endDate }
  });
  return response.data;
}
```

**實作重點**
- TPEx API 回傳格式與 TWSE 不同，需要特別處理
- 日期格式需轉換為 `YYYY/MM/DD` 格式
- 支援日期區間查詢

### 4.3 FinMind API 整合模組（server/integrations/finmind.ts）

```typescript
import axios from 'axios';

const FINMIND_BASE_URL = 'https://api.finmindtrade.com/api/v4';

/**
 * 取得台股財務報表
 */
export async function fetchFinancialStatement(symbol: string, startDate: string) {
  const response = await axios.get(`${FINMIND_BASE_URL}/data`, {
    params: {
      dataset: 'TaiwanStockFinancialStatement',
      data_id: symbol,
      start_date: startDate
    }
  });
  return response.data.data;
}

/**
 * 取得台股股利資訊
 */
export async function fetchDividend(symbol: string, startDate: string) {
  const response = await axios.get(`${FINMIND_BASE_URL}/data`, {
    params: {
      dataset: 'TaiwanStockDividend',
      data_id: symbol,
      start_date: startDate
    }
  });
  return response.data.data;
}

/**
 * 取得台股技術指標
 */
export async function fetchTechnicalIndicators(symbol: string, startDate: string) {
  const response = await axios.get(`${FINMIND_BASE_URL}/data`, {
    params: {
      dataset: 'TaiwanStockPrice',
      data_id: symbol,
      start_date: startDate
    }
  });
  return response.data.data;
}

/**
 * 取得台股基本面指標
 */
export async function fetchFundamentals(symbol: string, startDate: string) {
  const response = await axios.get(`${FINMIND_BASE_URL}/data`, {
    params: {
      dataset: 'TaiwanStockPER',
      data_id: symbol,
      start_date: startDate
    }
  });
  return response.data.data;
}
```

**實作重點**
- FinMind API 使用統一的 `/data` 端點，透過 `dataset` 參數區分資料類型
- 支援日期區間查詢
- 回傳格式統一為 JSON

### 4.4 統一資料轉換層（server/integrations/dataTransformer.ts）

```typescript
/**
 * 轉換 TWSE 股票基本資料格式
 */
export function transformTwseStock(rawData: any) {
  return {
    symbol: rawData.Code,
    name: rawData.Name,
    shortName: extractShortName(rawData.Name),
    market: '上市',
    industry: rawData.Industry,
    type: rawData.Type === 'ETF' ? 'ETF' : '股票',
  };
}

/**
 * 轉換 TPEx 股票基本資料格式
 */
export function transformTpexStock(rawData: any) {
  return {
    symbol: rawData[0],
    name: rawData[1],
    shortName: extractShortName(rawData[1]),
    market: '上櫃',
    industry: rawData[2],
    type: '股票',
  };
}

/**
 * 轉換歷史價格格式
 */
export function transformHistoricalPrice(rawData: any, source: 'TWSE' | 'TPEx') {
  if (source === 'TWSE') {
    return {
      date: parseDate(rawData.Date),
      open: parsePrice(rawData.Open),
      high: parsePrice(rawData.High),
      low: parsePrice(rawData.Low),
      close: parsePrice(rawData.Close),
      volume: parseInt(rawData.Volume),
      amount: parsePrice(rawData.Amount),
      change: parsePrice(rawData.Change),
      changePercent: parsePercent(rawData.ChangePercent),
    };
  } else {
    return {
      date: parseDate(rawData[0]),
      open: parsePrice(rawData[4]),
      high: parsePrice(rawData[5]),
      low: parsePrice(rawData[6]),
      close: parsePrice(rawData[2]),
      volume: parseInt(rawData[7]),
      amount: parsePrice(rawData[8]),
      change: parsePrice(rawData[3]),
      changePercent: parsePercent(rawData[9]),
    };
  }
}

/**
 * 輔助函數：解析價格（轉換為以分為單位的整數）
 */
function parsePrice(price: string | number): number {
  const numPrice = typeof price === 'string' ? parseFloat(price.replace(/,/g, '')) : price;
  return Math.round(numPrice * 100);
}

/**
 * 輔助函數：解析百分比（轉換為以萬分之一為單位的整數）
 */
function parsePercent(percent: string | number): number {
  const numPercent = typeof percent === 'string' ? parseFloat(percent.replace(/%/g, '')) : percent;
  return Math.round(numPercent * 10000);
}

/**
 * 輔助函數：解析日期
 */
function parseDate(dateStr: string): Date {
  // 處理民國年格式（例如：112/01/01）
  if (dateStr.includes('/') && dateStr.split('/')[0].length <= 3) {
    const [year, month, day] = dateStr.split('/');
    return new Date(parseInt(year) + 1911, parseInt(month) - 1, parseInt(day));
  }
  return new Date(dateStr);
}

/**
 * 輔助函數：提取公司簡稱
 */
function extractShortName(fullName: string): string {
  // 移除「股份有限公司」等後綴
  return fullName.replace(/股份有限公司|有限公司|公司/g, '').trim();
}
```

**實作重點**
- 統一不同資料來源的格式差異
- 價格轉換為「分」為單位的整數
- 百分比轉換為「萬分之一」為單位的整數
- 處理民國年與西元年的日期格式差異
- 提取公司簡稱，提升顯示友善度

---

## 五、資料快取與更新機制

### 5.1 Redis 快取策略

專案已配置 `REDIS_URL` 環境變數，可直接使用 Redis 快取機制。

#### 快取鍵設計
```typescript
// 股票基本資料快取鍵
const STOCK_INFO_KEY = (symbol: string) => `tw:stock:info:${symbol}`;

// 即時報價快取鍵
const STOCK_QUOTE_KEY = (symbol: string) => `tw:stock:quote:${symbol}`;

// 歷史價格快取鍵
const STOCK_PRICES_KEY = (symbol: string, startDate: string, endDate: string) => 
  `tw:stock:prices:${symbol}:${startDate}:${endDate}`;

// 技術指標快取鍵
const STOCK_INDICATORS_KEY = (symbol: string, date: string) => 
  `tw:stock:indicators:${symbol}:${date}`;
```

#### TTL 策略
- **股票基本資料**：TTL = 24 小時（基本資料變動頻率低）
- **即時報價**：TTL = 1 分鐘（交易時間需即時更新）
- **歷史價格**：TTL = 6 小時（歷史資料不變，但需定期更新最新資料）
- **技術指標**：TTL = 6 小時（技術指標計算成本高，快取時間較長）

#### 快取實作範例
```typescript
import { getRedis } from '../redis';

/**
 * 取得股票基本資料（含快取）
 */
export async function getStockInfo(symbol: string) {
  const redis = await getRedis();
  const cacheKey = STOCK_INFO_KEY(symbol);
  
  // 1. 檢查 Redis 快取
  if (redis) {
    const cached = await redis.get(cacheKey);
    if (cached) {
      return JSON.parse(cached);
    }
  }
  
  // 2. 查詢資料庫
  const db = await getDb();
  if (!db) throw new Error('Database not available');
  
  const stock = await db.select().from(twStocks).where(eq(twStocks.symbol, symbol)).limit(1);
  
  if (stock.length === 0) {
    // 3. 資料庫無資料，呼叫外部 API
    const rawData = await fetchStockFromAPI(symbol);
    const transformedData = transformTwseStock(rawData);
    
    // 4. 寫入資料庫
    await db.insert(twStocks).values(transformedData);
    
    // 5. 寫入 Redis 快取
    if (redis) {
      await redis.setex(cacheKey, 86400, JSON.stringify(transformedData)); // TTL: 24 小時
    }
    
    return transformedData;
  }
  
  // 6. 寫入 Redis 快取
  if (redis) {
    await redis.setex(cacheKey, 86400, JSON.stringify(stock[0]));
  }
  
  return stock[0];
}
```

### 5.2 定期資料更新排程

使用 `node-cron` 套件建立定期更新排程。

#### 安裝依賴
```bash
pnpm add node-cron
pnpm add -D @types/node-cron
```

#### 排程實作（server/jobs/syncTwStockData.ts）
```typescript
import cron from 'node-cron';
import { syncTwseStockList } from '../integrations/twse';
import { syncTpexStockList } from '../integrations/tpex';
import { syncHistoricalPrices } from '../integrations/dataSync';

/**
 * 每日收盤後更新歷史價格（交易日 14:30）
 */
export function scheduleHistoricalPricesSync() {
  cron.schedule('30 14 * * 1-5', async () => {
    console.log('[Sync] Starting historical prices sync...');
    try {
      await syncHistoricalPrices();
      console.log('[Sync] Historical prices sync completed');
    } catch (error) {
      console.error('[Sync] Historical prices sync failed:', error);
    }
  }, {
    timezone: 'Asia/Taipei'
  });
}

/**
 * 每週日凌晨更新基本面資料
 */
export function scheduleFundamentalsSync() {
  cron.schedule('0 2 * * 0', async () => {
    console.log('[Sync] Starting fundamentals sync...');
    try {
      await syncFundamentals();
      console.log('[Sync] Fundamentals sync completed');
    } catch (error) {
      console.error('[Sync] Fundamentals sync failed:', error);
    }
  }, {
    timezone: 'Asia/Taipei'
  });
}

/**
 * 每日收盤後更新技術指標（交易日 15:00）
 */
export function scheduleIndicatorsSync() {
  cron.schedule('0 15 * * 1-5', async () => {
    console.log('[Sync] Starting indicators sync...');
    try {
      await syncIndicators();
      console.log('[Sync] Indicators sync completed');
    } catch (error) {
      console.error('[Sync] Indicators sync failed:', error);
    }
  }, {
    timezone: 'Asia/Taipei'
  });
}

/**
 * 啟動所有排程任務
 */
export function startAllSchedules() {
  scheduleHistoricalPricesSync();
  scheduleFundamentalsSync();
  scheduleIndicatorsSync();
  console.log('[Sync] All schedules started');
}
```

#### 在伺服器啟動時註冊排程（server/_core/index.ts）
```typescript
import { startAllSchedules } from '../jobs/syncTwStockData';

// 在伺服器啟動後註冊排程
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}/`);
  
  // 啟動資料同步排程
  startAllSchedules();
});
```

### 5.3 增量更新策略

#### 增量更新邏輯
```typescript
/**
 * 增量更新歷史價格
 */
export async function syncHistoricalPrices() {
  const db = await getDb();
  if (!db) throw new Error('Database not available');
  
  // 1. 取得最後同步時間
  const syncStatus = await db.select()
    .from(twDataSyncStatus)
    .where(eq(twDataSyncStatus.dataType, 'prices'))
    .limit(1);
  
  const lastSyncDate = syncStatus.length > 0 
    ? syncStatus[0].lastSyncAt 
    : new Date('2020-01-01'); // 預設起始日期
  
  // 2. 取得所有活躍股票
  const stocks = await db.select()
    .from(twStocks)
    .where(eq(twStocks.isActive, true));
  
  // 3. 逐一更新每支股票的歷史價格
  for (const stock of stocks) {
    try {
      const rawData = stock.market === '上市'
        ? await fetchTwseHistoricalPrices(stock.symbol, formatDate(lastSyncDate))
        : await fetchTpexHistoricalPrices(stock.symbol, formatDate(lastSyncDate), formatDate(new Date()));
      
      const transformedData = rawData.map((item: any) => ({
        symbol: stock.symbol,
        ...transformHistoricalPrice(item, stock.market === '上市' ? 'TWSE' : 'TPEx')
      }));
      
      // 4. 批次寫入資料庫
      await db.insert(twStockPrices).values(transformedData).onDuplicateKeyUpdate({
        set: { close: sql`VALUES(close)` }
      });
      
    } catch (error) {
      console.error(`[Sync] Failed to sync prices for ${stock.symbol}:`, error);
    }
  }
  
  // 5. 更新同步狀態
  await db.insert(twDataSyncStatus).values({
    dataType: 'prices',
    source: 'TWSE',
    lastSyncAt: new Date(),
    status: 'success',
    recordCount: stocks.length
  }).onDuplicateKeyUpdate({
    set: { lastSyncAt: new Date(), status: 'success' }
  });
}
```

**實作重點**
- 僅更新自最後同步時間後的資料
- 使用 `onDuplicateKeyUpdate` 避免重複插入
- 記錄同步狀態，便於監控和除錯

---

## 六、tRPC API 層實作

### 6.1 台股搜尋 API

```typescript
twStock: router({
  /**
   * 搜尋台股（支援代號、名稱模糊搜尋）
   */
  search: publicProcedure
    .input(z.object({
      keyword: z.string().min(1),
      market: z.enum(['上市', '上櫃', '全部']).optional(),
      type: z.enum(['股票', 'ETF', '全部']).optional(),
      limit: z.number().min(1).max(100).default(20),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error('Database not available');
      
      let query = db.select().from(twStocks).where(eq(twStocks.isActive, true));
      
      // 模糊搜尋股票代號或名稱
      query = query.where(
        or(
          like(twStocks.symbol, `%${input.keyword}%`),
          like(twStocks.name, `%${input.keyword}%`),
          like(twStocks.shortName, `%${input.keyword}%`)
        )
      );
      
      // 篩選市場類別
      if (input.market && input.market !== '全部') {
        query = query.where(eq(twStocks.market, input.market));
      }
      
      // 篩選股票類型
      if (input.type && input.type !== '全部') {
        query = query.where(eq(twStocks.type, input.type));
      }
      
      const results = await query.limit(input.limit);
      return results;
    }),
}),
```

### 6.2 台股詳情 API

```typescript
/**
 * 取得台股詳情（基本資料 + 即時報價 + 歷史價格 + 技術指標 + 基本面）
 */
getDetail: publicProcedure
  .input(z.object({
    symbol: z.string().min(1),
  }))
  .query(async ({ input }) => {
    // 1. 取得基本資料
    const stockInfo = await getStockInfo(input.symbol);
    
    // 2. 取得即時報價
    const quote = await getStockQuote(input.symbol);
    
    // 3. 取得最近 30 天歷史價格
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    const prices = await getHistoricalPrices(input.symbol, startDate, endDate);
    
    // 4. 取得最新技術指標
    const indicators = await getLatestIndicators(input.symbol);
    
    // 5. 取得最新基本面資料
    const fundamentals = await getLatestFundamentals(input.symbol);
    
    return {
      info: stockInfo,
      quote,
      prices,
      indicators,
      fundamentals,
    };
  }),
```

### 6.3 台股歷史價格 API

```typescript
/**
 * 取得台股歷史價格（支援日期區間查詢）
 */
getHistoricalPrices: publicProcedure
  .input(z.object({
    symbol: z.string().min(1),
    startDate: z.string(), // YYYY-MM-DD
    endDate: z.string(), // YYYY-MM-DD
    interval: z.enum(['daily', 'weekly', 'monthly']).default('daily'),
  }))
  .query(async ({ input }) => {
    const db = await getDb();
    if (!db) throw new Error('Database not available');
    
    const prices = await db.select()
      .from(twStockPrices)
      .where(
        and(
          eq(twStockPrices.symbol, input.symbol),
          gte(twStockPrices.date, new Date(input.startDate)),
          lte(twStockPrices.date, new Date(input.endDate))
        )
      )
      .orderBy(asc(twStockPrices.date));
    
    // 根據 interval 進行資料聚合
    if (input.interval === 'weekly') {
      return aggregateWeekly(prices);
    } else if (input.interval === 'monthly') {
      return aggregateMonthly(prices);
    }
    
    return prices;
  }),
```

---

## 七、前端功能頁面整合

### 7.1 「為您推薦」頁面整合

#### 修改推薦邏輯，支援台股
```typescript
// client/src/pages/Home.tsx

const { data: recommendations } = trpc.recommendations.getRecommendations.useQuery(undefined, {
  refetchInterval: 30000, // 每 30 秒刷新
});

// 顯示推薦股票（包含台股和美股）
{recommendations?.map((stock) => (
  <div key={stock.symbol} className="card">
    <div className="flex items-center justify-between">
      <div>
        <h3 className="text-heading-4">{stock.symbol}</h3>
        <p className="text-body text-secondary">{stock.name || stock.shortName}</p>
      </div>
      <div className="text-right">
        <p className="number-display-lg">${(stock.currentPrice / 100).toFixed(2)}</p>
        <p className={stock.change >= 0 ? 'text-green-600' : 'text-red-600'}>
          {stock.change >= 0 ? '+' : ''}{(stock.changePercent / 10000).toFixed(2)}%
        </p>
      </div>
    </div>
  </div>
))}
```

### 7.2 「我的收藏」頁面整合

#### 支援台股收藏
```typescript
// client/src/pages/Watchlist.tsx

const { data: watchlist } = trpc.watchlist.list.useQuery();

// 顯示收藏列表（包含台股和美股）
{watchlist?.map((item) => (
  <tr key={item.id}>
    <td>{item.symbol}</td>
    <td>{item.companyName || item.shortName}</td>
    <td className="number-display-md">${(item.currentPrice / 100).toFixed(2)}</td>
    <td className={item.change >= 0 ? 'text-green-600' : 'text-red-600'}>
      {item.change >= 0 ? '+' : ''}{(item.changePercent / 10000).toFixed(2)}%
    </td>
    <td>
      <button onClick={() => removeFromWatchlist(item.id)}>移除</button>
    </td>
  </tr>
))}
```

### 7.3 「投資組合管理」頁面整合

#### 支援台股投資組合
```typescript
// client/src/pages/Portfolio.tsx

const { data: portfolio } = trpc.portfolio.list.useQuery();

// 顯示投資組合（包含台股和美股）
{portfolio?.map((item) => (
  <tr key={item.id}>
    <td>{item.symbol}</td>
    <td>{item.companyName || item.shortName}</td>
    <td className="number-display-md">{item.shares}</td>
    <td className="number-display-md">${(item.purchasePrice / 100).toFixed(2)}</td>
    <td className="number-display-md">${(item.currentPrice / 100).toFixed(2)}</td>
    <td className={item.gainLoss >= 0 ? 'text-green-600' : 'text-red-600'}>
      ${(item.gainLoss / 100).toFixed(2)} ({(item.gainLossPercent / 10000).toFixed(2)}%)
    </td>
  </tr>
))}
```

### 7.4 「股票詳情頁」整合

#### 支援台股詳情顯示
```typescript
// client/src/pages/StockDetail.tsx

const { data: stockDetail } = trpc.twStock.getDetail.useQuery({ symbol });

// 顯示股票詳情（包含台股和美股）
<div className="container">
  <div className="card">
    <h1 className="text-heading-2">{stockDetail?.info.name}</h1>
    <p className="text-body text-secondary">{stockDetail?.info.symbol} | {stockDetail?.info.market}</p>
    
    <div className="mt-4">
      <p className="number-display-xl">${(stockDetail?.quote.close / 100).toFixed(2)}</p>
      <p className={stockDetail?.quote.change >= 0 ? 'text-green-600' : 'text-red-600'}>
        {stockDetail?.quote.change >= 0 ? '+' : ''}{(stockDetail?.quote.changePercent / 10000).toFixed(2)}%
      </p>
    </div>
  </div>
  
  {/* 歷史價格圖表 */}
  <div className="card mt-4">
    <h2 className="text-heading-3">歷史價格</h2>
    <LineChart data={stockDetail?.prices} />
  </div>
  
  {/* 技術指標 */}
  <div className="card mt-4">
    <h2 className="text-heading-3">技術指標</h2>
    <div className="grid grid-cols-2 gap-4">
      <div>
        <p className="text-body text-secondary">RSI (14)</p>
        <p className="number-display-lg">{(stockDetail?.indicators.rsi14 / 10000).toFixed(2)}</p>
      </div>
      <div>
        <p className="text-body text-secondary">MACD</p>
        <p className="number-display-lg">{(stockDetail?.indicators.macd / 100).toFixed(2)}</p>
      </div>
    </div>
  </div>
  
  {/* 基本面資料 */}
  <div className="card mt-4">
    <h2 className="text-heading-3">基本面資料</h2>
    <div className="grid grid-cols-2 gap-4">
      <div>
        <p className="text-body text-secondary">本益比 (PE)</p>
        <p className="number-display-lg">{(stockDetail?.fundamentals.pe / 10000).toFixed(2)}</p>
      </div>
      <div>
        <p className="text-body text-secondary">股價淨值比 (PB)</p>
        <p className="number-display-lg">{(stockDetail?.fundamentals.pb / 10000).toFixed(2)}</p>
      </div>
      <div>
        <p className="text-body text-secondary">殖利率</p>
        <p className="number-display-lg">{(stockDetail?.fundamentals.yieldRate / 10000).toFixed(2)}%</p>
      </div>
      <div>
        <p className="text-body text-secondary">EPS</p>
        <p className="number-display-lg">${(stockDetail?.fundamentals.eps / 100).toFixed(2)}</p>
      </div>
    </div>
  </div>
</div>
```

---

## 八、效能優化建議

### 8.1 資料預載入機制

#### 熱門股票預載入
在伺服器啟動時，預先載入熱門股票的資料到 Redis 快取，減少首次查詢的延遲。

```typescript
/**
 * 預載入熱門股票資料
 */
export async function preloadHotStocks() {
  const hotStocks = ['2330', '2317', '2454', '2881', '0050']; // 台積電、鴻海、聯發科、富邦金、0050
  
  for (const symbol of hotStocks) {
    try {
      await getStockInfo(symbol);
      await getStockQuote(symbol);
      console.log(`[Preload] Loaded ${symbol}`);
    } catch (error) {
      console.error(`[Preload] Failed to load ${symbol}:`, error);
    }
  }
}

// 在伺服器啟動後執行預載入
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}/`);
  startAllSchedules();
  preloadHotStocks();
});
```

#### 用戶收藏股票預載入
當用戶登入時，預先載入其收藏股票的資料。

```typescript
/**
 * 預載入用戶收藏股票
 */
export async function preloadUserWatchlist(userId: number) {
  const db = await getDb();
  if (!db) return;
  
  const watchlist = await db.select().from(watchlist).where(eq(watchlist.userId, userId));
  
  for (const item of watchlist) {
    try {
      await getStockQuote(item.symbol);
    } catch (error) {
      console.error(`[Preload] Failed to load ${item.symbol}:`, error);
    }
  }
}
```

### 8.2 資料庫查詢索引優化

#### 複合索引建議
```typescript
// 在 twStockPrices 表建立複合索引，加速特定股票的歷史價格查詢
index("symbol_date_idx").on(table.symbol, table.date)

// 在 twStockIndicators 表建立複合索引，加速特定股票的技術指標查詢
index("symbol_date_idx").on(table.symbol, table.date)

// 在 twStockFundamentals 表建立複合索引，加速特定股票的財報查詢
index("symbol_year_quarter_idx").on(table.symbol, table.year, table.quarter)
```

### 8.3 分頁與懶加載

#### 歷史價格分頁載入
```typescript
/**
 * 分頁查詢歷史價格
 */
getHistoricalPricesPaginated: publicProcedure
  .input(z.object({
    symbol: z.string().min(1),
    page: z.number().min(1).default(1),
    pageSize: z.number().min(1).max(100).default(30),
  }))
  .query(async ({ input }) => {
    const db = await getDb();
    if (!db) throw new Error('Database not available');
    
    const offset = (input.page - 1) * input.pageSize;
    
    const prices = await db.select()
      .from(twStockPrices)
      .where(eq(twStockPrices.symbol, input.symbol))
      .orderBy(desc(twStockPrices.date))
      .limit(input.pageSize)
      .offset(offset);
    
    const total = await db.select({ count: sql<number>`count(*)` })
      .from(twStockPrices)
      .where(eq(twStockPrices.symbol, input.symbol));
    
    return {
      data: prices,
      pagination: {
        page: input.page,
        pageSize: input.pageSize,
        total: total[0].count,
        totalPages: Math.ceil(total[0].count / input.pageSize),
      },
    };
  }),
```

### 8.4 API 回應時間監控

#### 建立 API 回應時間監控
```typescript
/**
 * API 回應時間監控中介層
 */
export const monitoringMiddleware = t.middleware(async ({ path, next }) => {
  const start = Date.now();
  const result = await next();
  const duration = Date.now() - start;
  
  console.log(`[API] ${path} - ${duration}ms`);
  
  // 若回應時間超過 1 秒，記錄警告
  if (duration > 1000) {
    console.warn(`[API] Slow query detected: ${path} - ${duration}ms`);
  }
  
  return result;
});

// 應用到所有 procedure
export const monitoredProcedure = publicProcedure.use(monitoringMiddleware);
```

---

## 九、測試與驗證

### 9.1 資料整合單元測試

```typescript
// tests/integrations/twse.test.ts

import { describe, it, expect } from 'vitest';
import { fetchTwseStockList, fetchTwseQuote } from '../../server/integrations/twse';

describe('TWSE API Integration', () => {
  it('should fetch TWSE stock list', async () => {
    const data = await fetchTwseStockList();
    expect(data).toBeDefined();
    expect(Array.isArray(data)).toBe(true);
    expect(data.length).toBeGreaterThan(0);
  });
  
  it('should fetch TWSE quote for 2330', async () => {
    const data = await fetchTwseQuote('2330');
    expect(data).toBeDefined();
    expect(data.c).toBe('2330');
  });
});
```

### 9.2 API 整合測試

```typescript
// tests/api/twStock.test.ts

import { describe, it, expect } from 'vitest';
import { appRouter } from '../../server/routers';
import { createContext } from '../../server/_core/context';

describe('twStock API', () => {
  it('should search stocks by keyword', async () => {
    const ctx = await createContext({ req: {} as any, res: {} as any });
    const caller = appRouter.createCaller(ctx);
    
    const result = await caller.twStock.search({ keyword: '台積電' });
    expect(result).toBeDefined();
    expect(result.length).toBeGreaterThan(0);
    expect(result[0].symbol).toBe('2330');
  });
  
  it('should get stock detail for 2330', async () => {
    const ctx = await createContext({ req: {} as any, res: {} as any });
    const caller = appRouter.createCaller(ctx);
    
    const result = await caller.twStock.getDetail({ symbol: '2330' });
    expect(result).toBeDefined();
    expect(result.info.symbol).toBe('2330');
    expect(result.quote).toBeDefined();
    expect(result.prices).toBeDefined();
  });
});
```

---

## 十、總結與建議

### 10.1 優化成果預期

透過本優化方案，預期達成以下目標：

1. **統一資料來源**：整合 TWSE、TPEx、FinMind API，提供完整的台股資料
2. **高效能快取**：利用 Redis 快取機制，減少 API 請求次數，提升回應速度
3. **即時更新**：建立定期資料更新排程，確保資料即時性
4. **無延遲顯示**：透過快取與預載入機制，確保各功能頁面無延遲顯示台股資訊
5. **資料完整性**：提供基本資料、歷史價格、技術指標、基本面資料等完整資訊

### 10.2 實作優先級建議

#### 第一階段（核心功能）
1. 建立資料庫 Schema（twStocks、twStockPrices）
2. 實作 TWSE/TPEx API 整合模組
3. 實作統一資料轉換層
4. 實作 Redis 快取機制
5. 實作 tRPC API 層（search、getDetail）

#### 第二階段（進階功能）
1. 建立定期資料更新排程
2. 實作技術指標計算與儲存
3. 整合 FinMind API（財報、股利）
4. 實作資料預載入機制
5. 優化資料庫查詢索引

#### 第三階段（完善功能）
1. 實作分頁與懶加載
2. 建立 API 回應時間監控
3. 撰寫單元測試與整合測試
4. 建立維運手冊
5. 效能調校與優化

### 10.3 注意事項

1. **API 請求限制**：TWSE/TPEx API 無需 API Key，但建議控制請求頻率，避免被封鎖
2. **資料格式差異**：TWSE 和 TPEx 的資料格式不同，需透過統一資料轉換層處理
3. **民國年轉換**：台股資料常使用民國年，需正確轉換為西元年
4. **價格精度**：使用整數儲存價格，避免浮點數精度問題
5. **快取失效**：交易時間內需使用短 TTL 快取，確保即時性

### 10.4 後續擴展方向

1. **即時推播**：整合 WebSocket，提供即時報價推播
2. **技術分析工具**：提供更多技術指標（布林通道、威廉指標等）
3. **基本面分析工具**：提供財報比較、產業分析等功能
4. **AI 智能推薦**：基於台股資料，提供更精準的 AI 推薦
5. **跨市場比較**：支援台股與美股的跨市場比較分析

---

## 附錄：參考資源

### A. 官方文件
- [TWSE 開放資料平台](https://openapi.twse.com.tw/)
- [TPEx 開放資料平台](https://www.tpex.org.tw/openapi/)
- [FinMind API 文件](https://api.finmindtrade.com/docs)

### B. 技術文件
- [Drizzle ORM 文件](https://orm.drizzle.team/)
- [tRPC 文件](https://trpc.io/)
- [Redis 文件](https://redis.io/docs/)
- [node-cron 文件](https://github.com/node-cron/node-cron)

### C. 相關套件
- `axios`：HTTP 請求
- `ioredis`：Redis 客戶端
- `node-cron`：排程任務
- `drizzle-orm`：資料庫 ORM
- `@trpc/server`：tRPC 伺服器
- `@trpc/react-query`：tRPC React 客戶端
