# 台股資料庫系統交付文件

**專案名稱**：台股投資分析平台 - 資料庫系統（基礎版）  
**交付日期**：2024年12月  
**版本**：v3.0  
**作者**：Manus AI

---

## 版本更新說明 (v3.0)

本版本主要更新：

1. **調整排程時間為凌晨離峰時間**
   - 股票基本資料：每週日 02:00 (維持不變)
   - 歷史價格資料：**每交易日 02:00** (原為 14:30)

2. **排程調整理由**
   - **降低系統負載**：凌晨時段為離峰時間，系統資源充足
   - **避免 API 限流**：FinMind API 在交易時段使用量大，凌晨時段較不易遇到限流
   - **資料完整性**：前一交易日的資料在凌晨時已完全結算並上傳至 FinMind
   - **統一維護時間**：所有資料同步任務統一在凌晨執行，便於監控與維護

3. **資料時效性說明**
   - 歷史價格資料為 **T+1** 模式：凌晨 02:00 同步前一交易日的收盤資料
   - 例如：週一凌晨 02:00 同步週五的收盤資料
   - 此模式確保資料完整性，適合長期投資分析與回測

---

## 一、專案概述

本專案建立了台股資料庫的核心基礎架構，專注於提供**台股基本資料**與**歷史價格資料**兩大核心功能。系統採用 **FinMind API** 作為唯一資料來源,確保資料的一致性與可靠性,並提供完整的資料同步機制、驗證工具和 tRPC API 介面。

### 專案目標

本系統聚焦於建立穩固的資料基礎,為後續的技術分析、基本面分析等進階功能預留擴展空間。具體目標包括:

1. **建立精簡的台股資料庫 Schema**,涵蓋股票基本資料與歷史價格兩大核心資料表
2. **整合 FinMind API** 作為統一資料來源,簡化資料管道並提升維護效率
3. **實作自動化資料同步機制**,確保資料的即時性與完整性
4. **提供完整的 tRPC API 介面**,支援前端應用的各種查詢需求
5. **建立資料驗證和品質檢查工具**,確保資料的準確性與可靠性

### 設計理念

相較於原始版本涵蓋技術指標、財務報表、股利資訊等多元資料,本版本採取**精簡化策略**,專注於核心資料的穩定性與可靠性。這種設計具有以下優勢:

- **降低系統複雜度**: 減少資料表數量與同步任務,提升系統穩定性
- **提升維護效率**: 統一使用 FinMind API,簡化資料來源管理
- **靈活擴展性**: 為未來整合其他資料來源或新增進階功能預留空間
- **資源優化**: 降低資料庫儲存需求與 API 呼叫成本

---

## 二、資料庫架構

### 2.1 核心資料表設計

本系統包含 **4 個核心資料表**,分為兩大類別:業務資料表與系統管理表。所有價格欄位使用 **INT** 型別儲存(以分為單位),避免浮點數精度問題,並在應用層進行格式轉換。

#### 業務資料表

##### 1. `twStocks` - 台股基本資料表

此表儲存台股的基本資訊,包含股票代號、名稱、市場類型、產業分類等靜態資料。這些資料變動頻率低,適合作為其他資料表的參照基準。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| symbol | VARCHAR(10) | 股票代號 | 唯一索引 |
| name | VARCHAR(100) | 股票名稱 | 完整公司名稱 |
| shortName | VARCHAR(50) | 股票簡稱 | 常用簡稱 |
| market | ENUM('TWSE', 'TPEx') | 市場類型 | 上市/上櫃 |
| industry | VARCHAR(50) | 產業分類 | 依證交所分類 |
| isActive | BOOLEAN | 是否活躍 | 標記下市股票 |
| listedDate | DATE | 上市日期 | 首次掛牌日期 |
| createdAt | DATETIME | 建立時間 | 自動填入 |
| updatedAt | DATETIME | 更新時間 | 自動更新 |

**索引設計**:
- 主鍵索引: `id`
- 唯一索引: `symbol`
- 一般索引: `market`, `industry`, `isActive`

**資料來源**: FinMind API - `TaiwanStockInfo` 端點

**實作狀態**: ✅ 已建立

##### 2. `twStockPrices` - 台股歷史價格表

此表儲存台股的每日交易資料,包含開高低收價格、成交量、成交金額等資訊。這是系統中資料量最大的表,需要特別注意查詢效能與儲存優化。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| symbol | VARCHAR(10) | 股票代號 | 關聯 twStocks |
| date | DATE | 交易日期 | 格式: YYYY-MM-DD |
| open | INT | 開盤價 | 以分為單位 |
| high | INT | 最高價 | 以分為單位 |
| low | INT | 最低價 | 以分為單位 |
| close | INT | 收盤價 | 以分為單位 |
| volume | BIGINT | 成交量 | 單位:股 |
| amount | BIGINT | 成交金額 | 單位:元 |
| change | INT | 漲跌 | 以分為單位 |
| changePercent | INT | 漲跌幅 | 以基點為單位(萬分之一) |
| createdAt | DATETIME | 建立時間 | 自動填入 |

**索引設計**:
- 主鍵索引: `id`
- 唯一索引: `(symbol, date)` - 確保每檔股票每日僅有一筆記錄
- 一般索引: `date` - 優化日期範圍查詢
- 一般索引: `symbol` - 優化單一股票查詢

**資料來源**: FinMind API - `TaiwanStockPrice` 端點

**價格儲存格式說明**:
- 所有價格欄位(open, high, low, close, change)以**分**為單位儲存
  - 例如: 股價 123.45 元儲存為 12345
- 漲跌幅以**基點**(萬分之一)為單位儲存
  - 例如: 漲幅 3.25% 儲存為 325
- 此設計避免浮點數精度問題,確保財務計算的準確性
- 前端顯示時需除以 100 (價格) 或 10000 (漲跌幅) 進行格式轉換

**實作狀態**: ✅ 已建立

#### 系統管理表

##### 3. `twDataSyncStatus` - 資料同步狀態表

此表記錄各類資料的同步狀態,用於監控資料更新情況與排程執行結果。系統管理員可透過此表快速掌握資料同步健康度。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| dataType | VARCHAR(50) | 資料類型 | stocks / prices |
| source | VARCHAR(50) | 資料來源 | finmind |
| lastSyncAt | DATETIME | 最後同步時間 | UTC 時區 |
| status | ENUM | 狀態 | success / partial / failed |
| recordCount | INT | 記錄數 | 本次同步筆數 |
| errorMessage | TEXT | 錯誤訊息 | 失敗時記錄 |
| createdAt | DATETIME | 建立時間 | 自動填入 |
| updatedAt | DATETIME | 更新時間 | 自動更新 |

**資料類型定義**:
- `stocks`: 台股基本資料同步
- `prices`: 台股歷史價格同步

**狀態定義**:
- `success`: 完全成功,所有資料皆同步完成
- `partial`: 部分成功,部分股票同步失敗
- `failed`: 完全失敗,同步任務中斷

**實作狀態**: ✅ 已建立

##### 4. `twDataSyncErrors` - 資料同步錯誤記錄表

此表詳細記錄同步過程中發生的錯誤,包含錯誤類型、錯誤訊息、堆疊追蹤等資訊,用於問題診斷與重試機制。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| dataType | VARCHAR(50) | 資料類型 | stocks / prices |
| symbol | VARCHAR(10) | 股票代號 | 可為空(系統級錯誤) |
| errorType | VARCHAR(50) | 錯誤類型 | API / Network / Parse |
| errorMessage | TEXT | 錯誤訊息 | 錯誤描述 |
| errorStack | TEXT | 錯誤堆疊 | 完整堆疊追蹤 |
| retryCount | INT | 重試次數 | 預設 0 |
| resolved | BOOLEAN | 是否已解決 | 預設 false |
| syncedAt | DATETIME | 同步時間 | 錯誤發生時間 |
| createdAt | DATETIME | 建立時間 | 自動填入 |

**錯誤類型定義**:
- `API`: FinMind API 回傳錯誤或限流
- `Network`: 網路連線問題
- `Parse`: 資料解析錯誤
- `Database`: 資料庫寫入錯誤
- `Validation`: 資料驗證失敗

**實作狀態**: ✅ 已建立

### 2.2 資料表關聯

```
twStocks (1) ─────< (N) twStockPrices
    │
    │ symbol
    │
    └─ 一檔股票對應多筆歷史價格記錄
```

**關聯說明**:
- `twStocks` 與 `twStockPrices` 為一對多關係
- 透過 `symbol` 欄位進行關聯
- 未使用外鍵約束以提升寫入效能,由應用層確保資料一致性

### 2.3 儲存空間估算

以台股約 2,000 檔股票、保留 5 年歷史資料為例:

| 資料表 | 單筆大小 | 記錄數 | 總容量 |
|-------|---------|--------|--------|
| twStocks | ~300 bytes | 2,000 | ~0.6 MB |
| twStockPrices | ~100 bytes | 2,000 × 250 × 5 | ~250 MB |
| twDataSyncStatus | ~200 bytes | ~100 | ~0.02 MB |
| twDataSyncErrors | ~500 bytes | ~1,000 | ~0.5 MB |
| **總計** | - | - | **~251 MB** |

**說明**:
- 每年約 250 個交易日
- 索引額外佔用約 30% 空間
- 實際容量需求約 **330 MB** (含索引)

---

## 三、資料同步機制 (更新版)

### 3.1 自動化排程 - 凌晨離峰時間

**檔案位置**: `server/jobs/syncTwStockData.ts`

本系統採用 `node-cron` 實作自動化排程,**統一在凌晨離峰時間執行**,確保資料的完整性與系統穩定性。所有排程時間皆採用**台灣時區 (GMT+8)**。

#### 排程時間表 (v3.0 更新)

| 資料類型 | 執行時間 | 頻率 | 資料時效 | 說明 |
|---------|---------|------|---------|------|
| 股票基本資料 | 每週日 02:00 | 每週 | 即時 | 更新股票清單與基本資訊 |
| 歷史價格資料 | **每交易日 02:00** | 每日 | **T+1** | 同步前一交易日收盤價格 |

#### 排程設計考量 (v3.0 更新)

**1. 股票基本資料 (每週日 02:00)**
- 股票基本資料變動頻率低,每週更新一次即可
- 選擇週日凌晨執行,避免影響交易日系統負載
- 可偵測新上市股票、下市股票、產業分類變更等

**2. 歷史價格資料 (每交易日 02:00) - 重要更新**
- **改為凌晨 02:00 執行** (原為 14:30)
- **資料時效改為 T+1 模式**：同步前一交易日的收盤資料
- **優勢**：
  - 資料完整性更高：前一交易日資料已完全結算
  - 避免 API 限流：凌晨時段 FinMind API 使用量低
  - 系統負載低：離峰時間執行，不影響白天使用
  - 統一維護時間：所有同步任務集中在凌晨執行
- **執行邏輯**：
  - 週一凌晨 02:00 → 同步週五收盤資料
  - 週二~週五凌晨 02:00 → 同步前一交易日收盤資料
  - 週六、週日不執行 (非交易日)

#### 排程實作 (v3.0 更新)

```typescript
import cron from 'node-cron';

// 股票基本資料同步 (每週日 02:00)
export function scheduleStockInfoSync() {
  cron.schedule('0 2 * * 0', async () => {
    console.log('[Scheduler] Starting stock info sync...');
    try {
      await syncStockInfo();
      console.log('[Scheduler] Stock info sync completed');
    } catch (error) {
      console.error('[Scheduler] Stock info sync failed:', error);
      await notifyOwner({
        title: '台股基本資料同步失敗',
        content: `錯誤訊息: ${error.message}`,
      });
    }
  }, {
    timezone: 'Asia/Taipei'
  });
}

// 歷史價格同步 (每交易日凌晨 02:00) - v3.0 更新
export function scheduleStockPriceSync() {
  // 週一到週五凌晨 02:00 執行
  cron.schedule('0 2 * * 1-5', async () => {
    console.log('[Scheduler] Starting stock price sync (T+1 mode)...');
    
    // 計算前一交易日日期
    const today = new Date();
    const previousTradingDay = getPreviousTradingDay(today);
    
    // 檢查前一交易日是否為交易日
    if (!isTradingDay(previousTradingDay)) {
      console.log('[Scheduler] Previous day was not a trading day, skipping price sync');
      return;
    }
    
    try {
      await syncStockPrices(previousTradingDay);
      console.log(`[Scheduler] Stock price sync completed for ${previousTradingDay.toISOString().split('T')[0]}`);
    } catch (error) {
      console.error('[Scheduler] Stock price sync failed:', error);
      await notifyOwner({
        title: '台股價格資料同步失敗',
        content: `日期: ${previousTradingDay.toISOString().split('T')[0]}\n錯誤訊息: ${error.message}`,
      });
    }
  }, {
    timezone: 'Asia/Taipei'
  });
}

// 取得前一交易日
function getPreviousTradingDay(date: Date): Date {
  const previous = new Date(date);
  previous.setDate(previous.getDate() - 1);
  
  // 如果是週六，往前推到週五
  if (previous.getDay() === 6) {
    previous.setDate(previous.getDate() - 1);
  }
  // 如果是週日，往前推到週五
  if (previous.getDay() === 0) {
    previous.setDate(previous.getDate() - 2);
  }
  
  return previous;
}

// 啟動所有排程
export function startAllSchedules() {
  scheduleStockInfoSync();
  scheduleStockPriceSync();
  console.log('[Scheduler] All schedules started (v3.0 - Off-peak hours)');
  console.log('[Scheduler] Stock info sync: Every Sunday 02:00');
  console.log('[Scheduler] Stock price sync: Every trading day 02:00 (T+1 mode)');
}
```

#### 交易日判斷

```typescript
function isTradingDay(date: Date): boolean {
  // 排除週末
  const dayOfWeek = date.getDay();
  if (dayOfWeek === 0 || dayOfWeek === 6) return false;
  
  // 排除國定假日 (需維護假日清單)
  const holidays = getHolidayList(date.getFullYear());
  const dateStr = date.toISOString().split('T')[0];
  if (holidays.includes(dateStr)) return false;
  
  return true;
}

function getHolidayList(year: number): string[] {
  // 台灣國定假日清單 (需定期更新)
  // 建議整合政府開放資料 API
  return [
    `${year}-01-01`, // 元旦
    `${year}-02-10`, // 農曆春節 (範例，實際日期需查詢)
    // ... 其他假日
  ];
}
```

---

## 四、實作狀態總結

### 已完成項目

✅ **資料庫架構**
- twStocks 資料表已建立
- twStockPrices 資料表已建立
- twDataSyncStatus 資料表已建立
- twDataSyncErrors 資料表已建立
- 所有索引已設定

✅ **資料庫操作層**
- server/db.ts 已簡化，僅保留台股相關函數
- 股票基本資料查詢函數已實作
- 歷史價格查詢函數已實作
- 資料寫入函數已實作
- 統計查詢函數已實作

### 待實作項目

⏳ **API 整合層**
- [ ] 建立 server/integrations/finmind.ts
- [ ] 建立 server/integrations/dataTransformer.ts
- [ ] 實作指數退避重試機制
- [ ] 實作錯誤處理與記錄

⏳ **資料同步機制**
- [ ] 建立 server/jobs/syncTwStockData.ts
- [ ] 實作股票基本資料同步功能
- [ ] 實作歷史價格資料同步功能 (T+1 模式)
- [ ] 設定排程: 股票基本資料 (每週日凌晨 02:00)
- [ ] 設定排程: 歷史價格資料 (每交易日凌晨 02:00)
- [ ] 實作交易日判斷邏輯
- [ ] 實作同步狀態記錄
- [ ] 實作錯誤通知機制

⏳ **tRPC API 介面**
- [ ] 簡化 server/routers.ts
- [ ] 實作 twStock.search - 搜尋股票
- [ ] 實作 twStock.getDetail - 股票詳情
- [ ] 實作 twStock.getHistorical - 歷史價格
- [ ] 實作 twStock.getLatestPrice - 最新價格
- [ ] 實作 twStock.getBatchLatestPrices - 批次價格
- [ ] 實作分頁查詢 API
- [ ] 實作手動同步觸發 API

⏳ **工具腳本**
- [ ] 建立 scripts/initTwStockData.mjs - 初始化腳本
- [ ] 建立 scripts/syncSpecificData.mjs - 特定資料同步腳本
- [ ] 建立 scripts/validateData.mjs - 資料驗證腳本

⏳ **前端介面**
- [ ] 建立股票搜尋頁面
- [ ] 建立股票詳情頁面
- [ ] 建立價格走勢圖表
- [ ] 建立資料同步管理頁面

---

## 五、快速開始指南

### 環境需求

- Node.js 18+
- MySQL 8.0+
- FinMind API Token (選用，免費版有限流)

### 環境變數設定

```bash
DATABASE_URL=mysql://user:password@host:port/database
FINMIND_TOKEN=your_token_here  # 選用
```

### 資料庫初始化

資料庫 schema 已建立完成，包含以下資料表：
- twStocks
- twStockPrices
- twDataSyncStatus
- twDataSyncErrors

### 下一步實作建議

1. **優先實作 API 整合層**
   - 建立 FinMind API 整合模組
   - 實作資料轉換與驗證

2. **實作資料同步機制**
   - 建立同步任務
   - 設定凌晨離峰時間排程

3. **建立初始化腳本**
   - 載入歷史資料
   - 驗證資料完整性

4. **實作 tRPC API**
   - 提供前端查詢介面

5. **建立前端頁面**
   - 股票搜尋與詳情
   - 資料同步監控

---

## 六、參考資料

### FinMind API 文件
- 官方網站: https://finmindtrade.com/
- API 文件: https://finmind.github.io/
- TaiwanStockInfo: https://finmind.github.io/tutor/TaiwanMarket/Technical/#taiwanstockinfo
- TaiwanStockPrice: https://finmind.github.io/tutor/TaiwanMarket/Technical/#taiwanstockprice

### 技術棧
- tRPC: https://trpc.io/
- Drizzle ORM: https://orm.drizzle.team/
- node-cron: https://www.npmjs.com/package/node-cron

---

**文件版本**: v3.0  
**最後更新**: 2024年12月  
**作者**: Manus AI

**主要變更**: 調整排程時間為凌晨離峰時間，歷史價格同步改為 T+1 模式
