# 台股資料整合優化方案 - 維運手冊

## 目錄

1. [系統架構概述](#系統架構概述)
2. [資料庫 Schema](#資料庫-schema)
3. [資料來源與 API 整合](#資料來源與-api-整合)
4. [定期資料同步排程](#定期資料同步排程)
5. [資料預載入機制](#資料預載入機制)
6. [技術指標計算](#技術指標計算)
7. [前端頁面使用說明](#前端頁面使用說明)
8. [錯誤處理與除錯](#錯誤處理與除錯)
9. [效能優化建議](#效能優化建議)
10. [常見問題 FAQ](#常見問題-faq)

---

## 系統架構概述

台股資料整合優化方案採用以下技術架構：

### 後端架構
- **資料庫**: MySQL/TiDB（透過 Drizzle ORM）
- **快取層**: Redis（用於提升查詢效能）
- **API 框架**: tRPC（型別安全的 API）
- **排程任務**: node-cron（定期資料同步）

### 前端架構
- **UI 框架**: React 19
- **圖表庫**: Recharts（價格走勢圖、技術指標圖）
- **狀態管理**: TanStack Query（透過 tRPC）

### 資料來源
1. **TWSE（台灣證券交易所）**: 上市股票資料
2. **TPEx（櫃買中心）**: 上櫃股票資料
3. **FinMind**: 財報和股利資料（預留）

---

## 資料庫 Schema

### 1. twStocks - 台股基本資料表

儲存台股的基本資訊，包含股票代號、名稱、產業別等。

```sql
CREATE TABLE twStocks (
  id INT AUTO_INCREMENT PRIMARY KEY,
  symbol VARCHAR(10) NOT NULL UNIQUE,  -- 股票代號（例如：2330）
  name TEXT NOT NULL,                  -- 公司全名
  shortName TEXT,                      -- 公司簡稱
  market ENUM('上市', '上櫃') NOT NULL,
  industry VARCHAR(100),               -- 產業別
  isActive BOOLEAN DEFAULT TRUE,       -- 是否仍在交易
  createdAt TIMESTAMP DEFAULT NOW(),
  updatedAt TIMESTAMP DEFAULT NOW() ON UPDATE NOW(),
  INDEX symbol_idx (symbol),
  INDEX market_idx (market),
  INDEX industry_idx (industry)
);
```

### 2. twStockPrices - 台股歷史價格表

儲存台股的每日交易資料。

**重要**: 所有價格以**分**為單位儲存（例如 100.50 元存為 10050），避免浮點數精度問題。

```sql
CREATE TABLE twStockPrices (
  id INT AUTO_INCREMENT PRIMARY KEY,
  symbol VARCHAR(10) NOT NULL,
  date TIMESTAMP NOT NULL,
  open INT NOT NULL,                   -- 開盤價（以分為單位）
  high INT NOT NULL,                   -- 最高價
  low INT NOT NULL,                    -- 最低價
  close INT NOT NULL,                  -- 收盤價
  volume INT NOT NULL,                 -- 成交量（張）
  amount INT NOT NULL,                 -- 成交金額（以分為單位）
  change INT NOT NULL,                 -- 漲跌（以分為單位）
  changePercent INT NOT NULL,          -- 漲跌幅（以萬分之一為單位）
  createdAt TIMESTAMP DEFAULT NOW(),
  INDEX symbol_idx (symbol),
  INDEX date_idx (date),
  INDEX symbol_date_idx (symbol, date)
);
```

### 3. twStockIndicators - 台股技術指標表

儲存計算後的技術指標資料。

```sql
CREATE TABLE twStockIndicators (
  id INT AUTO_INCREMENT PRIMARY KEY,
  symbol VARCHAR(10) NOT NULL,
  date TIMESTAMP NOT NULL,
  ma5 INT,                             -- 5 日均線（以分為單位）
  ma10 INT,
  ma20 INT,
  ma60 INT,
  rsi14 INT,                           -- RSI（以萬分之一為單位）
  macd INT,                            -- MACD 值（以分為單位）
  macdSignal INT,
  macdHistogram INT,
  kValue INT,                          -- K 值（以萬分之一為單位）
  dValue INT,                          -- D 值
  createdAt TIMESTAMP DEFAULT NOW(),
  updatedAt TIMESTAMP DEFAULT NOW() ON UPDATE NOW(),
  INDEX symbol_idx (symbol),
  INDEX date_idx (date),
  INDEX symbol_date_idx (symbol, date)
);
```

### 4. twStockFundamentals - 台股基本面資料表

儲存財務報表、股利等基本面資料（預留）。

### 5. twDataSyncStatus - 資料同步狀態表

記錄每次資料同步的狀態，用於監控和除錯。

```sql
CREATE TABLE twDataSyncStatus (
  id INT AUTO_INCREMENT PRIMARY KEY,
  dataType VARCHAR(50) NOT NULL,       -- stocks/prices/indicators/fundamentals
  source ENUM('TWSE', 'TPEx', 'FinMind') NOT NULL,
  lastSyncAt TIMESTAMP NOT NULL,
  status ENUM('success', 'failed', 'in_progress') NOT NULL,
  recordCount INT DEFAULT 0,
  errorMessage TEXT,
  createdAt TIMESTAMP DEFAULT NOW(),
  updatedAt TIMESTAMP DEFAULT NOW() ON UPDATE NOW()
);
```

---

## 資料來源與 API 整合

### TWSE API（台灣證券交易所）

**模組位置**: `server/integrations/twse.ts`

#### 主要功能

1. **fetchTwseStockList()** - 取得所有上市股票列表
   - API 端點: `/v1/exchangeReport/STOCK_DAY_ALL`
   - 更新頻率: 每日收盤後
   - 回傳: 股票代號、名稱、產業別等

2. **fetchTwseHistoricalPrices(symbol, date)** - 取得歷史價格
   - API 端點: `/v1/exchangeReport/STOCK_DAY`
   - 參數: `symbol`（股票代號）、`date`（YYYYMM 格式）
   - 回傳: 月度歷史價格資料

3. **fetchTwseQuote(symbol)** - 取得即時報價
   - API 端點: `/v1/exchangeReport/MI_INDEX`
   - 更新頻率: 交易時間每 5 秒

#### 錯誤處理

所有 TWSE API 呼叫都包含以下錯誤處理機制：
- **自動重試**: 失敗時最多重試 3 次
- **指數退避**: 重試間隔為 1 秒、2 秒、4 秒
- **超時設定**: 10 秒超時

### TPEx API（櫃買中心）

**模組位置**: `server/integrations/tpex.ts`

功能與 TWSE API 類似，但針對上櫃股票。

### FinMind API

**模組位置**: `server/integrations/finmind.ts`

用於取得財報和股利資料（目前為預留功能）。

---

## 定期資料同步排程

**模組位置**: `server/scheduler/twStockSync.ts`

### 排程任務列表

| 任務名稱 | 執行時間 | 功能說明 |
|---------|---------|---------|
| 歷史價格同步 | 每日 14:30（週一至週五） | 同步當日收盤價格 |
| 技術指標同步 | 每日 15:00（週一至週五） | 計算並儲存技術指標 |
| 基本面資料同步 | 每週日 00:00 | 同步財報和股利資料 |
| 股票列表同步 | 每週一 00:00 | 更新股票列表 |

### 手動觸發同步

如需手動觸發資料同步，可使用以下方式：

```typescript
import { manualSync } from './server/scheduler/twStockSync';

// 同步股票列表
await manualSync('stocks');

// 同步歷史價格
await manualSync('prices');

// 同步技術指標
await manualSync('indicators');

// 同步基本面資料
await manualSync('fundamentals');
```

### 同步狀態監控

所有同步任務的狀態都會記錄在 `twDataSyncStatus` 資料表中，可透過以下 SQL 查詢：

```sql
-- 查詢最近的同步記錄
SELECT * FROM twDataSyncStatus 
ORDER BY lastSyncAt DESC 
LIMIT 10;

-- 查詢失敗的同步記錄
SELECT * FROM twDataSyncStatus 
WHERE status = 'failed' 
ORDER BY lastSyncAt DESC;
```

---

## 資料預載入機制

**模組位置**: `server/scheduler/dataPreload.ts`

### 使用方式

#### 1. 正常預載入（跳過已有資料）

```bash
pnpm preload:tw-stock
```

#### 2. 強制重新載入

```bash
pnpm preload:tw-stock:force
```

#### 3. 輕量級預載入（僅股票列表和 Redis 快取）

```bash
pnpm preload:tw-stock:light
```

### 預載入流程

1. **檢查資料庫狀態** - 確認是否已有資料
2. **載入股票列表** - 從 TWSE 和 TPEx 載入所有股票
3. **載入歷史價格** - 載入最近一年的價格資料
4. **計算技術指標** - 批次計算並儲存技術指標
5. **Redis 快取預熱** - 將熱門股票資料預載入 Redis

### 預載入時間估算

- **正常預載入**: 約 15-30 分鐘（取決於網路速度）
- **輕量級預載入**: 約 2-5 分鐘

---

## 技術指標計算

**模組位置**: `server/integrations/technicalIndicators.ts`

### 支援的技術指標

#### 1. MA（移動平均線）

- **MA5**: 5 日均線
- **MA10**: 10 日均線
- **MA20**: 20 日均線
- **MA60**: 60 日均線

**計算方式**: 簡單移動平均（SMA）

```typescript
MA(n) = (P1 + P2 + ... + Pn) / n
```

#### 2. RSI（相對強弱指標）

- **RSI14**: 14 日 RSI

**計算方式**:

```typescript
RS = 平均漲幅 / 平均跌幅
RSI = 100 - (100 / (1 + RS))
```

**數值範圍**: 0-100
- RSI > 70: 超買
- RSI < 30: 超賣

#### 3. MACD（指數平滑異同移動平均線）

- **MACD 線**: 快速 EMA(12) - 慢速 EMA(26)
- **信號線**: MACD 的 EMA(9)
- **柱狀圖**: MACD 線 - 信號線

#### 4. KD（隨機指標）

- **K 值**: RSV 的平滑值
- **D 值**: K 值的平滑值

**數值範圍**: 0-100
- K > 80, D > 80: 超買
- K < 20, D < 20: 超賣

### 使用範例

```typescript
import { calculateAllIndicators } from './server/integrations/technicalIndicators';

const priceData = [
  { date: new Date('2024-01-01'), open: 10000, high: 10500, low: 9800, close: 10200, volume: 1000 },
  // ... 更多資料
];

const indicators = calculateAllIndicators(priceData);

// indicators 包含所有技術指標
console.log(indicators[0].ma5);    // 5 日均線
console.log(indicators[0].rsi14);  // RSI 值
console.log(indicators[0].macd);   // MACD 值
```

---

## 前端頁面使用說明

### 1. 台股搜尋頁面（/tw-stocks）

**功能**:
- 搜尋台股（支援股票代號或名稱）
- 查看熱門股票（開發中）
- 查看市場概況（開發中）

**使用方式**:
1. 在搜尋框輸入股票代號（例如：2330）或名稱（例如：台積電）
2. 點擊「搜尋」按鈕
3. 點擊搜尋結果中的股票卡片，進入詳情頁面

### 2. 台股詳情頁面（/tw-stocks/:symbol）

**功能**:
- 查看股票基本資料
- 查看最新價格和漲跌幅
- 查看歷史價格走勢圖（含 MA 移動平均線）
- 查看技術指標（開發中）
- 查看基本面資料（開發中）

**使用方式**:
1. 選擇時間範圍（1M、3M、6M、1Y）
2. 切換不同頁籤查看不同資訊
3. 點擊「返回台股列表」返回搜尋頁面

### 3. 我的收藏（/watchlist）

**台股相關功能**:
- 新增台股到收藏
- 篩選台股/美股
- 查看台股即時報價

### 4. 投資組合管理（/portfolio）

**台股相關功能**:
- 新增台股交易記錄
- 台幣/美元轉換顯示
- 台股市場標籤

---

## 錯誤處理與除錯

### 常見錯誤與解決方案

#### 1. 資料同步失敗

**症狀**: `twDataSyncStatus` 表中出現 `status = 'failed'` 的記錄

**可能原因**:
- TWSE/TPEx API 暫時無法連線
- 資料庫連線失敗
- 資料格式不符預期

**解決方案**:
1. 檢查 `errorMessage` 欄位的錯誤訊息
2. 檢查網路連線狀態
3. 手動觸發同步重試：`await manualSync('prices')`

#### 2. 技術指標計算錯誤

**症狀**: `twStockIndicators` 表中缺少某些指標值

**可能原因**:
- 歷史價格資料不足（需要至少 60 天資料才能計算 MA60）
- 資料庫連線失敗

**解決方案**:
1. 確認 `twStockPrices` 表中有足夠的歷史資料
2. 手動觸發技術指標計算：`await manualSync('indicators')`

#### 3. Redis 快取失效

**症狀**: 查詢速度變慢

**可能原因**:
- Redis 連線失敗
- 快取過期

**解決方案**:
1. 檢查 Redis 連線狀態
2. 執行輕量級預載入重新預熱快取：`pnpm preload:tw-stock:light`

### 除錯工具

#### 1. 查詢同步狀態

```sql
SELECT 
  dataType,
  source,
  status,
  recordCount,
  lastSyncAt,
  errorMessage
FROM twDataSyncStatus
WHERE dataType = 'prices'
ORDER BY lastSyncAt DESC
LIMIT 5;
```

#### 2. 查詢股票資料完整性

```sql
-- 檢查某支股票的資料完整性
SELECT 
  (SELECT COUNT(*) FROM twStockPrices WHERE symbol = '2330') as price_count,
  (SELECT COUNT(*) FROM twStockIndicators WHERE symbol = '2330') as indicator_count,
  (SELECT MAX(date) FROM twStockPrices WHERE symbol = '2330') as latest_price_date,
  (SELECT MAX(date) FROM twStockIndicators WHERE symbol = '2330') as latest_indicator_date;
```

#### 3. 查詢 API 效能

前端已整合 `ApiMonitor` 組件，可即時監控 API 回應時間和錯誤率。

---

## 效能優化建議

### 1. 資料庫索引優化

所有查詢頻繁的欄位都已建立索引：
- `symbol` - 股票代號
- `date` - 日期
- `symbol + date` - 複合索引

### 2. Redis 快取策略

**快取 TTL 設定**:
- 股票基本資料: 24 小時
- 歷史價格: 6 小時
- 技術指標: 6 小時

**快取預熱**:
- 系統啟動時自動預熱前 100 支熱門股票
- 可手動執行輕量級預載入

### 3. 批次處理

- 歷史價格同步採用批次處理，避免逐筆插入
- 技術指標計算採用批次計算，提升效能

### 4. 查詢優化

- 使用日期範圍篩選，避免全表掃描
- 使用 `LIMIT` 限制回傳筆數
- 使用 Redis 快取熱門查詢

---

## 常見問題 FAQ

### Q1: 如何新增更多技術指標？

**A**: 在 `server/integrations/technicalIndicators.ts` 中新增計算函數，然後在 `calculateAllIndicators` 中整合。

### Q2: 如何調整資料同步頻率？

**A**: 修改 `server/scheduler/twStockSync.ts` 中的 cron 表達式。

### Q3: 如何查看系統運作狀態？

**A**: 
1. 查詢 `twDataSyncStatus` 表
2. 使用前端的 `ApiMonitor` 組件
3. 查看伺服器日誌

### Q4: 資料預載入需要多久？

**A**: 
- 正常預載入: 約 15-30 分鐘
- 輕量級預載入: 約 2-5 分鐘

### Q5: 如何備份台股資料？

**A**: 使用 MySQL 的 `mysqldump` 工具備份資料庫：

```bash
mysqldump -u username -p database_name twStocks twStockPrices twStockIndicators > backup.sql
```

### Q6: 如何還原備份資料？

**A**: 使用 MySQL 的 `mysql` 命令還原：

```bash
mysql -u username -p database_name < backup.sql
```

---

## 聯絡資訊

如有任何問題或建議，請聯絡開發團隊。

---

**文件版本**: 1.0  
**最後更新**: 2025-11-30  
**維護者**: 開發團隊
