# 投資分析平台資料庫系統交付文件

**專案名稱**:投資分析平台 - 資料庫系統(台股 + 美股完整版)  
**交付日期**:2024年12月  
**版本**:v5.0  
**作者**:Manus AI

---

## 版本更新說明 (v5.0)

本版本在 v4.0 基礎上進行重大優化,主要更新如下:

### 1. 美股資料同步機制優化

**從純即時查詢升級為混合同步策略**

v4.0 版本中,所有美股股票均採用即時查詢 + 快取策略。v5.0 版本針對重要股票實施**定期批次同步**,大幅提升資料完整性與查詢效能。

**新增定期同步範圍**
- **S&P 500 成分股**:約 220 支標普500指數公司
- **主要 ETF**:32 支熱門 ETF (SPY、QQQ、VOO、VTI 等)
- **總計**:約 252 支股票採用定期同步

**定期同步排程**
- 基本資料同步:每週日凌晨 06:00 (台北時間)
- 歷史價格同步:每交易日凌晨 06:00 (台北時間)
- 同步最近 30 天歷史價格

**其餘股票維持即時查詢**
- 非 S&P 500 成分股與主要 ETF 的股票
- 繼續採用即時查詢 + 快取策略
- 確保系統靈活性與 API 成本控制

### 2. 雙市場同步架構對比

| 項目 | 台股 | 美股 (S&P 500 + ETF) | 美股 (其他) |
|-----|------|---------------------|-----------|
| **同步策略** | 定期批次同步 | 定期批次同步 | 即時查詢 + 快取 |
| **排程時間** | 凌晨 02:00 | 凌晨 06:00 | 無排程 |
| **資料時效** | T+1 (前一交易日) | 最近 30 天 | 即時 |
| **同步範圍** | 全部台股 (~2,000 支) | S&P 500 + 32 ETF (~252 支) | 按需查詢 |
| **快取機制** | 資料庫儲存 | 資料庫儲存 | Redis + MySQL 快取 |

### 3. 技術架構強化

**新增配置管理模組**
- 建立 `server/config/usStockLists.ts` 管理股票清單
- 集中管理 S&P 500 成分股與主要 ETF 清單
- 提供股票分類查詢與判斷函數

**新增定期同步排程**
- 建立 `server/jobs/syncUsStockDataScheduled.ts` 處理定期同步
- 與現有 `server/jobs/syncUsStockData.ts` (即時查詢) 並行運作
- 統一錯誤處理與通知機制

**排程啟動架構**
```
server/_core/index.ts
├── startAllSchedules()           // 台股排程 (凌晨 02:00)
├── startUsStockSchedules()       // 美股即時查詢排程
└── startUsScheduledSyncs()       // 美股定期同步排程 (凌晨 06:00)
```

---

## 一、專案概述

本專案建立了**台股與美股**資料庫的核心基礎架構,專注於提供**股票基本資料**與**歷史價格資料**兩大核心功能。系統採用雙資料源策略:台股使用 **FinMind API**,美股使用 **TwelveData API**,並針對不同股票類型實施差異化同步策略,確保資料的一致性、完整性與可靠性。

### 專案目標

本系統聚焦於建立穩固的資料基礎,為後續的技術分析、基本面分析等進階功能預留擴展空間。具體目標包括:

1. **建立精簡的雙市場資料庫 Schema**,涵蓋台股與美股的基本資料與歷史價格
2. **整合雙資料源**:台股使用 FinMind API,美股使用 TwelveData API
3. **實作差異化同步機制**:
   - 台股:定期批次同步 (全部股票)
   - 美股 (S&P 500 + ETF):定期批次同步 (重要股票)
   - 美股 (其他):即時查詢 + 快取 (靈活查詢)
4. **提供統一的 tRPC API 介面**,支援前端應用的各種查詢需求
5. **建立資料驗證和品質檢查工具**,確保資料的準確性與可靠性

### 設計理念

本版本採取**精簡化 + 雙市場 + 混合同步**策略,專注於核心資料的穩定性與可靠性。這種設計具有以下優勢:

- **降低系統複雜度**:減少資料表數量與同步任務,提升系統穩定性
- **差異化資料策略**:根據股票重要性與 API 特性選擇最佳同步方式
- **靈活擴展性**:為未來整合其他資料來源或新增進階功能預留空間
- **資源優化**:降低資料庫儲存需求與 API 呼叫成本
- **效能提升**:重要股票預先同步,提升查詢速度與使用者體驗

---

## 二、資料庫架構

### 2.1 核心資料表設計

本系統包含 **8 個核心資料表**,分為台股(4 個)與美股(4 個)兩大類別。所有價格欄位使用 **INT** 型別儲存(以分/美分為單位),避免浮點數精度問題,並在應用層進行格式轉換。

#### 台股資料表

##### 1. `twStocks` - 台股基本資料表

此表儲存台股的基本資訊,包含股票代號、名稱、市場類型、產業分類等靜態資料。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| symbol | VARCHAR(10) | 股票代號 | 唯一索引,例如:2330 |
| name | VARCHAR(100) | 股票名稱 | 完整公司名稱 |
| shortName | VARCHAR(50) | 股票簡稱 | 常用簡稱,例如:台積電 |
| market | ENUM('TWSE', 'TPEx') | 市場類型 | 上市/上櫃 |
| industry | VARCHAR(50) | 產業分類 | 依證交所分類 |
| isActive | BOOLEAN | 是否活躍 | 標記下市股票 |
| listedDate | DATE | 上市日期 | 首次掛牌日期 |
| createdAt | DATETIME | 建立時間 | 自動填入 |
| updatedAt | DATETIME | 更新時間 | 自動更新 |

**索引設計**:
- 主鍵索引:`id`
- 唯一索引:`symbol`
- 一般索引:`market`, `industry`, `isActive`

**資料來源**:FinMind API - `TaiwanStockInfo` 端點

**實作狀態**:✅ 已建立

##### 2. `twStockPrices` - 台股歷史價格表

此表儲存台股的每日交易資料,包含開高低收價格、成交量、成交金額等資訊。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| symbol | VARCHAR(10) | 股票代號 | 關聯 twStocks |
| date | DATE | 交易日期 | 格式:YYYY-MM-DD |
| open | INT | 開盤價 | 以分為單位,例如:12345 = 123.45 元 |
| high | INT | 最高價 | 以分為單位 |
| low | INT | 最低價 | 以分為單位 |
| close | INT | 收盤價 | 以分為單位 |
| volume | BIGINT | 成交量 | 單位:股 |
| amount | BIGINT | 成交金額 | 單位:元 |
| change | INT | 漲跌 | 以分為單位 |
| changePercent | INT | 漲跌幅 | 以基點為單位(萬分之一),例如:325 = 3.25% |
| createdAt | DATETIME | 建立時間 | 自動填入 |

**索引設計**:
- 主鍵索引:`id`
- 唯一索引:`(symbol, date)` - 確保每檔股票每日僅有一筆記錄
- 一般索引:`date` - 優化日期範圍查詢
- 一般索引:`symbol` - 優化單一股票查詢

**資料來源**:FinMind API - `TaiwanStockPrice` 端點

**價格儲存格式說明**:
- 所有價格欄位(open, high, low, close, change)以**分**為單位儲存
  - 例如:股價 123.45 元儲存為 12345
- 漲跌幅以**基點**(萬分之一)為單位儲存
  - 例如:漲幅 3.25% 儲存為 325
- 此設計避免浮點數精度問題,確保財務計算的準確性
- 前端顯示時需除以 100 (價格) 或 10000 (漲跌幅) 進行格式轉換

**實作狀態**:✅ 已建立

##### 3. `twDataSyncStatus` - 台股資料同步狀態表

此表記錄台股各類資料的同步狀態,用於監控資料更新情況與排程執行結果。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| dataType | VARCHAR(50) | 資料類型 | stocks / prices |
| source | VARCHAR(50) | 資料來源 | finmind |
| lastSyncAt | DATETIME | 最後同步時間 | UTC 時區 |
| status | ENUM | 狀態 | success / partial / failed |
| recordCount | INT | 記錄數 | 本次同步筆數 |
| errorMessage | TEXT | 錯誤訊息 | 失敗時記錄 |
| createdAt | DATETIME | 建立時間 | 自動填入 |
| updatedAt | DATETIME | 更新時間 | 自動更新 |

**實作狀態**:✅ 已建立

##### 4. `twDataSyncErrors` - 台股資料同步錯誤記錄表

此表詳細記錄台股同步過程中發生的錯誤,包含錯誤類型、錯誤訊息、堆疊追蹤等資訊。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| dataType | VARCHAR(50) | 資料類型 | stocks / prices |
| symbol | VARCHAR(10) | 股票代號 | 可為空(系統級錯誤) |
| errorType | VARCHAR(50) | 錯誤類型 | API / Network / Parse |
| errorMessage | TEXT | 錯誤訊息 | 錯誤描述 |
| errorStack | TEXT | 錯誤堆疊 | 完整堆疊追蹤 |
| retryCount | INT | 重試次數 | 預設 0 |
| resolved | BOOLEAN | 是否已解決 | 預設 false |
| syncedAt | DATETIME | 同步時間 | 錯誤發生時間 |
| createdAt | DATETIME | 建立時間 | 自動填入 |

**實作狀態**:✅ 已建立

#### 美股資料表

##### 5. `usStocks` - 美股基本資料表

此表儲存美股的基本資訊,包含股票代號、公司名稱、交易所等靜態資料。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| symbol | VARCHAR(20) | 股票代號 | 唯一索引,例如:AAPL |
| name | VARCHAR(200) | 公司全名 | 完整公司名稱 |
| shortName | VARCHAR(100) | 公司簡稱 | 常用簡稱 |
| exchange | VARCHAR(20) | 交易所 | 例如:NASDAQ, NYSE |
| currency | VARCHAR(10) | 幣別 | 例如:USD |
| country | VARCHAR(50) | 國家 | 例如:United States |
| sector | VARCHAR(100) | 產業類別 | 例如:Technology |
| industry | VARCHAR(100) | 產業細分 | 例如:Consumer Electronics |
| isActive | BOOLEAN | 是否活躍 | 標記下市股票 |
| createdAt | DATETIME | 建立時間 | 自動填入 |
| updatedAt | DATETIME | 更新時間 | 自動更新 |

**索引設計**:
- 主鍵索引:`id`
- 唯一索引:`symbol`
- 一般索引:`exchange`, `sector`, `isActive`

**資料來源**:TwelveData API - `quote` 端點

**實作狀態**:✅ 已建立

##### 6. `usStockPrices` - 美股歷史價格表

此表儲存美股的每日交易資料,包含開高低收價格、成交量等資訊。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| symbol | VARCHAR(20) | 股票代號 | 關聯 usStocks |
| date | DATE | 交易日期 | 格式:YYYY-MM-DD |
| open | INT | 開盤價 | 以美分為單位,例如:15025 = $150.25 |
| high | INT | 最高價 | 以美分為單位 |
| low | INT | 最低價 | 以美分為單位 |
| close | INT | 收盤價 | 以美分為單位 |
| volume | BIGINT | 成交量 | 單位:股 |
| change | INT | 漲跌 | 以美分為單位 |
| changePercent | INT | 漲跌幅 | 以基點為單位(萬分之一) |
| createdAt | DATETIME | 建立時間 | 自動填入 |

**索引設計**:
- 主鍵索引:`id`
- 唯一索引:`(symbol, date)`
- 一般索引:`date`, `symbol`

**資料來源**:TwelveData API - `time_series` 端點

**價格儲存格式說明**:
- 所有價格欄位以**美分**為單位儲存
  - 例如:股價 $150.25 儲存為 15025
- 前端顯示時需除以 100 進行格式轉換

**實作狀態**:✅ 已建立

##### 7. `usDataSyncStatus` - 美股資料同步狀態表

此表記錄美股各類資料的同步狀態,包含定期同步與快取管理。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| dataType | VARCHAR(50) | 資料類型 | stocks / prices / cache |
| source | VARCHAR(50) | 資料來源 | twelvedata |
| lastSyncAt | DATETIME | 最後同步時間 | UTC 時區 |
| status | ENUM | 狀態 | success / partial / failed |
| recordCount | INT | 記錄數 | 本次同步筆數 |
| errorMessage | TEXT | 錯誤訊息 | 失敗時記錄 |
| createdAt | DATETIME | 建立時間 | 自動填入 |
| updatedAt | DATETIME | 更新時間 | 自動更新 |

**實作狀態**:✅ 已建立

##### 8. `usDataSyncErrors` - 美股資料同步錯誤記錄表

此表詳細記錄美股同步過程中發生的錯誤。

| 欄位名稱 | 型別 | 說明 | 備註 |
|---------|------|------|------|
| id | INT (PK) | 主鍵 | 自動遞增 |
| dataType | VARCHAR(50) | 資料類型 | stocks / prices / cache |
| symbol | VARCHAR(20) | 股票代號 | 可為空(系統級錯誤) |
| errorType | VARCHAR(50) | 錯誤類型 | API / Network / Parse |
| errorMessage | TEXT | 錯誤訊息 | 錯誤描述 |
| errorStack | TEXT | 錯誤堆疊 | 完整堆疊追蹤 |
| retryCount | INT | 重試次數 | 預設 0 |
| resolved | BOOLEAN | 是否已解決 | 預設 false |
| syncedAt | DATETIME | 同步時間 | 錯誤發生時間 |
| createdAt | DATETIME | 建立時間 | 自動填入 |

**實作狀態**:✅ 已建立

### 2.2 資料表關聯

#### 台股關聯

```
twStocks (1) ─────< (N) twStockPrices
    │
    │ symbol
    │
    └─ 一檔股票對應多筆歷史價格記錄
```

#### 美股關聯

```
usStocks (1) ─────< (N) usStockPrices
    │
    │ symbol
    │
    └─ 一檔股票對應多筆歷史價格記錄
```

**關聯說明**:
- 台股與美股資料完全獨立,無跨市場關聯
- 透過 `symbol` 欄位進行關聯
- 未使用外鍵約束以提升寫入效能,由應用層確保資料一致性

### 2.3 儲存空間估算

#### 台股(2,000 檔股票,5 年歷史)

| 資料表 | 單筆大小 | 記錄數 | 總容量 |
|-------|---------|--------|--------|
| twStocks | ~300 bytes | 2,000 | ~0.6 MB |
| twStockPrices | ~100 bytes | 2,000 × 250 × 5 | ~250 MB |
| twDataSyncStatus | ~200 bytes | ~100 | ~0.02 MB |
| twDataSyncErrors | ~500 bytes | ~1,000 | ~0.5 MB |
| **小計** | - | - | **~251 MB** |

#### 美股(252 檔定期同步 + 5,000 檔快取,5 年歷史)

| 資料表 | 單筆大小 | 記錄數 | 總容量 |
|-------|---------|--------|--------|
| usStocks | ~400 bytes | 5,252 | ~2.1 MB |
| usStockPrices | ~120 bytes | 252 × 250 × 5 + 5,000 × 30 | ~195 MB |
| usDataSyncStatus | ~200 bytes | ~100 | ~0.02 MB |
| usDataSyncErrors | ~500 bytes | ~1,000 | ~0.5 MB |
| **小計** | - | - | **~197.6 MB** |

#### 總計

| 類別 | 容量 |
|-----|------|
| 台股資料 | ~251 MB |
| 美股資料 | ~197.6 MB |
| 索引(約 30%) | ~134.6 MB |
| **總計** | **~583.2 MB (約 0.6 GB)** |

**說明**:
- 每年約 250 個交易日
- 美股定期同步僅 252 支股票,大幅降低儲存需求
- 其餘美股採用快取策略,僅保留最近 30 天資料
- 實際容量需求會隨資料增長而增加

---

## 三、資料同步機制

### 3.1 台股自動化排程 - 凌晨離峰時間

**檔案位置**:`server/jobs/syncTwStockData.ts`

本系統採用 `node-cron` 實作自動化排程,**統一在凌晨離峰時間執行**,確保資料的完整性與系統穩定性。所有排程時間皆採用**台灣時區 (GMT+8)**。

#### 排程時間表

| 資料類型 | 執行時間 | 頻率 | 資料時效 | 說明 |
|---------|---------|------|---------|------|
| 股票基本資料 | 每週日 02:00 | 每週 | 即時 | 更新股票清單與基本資訊 |
| 歷史價格資料 | 每交易日 02:00 | 每日 | T+1 | 同步前一交易日收盤價格 |

#### 排程設計考量

**1. 股票基本資料 (每週日 02:00)**
- 股票基本資料變動頻率低,每週更新一次即可
- 選擇週日凌晨執行,避免影響交易日系統負載
- 可偵測新上市股票、下市股票、產業分類變更等

**2. 歷史價格資料 (每交易日 02:00)**
- **改為凌晨 02:00 執行** (原為 14:30)
- **資料時效改為 T+1 模式**:同步前一交易日的收盤資料
- **優勢**:
  - 資料完整性更高:前一交易日資料已完全結算
  - 避免 API 限流:凌晨時段 FinMind API 使用量低
  - 系統負載低:離峰時間執行,不影響白天使用
  - 統一維護時間:所有同步任務集中在凌晨執行

#### 排程實作範例

```typescript
import cron from 'node-cron';

// 股票基本資料同步 (每週日 02:00)
export function scheduleStockInfoSync() {
  cron.schedule('0 2 * * 0', async () => {
    console.log('[Scheduler] Starting TW stock info sync...');
    try {
      await syncTwStockInfo();
      console.log('[Scheduler] TW stock info sync completed');
    } catch (error) {
      console.error('[Scheduler] TW stock info sync failed:', error);
      await notifyOwner({
        title: '台股基本資料同步失敗',
        content: `錯誤訊息: ${error.message}`,
      });
    }
  }, {
    timezone: 'Asia/Taipei'
  });
}

// 歷史價格同步 (每交易日凌晨 02:00)
export function scheduleStockPriceSync() {
  cron.schedule('0 2 * * 1-5', async () => {
    console.log('[Scheduler] Starting TW stock price sync (T+1 mode)...');
    
    const today = new Date();
    const previousTradingDay = getPreviousTradingDay(today);
    
    if (!isTradingDay(previousTradingDay)) {
      console.log('[Scheduler] Previous day was not a trading day, skipping');
      return;
    }
    
    try {
      await syncTwStockPrices(previousTradingDay);
      console.log(`[Scheduler] TW price sync completed for ${previousTradingDay.toISOString().split('T')[0]}`);
    } catch (error) {
      console.error('[Scheduler] TW stock price sync failed:', error);
      await notifyOwner({
        title: '台股價格資料同步失敗',
        content: `日期: ${previousTradingDay.toISOString().split('T')[0]}\n錯誤訊息: ${error.message}`,
      });
    }
  }, {
    timezone: 'Asia/Taipei'
  });
}
```

### 3.2 美股混合同步策略

**檔案位置**:
- `server/jobs/syncUsStockDataScheduled.ts` (定期同步)
- `server/jobs/syncUsStockData.ts` (即時查詢)
- `server/config/usStockLists.ts` (股票清單配置)

美股採用**混合同步策略**,根據股票重要性選擇最佳同步方式:

#### 3.2.1 定期批次同步 (S&P 500 + 主要 ETF)

**同步範圍**
- **S&P 500 成分股**:約 220 支標普500指數公司
- **主要 ETF**:32 支熱門 ETF
  - 市場指數 ETF:SPY、VOO、IVV、QQQ、DIA、VTI、IWM
  - 科技產業 ETF:XLK、VGT、SOXX、ARKK
  - 金融產業 ETF:XLF、VFH
  - 醫療保健 ETF:XLV、VHT
  - 能源產業 ETF:XLE、VDE
  - 消費產業 ETF:XLY、XLP
  - 工業產業 ETF:XLI
  - 房地產 ETF:VNQ、XLRE
  - 債券 ETF:AGG、BND、TLT
  - 國際市場 ETF:VEA、VWO、EFA
  - 商品 ETF:GLD、SLV、USO

**排程時間表**

| 資料類型 | 執行時間 | 頻率 | 資料範圍 | 說明 |
|---------|---------|------|---------|------|
| 股票基本資料 | 每週日 06:00 | 每週 | S&P 500 + 32 ETF | 更新公司名稱、交易所等 |
| 歷史價格資料 | 每交易日 06:00 | 每日 | 最近 30 天 | 同步最近一個月價格 |

**排程設計考量**

1. **排程時間選擇 (凌晨 06:00 台北時間)**
   - 美股收盤時間:美東時間 16:00 (台北時間 05:00 或 04:00)
   - 凌晨 06:00 執行確保前一交易日資料已完全結算
   - 避開台股同步時間 (02:00),分散系統負載

2. **同步最近 30 天的理由**
   - 滿足短期技術分析需求 (MA5, MA10, MA20 等)
   - 降低 API 呼叫次數與成本
   - 減少資料庫儲存空間需求
   - 歷史資料可透過手動腳本補充

3. **API 限流控制**
   - TwelveData 免費版限制:8 requests/minute
   - 每次請求間隔 8 秒,確保不超過限流
   - 252 支股票 × 2 次請求 (基本資料 + 價格) = 約 67 分鐘

#### 3.2.2 即時查詢 + 快取策略 (其他股票)

**適用範圍**
- 非 S&P 500 成分股的美股股票
- 非主要 ETF 的其他 ETF
- 用戶自訂查詢的股票

**快取架構**

| 快取層級 | 儲存位置 | 快取時間 | 用途 |
|---------|---------|---------|------|
| L1 快取 | Redis | 30 分鐘 | AI 推薦結果 |
| L2 快取 | MySQL `stockDataCache` | 24 小時 | 公司名稱 |
| L2 快取 | MySQL `stockDataCache` | 1 小時 | 股價數據 |

**資料流程**

```
用戶請求
    ↓
檢查 Redis 快取 (30分鐘)
    ↓ (未命中)
檢查 MySQL 快取 (1-24小時)
    ↓ (未命中)
呼叫 TwelveData API
    ↓
寫入 MySQL 快取
    ↓
寫入 Redis 快取
    ↓
返回前端
```

**API 端點使用**

**1. 即時報價 (`getTwelveDataQuote`)**
- 端點:`/quote`
- 資料內容:symbol, name, close, previous_close, high, low, open, volume, 52週高低點, 幣別, 交易所
- 快取時間:1 小時

**2. 歷史數據 (`getTwelveDataTimeSeries`)**
- 端點:`/time_series`
- 資料內容:datetime, open, high, low, close, volume
- 快取時間:1 小時
- 參數:symbol, interval (1min/5min/15min/30min/1h/1day/1week/1month), outputsize

**快取實作範例**

```typescript
// 檢查快取
const cachedData = await dbCache.getCache('stock_data', symbol, 'US', range, interval);
if (cachedData && Date.now() - cachedData.timestamp < CACHE_TTL) {
  return cachedData.data;
}

// 呼叫 API
const quote = await getTwelveDataQuote(symbol);
const timeSeries = await getTwelveDataTimeSeries(symbol, interval, outputsize);

// 寫入快取
await dbCache.setCache('stock_data', symbol, 'US', range, interval, {
  quote,
  timeSeries,
  timestamp: Date.now()
}, CACHE_TTL);
```

### 3.3 錯誤處理與重試機制

#### 指數退避重試策略

兩個市場共用相同的重試邏輯:

```typescript
async function fetchWithRetry(fn: () => Promise<any>, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      const waitTime = Math.pow(2, i) * 1000; // 1s, 2s, 4s
      console.log(`Retry ${i + 1}/${maxRetries} after ${waitTime}ms`);
      await new Promise(resolve => setTimeout(resolve, waitTime));
      
      if (i === maxRetries - 1) {
        // 記錄錯誤到資料庫
        await insertDataSyncError({
          dataType: 'prices',
          symbol: symbol,
          errorType: 'API',
          errorMessage: error.message,
          errorStack: error.stack,
          retryCount: i + 1,
        });
        throw error;
      }
    }
  }
}
```

#### 錯誤分類

| 錯誤類型 | 說明 | 處理方式 |
|---------|------|---------|
| API | API 回傳錯誤或限流 | 指數退避重試 |
| Network | 網路連線問題 | 重試 3 次 |
| Parse | 資料解析錯誤 | 記錄並跳過 |
| Database | 資料庫寫入錯誤 | 記錄並通知管理員 |
| Validation | 資料驗證失敗 | 記錄並跳過 |

---

## 四、實作狀態總結

### 已完成項目

✅ **台股資料庫架構**
- twStocks 資料表已建立
- twStockPrices 資料表已建立
- twDataSyncStatus 資料表已建立
- twDataSyncErrors 資料表已建立
- 所有索引已設定

✅ **台股資料庫操作層**
- server/db.ts 已簡化,僅保留台股相關函數
- 股票基本資料查詢函數已實作
- 歷史價格查詢函數已實作
- 資料寫入函數已實作
- 統計查詢函數已實作

✅ **台股 API 整合層**
- server/integrations/finmind.ts 已完成
- server/integrations/dataTransformer.ts 已完成
- 指數退避重試機制已實作
- 錯誤處理與記錄已實作

✅ **台股資料同步機制**
- server/jobs/syncTwStockData.ts 已完成
- 股票基本資料同步功能已實作
- 歷史價格資料同步功能已實作 (T+1 模式)
- 排程設定已完成 (每週日 02:00 基本資料, 每交易日 02:00 價格)
- 交易日判斷邏輯已實作
- 同步狀態記錄已實作
- 錯誤通知機制已實作

✅ **美股資料庫架構**
- usStocks 資料表已建立
- usStockPrices 資料表已建立
- usDataSyncStatus 資料表已建立
- usDataSyncErrors 資料表已建立
- stockDataCache 快取資料表已建立
- 所有索引已設定

✅ **美股資料庫操作層**
- server/db_us.ts 已完成
- 股票基本資料查詢函數已實作
- 歷史價格查詢函數已實作
- 資料寫入函數已實作
- 統計查詢函數已實作
- 快取操作函數已實作

✅ **美股 API 整合層**
- server/integrations/twelvedata.ts 已完成
- getTwelveDataQuote 函數已實作
- getTwelveDataTimeSeries 函數已實作
- 指數退避重試機制已實作
- 價格轉換輔助函數已實作

✅ **美股即時查詢機制**
- server/jobs/syncUsStockData.ts 已完成
- TwelveData API 整合已完成
- 快取機制已實作 (Redis + MySQL)
- AI 推薦演算法已實作
- tRPC API 介面已實作

✅ **美股定期同步機制 (v5.0 新增)**
- server/config/usStockLists.ts 已建立
- S&P 500 成分股清單已編製 (約 220 支)
- 主要 ETF 清單已編製 (32 支)
- server/jobs/syncUsStockDataScheduled.ts 已完成
- 股票基本資料定期同步功能已實作
- 歷史價格定期同步功能已實作 (最近 30 天)
- 排程設定已完成 (每週日 06:00 基本資料, 每交易日 06:00 價格)
- 美股交易日判斷邏輯已實作
- 同步狀態記錄已實作
- 錯誤通知機制已實作
- 手動執行腳本已建立 (scripts/syncScheduledUsStocks.mjs)

✅ **統一 tRPC API 介面**
- server/routers.ts 已簡化
- 台股 API 已實作 (7 個端點)
- 美股 API 已實作 (9 個端點)
- 分頁查詢已支援
- 參數驗證已實作 (Zod Schema)

✅ **工具腳本**
- scripts/initTwStockData.mjs - 台股初始化腳本已完成
- scripts/initUsStockData.mjs - 美股初始化腳本已完成
- scripts/syncSpecificData.mjs - 特定資料同步腳本已完成
- scripts/validateData.mjs - 資料驗證腳本已完成
- scripts/syncScheduledUsStocks.mjs - 美股定期同步手動執行腳本已完成 (v5.0 新增)

### 待實作項目

⏳ **前端介面**
- [ ] 建立股票搜尋頁面(雙市場)
- [ ] 建立股票詳情頁面(雙市場)
- [ ] 建立價格走勢圖表
- [ ] 建立資料同步管理頁面

---

## 五、快速開始指南

### 環境需求

- Node.js 18+
- MySQL 8.0+ 或 TiDB
- Redis 6.0+ (用於美股快取)
- FinMind API Token (選用,免費版有限流)
- TwelveData API Token (必需,用於美股資料)

### 環境變數設定

```bash
# 資料庫
DATABASE_URL=mysql://user:password@host:port/database
REDIS_URL=redis://host:port

# API Token
FINMIND_TOKEN=your_finmind_token_here  # 選用
TWELVEDATA_TOKEN=your_twelvedata_token_here  # 必需
TWELVEDATA_BASE_URL=https://api.twelvedata.com
```

### 資料庫初始化

#### 台股資料庫 (已完成)

資料庫 schema 已建立完成,包含以下資料表:
- twStocks
- twStockPrices
- twDataSyncStatus
- twDataSyncErrors

#### 美股資料庫 (已完成)

資料庫 schema 已建立完成,包含以下資料表:
- usStocks
- usStockPrices
- usDataSyncStatus
- usDataSyncErrors
- stockDataCache

### 手動執行同步

#### 台股資料同步

```bash
# 初始化台股資料 (載入歷史資料)
node scripts/initTwStockData.mjs

# 同步特定股票
node scripts/syncSpecificData.mjs TW 2330

# 驗證資料完整性
node scripts/validateData.mjs
```

#### 美股資料同步

**定期同步股票 (S&P 500 + 主要 ETF)**

```bash
# 同步所有定期同步股票 (基本資料 + 價格)
node scripts/syncScheduledUsStocks.mjs all

# 僅同步基本資料
node scripts/syncScheduledUsStocks.mjs info

# 僅同步歷史價格 (最近 30 天)
node scripts/syncScheduledUsStocks.mjs prices
```

**即時查詢股票 (其他股票)**

```bash
# 初始化美股資料
node scripts/initUsStockData.mjs

# 同步特定股票
node scripts/syncSpecificData.mjs US AAPL
```

### 排程啟動

排程會在伺服器啟動時自動啟動,無需手動設定。

```bash
# 啟動開發伺服器
pnpm dev

# 啟動生產伺服器
pnpm start
```

**排程確認訊息**:
```
[Scheduler] Stock info sync scheduled: Every Sunday 02:00
[Scheduler] Stock price sync scheduled: Every trading day 02:00 (T+1 mode)
[Scheduler] All schedules started (v3.0 - Off-peak hours)
[Scheduler] US stock info sync scheduled: Every Sunday 06:00 (Taipei Time)
[Scheduler] US stock price sync scheduled: Every trading day 06:00 (Taipei Time)
[Scheduler] All US scheduled syncs started (S&P 500 + Major ETFs)
```

---

## 六、參考資料

### 台股資料來源

**FinMind API**
- 官方網站:https://finmindtrade.com/
- API 文件:https://finmind.github.io/
- TaiwanStockInfo:https://finmind.github.io/tutor/TaiwanMarket/Technical/#taiwanstockinfo
- TaiwanStockPrice:https://finmind.github.io/tutor/TaiwanMarket/Technical/#taiwanstockprice

### 美股資料來源

**TwelveData API**
- 官方網站:https://twelvedata.com/
- API 文件:https://twelvedata.com/docs
- Quote 端點:https://twelvedata.com/docs#quote
- Time Series 端點:https://twelvedata.com/docs#time-series

### 技術棧

- tRPC:https://trpc.io/
- Drizzle ORM:https://orm.drizzle.team/
- node-cron:https://www.npmjs.com/package/node-cron
- Redis:https://redis.io/

---

**文件版本**:v5.0  
**最後更新**:2024年12月3日  
**作者**:Manus AI

**主要變更**:
- 新增美股定期同步機制 (S&P 500 + 主要 ETF)
- 建立混合同步策略 (定期同步 + 即時查詢)
- 新增股票清單配置管理模組
- 新增手動執行同步腳本
- 優化資料庫儲存空間估算
- 完善排程啟動與監控機制
