# 台股資料庫系統交付文件

**專案名稱**：台股投資分析平台 - 資料庫系統完善  
**交付日期**：2024年12月  
**版本**：v1.0

---

## 一、專案概述

本專案完善了台股資料庫系統，整合 FinMind API 提供的所有台股資料，包含股票基本資料、歷史價格、技術指標、財務報表、股利資訊等，並提供完整的資料同步機制、驗證工具和 API 介面。

### 專案目標

1. 建立完整的台股資料庫 Schema
2. 整合 FinMind API 作為資料來源
3. 實作自動化資料同步機制
4. 提供完整的 tRPC API 介面
5. 建立資料驗證和品質檢查工具

---

## 二、資料庫架構

### 2.1 資料表設計

本系統包含 8 個核心資料表，所有價格和百分比欄位使用 `DECIMAL` 型別以確保精確度。

#### 1. `twStocks` - 台股基本資料表

| 欄位名稱 | 型別 | 說明 |
|---------|------|------|
| id | INT (PK) | 主鍵 |
| symbol | VARCHAR(10) | 股票代號（唯一） |
| name | VARCHAR(100) | 股票名稱 |
| shortName | VARCHAR(50) | 股票簡稱 |
| market | ENUM | 市場類型（上市/上櫃） |
| industry | VARCHAR(50) | 產業分類 |
| isActive | BOOLEAN | 是否活躍 |
| listedDate | DATE | 上市日期 |

#### 2. `twStockPrices` - 台股歷史價格表

| 欄位名稱 | 型別 | 說明 |
|---------|------|------|
| id | INT (PK) | 主鍵 |
| symbol | VARCHAR(10) | 股票代號 |
| date | DATE | 交易日期 |
| open | DECIMAL(10,2) | 開盤價 |
| high | DECIMAL(10,2) | 最高價 |
| low | DECIMAL(10,2) | 最低價 |
| close | DECIMAL(10,2) | 收盤價 |
| volume | BIGINT | 成交量 |
| amount | DECIMAL(15,2) | 成交金額 |
| change | DECIMAL(10,2) | 漲跌 |
| changePercent | DECIMAL(6,2) | 漲跌幅 |

**索引**：`(symbol, date)` 唯一索引

#### 3. `twStockIndicators` - 台股技術指標表

| 欄位名稱 | 型別 | 說明 |
|---------|------|------|
| id | INT (PK) | 主鍵 |
| symbol | VARCHAR(10) | 股票代號 |
| date | DATE | 日期 |
| ma5 | DECIMAL(10,2) | 5日均線 |
| ma10 | DECIMAL(10,2) | 10日均線 |
| ma20 | DECIMAL(10,2) | 20日均線 |
| ma60 | DECIMAL(10,2) | 60日均線 |
| rsi14 | DECIMAL(6,2) | 14日RSI |
| macd | DECIMAL(10,4) | MACD |
| macdSignal | DECIMAL(10,4) | MACD信號線 |
| macdHistogram | DECIMAL(10,4) | MACD柱狀圖 |
| kValue | DECIMAL(6,2) | KD指標K值 |
| dValue | DECIMAL(6,2) | KD指標D值 |

**索引**：`(symbol, date)` 唯一索引

#### 4. `twStockFundamentals` - 台股基本面資料表

| 欄位名稱 | 型別 | 說明 |
|---------|------|------|
| id | INT (PK) | 主鍵 |
| symbol | VARCHAR(10) | 股票代號 |
| year | INT | 年度 |
| quarter | INT | 季度 |
| eps | DECIMAL(10,2) | 每股盈餘 |
| pe | DECIMAL(10,2) | 本益比 |
| pb | DECIMAL(10,2) | 股價淨值比 |
| roe | DECIMAL(6,2) | 股東權益報酬率 |
| dividend | DECIMAL(10,2) | 股利 |
| yieldRate | DECIMAL(6,2) | 殖利率 |
| revenue | DECIMAL(15,2) | 營收 |
| netIncome | DECIMAL(15,2) | 淨利 |

**索引**：`(symbol, year, quarter)` 唯一索引

#### 5. `twStockFinancials` - 台股財務報表表

| 欄位名稱 | 型別 | 說明 |
|---------|------|------|
| id | INT (PK) | 主鍵 |
| symbol | VARCHAR(10) | 股票代號 |
| year | INT | 年度 |
| quarter | INT | 季度 |
| statementType | ENUM | 報表類型（資產負債表/損益表/現金流量表） |
| totalAssets | DECIMAL(18,2) | 總資產 |
| totalLiabilities | DECIMAL(18,2) | 總負債 |
| totalEquity | DECIMAL(18,2) | 股東權益 |
| revenue | DECIMAL(18,2) | 營業收入 |
| operatingIncome | DECIMAL(18,2) | 營業利益 |
| netIncome | DECIMAL(18,2) | 本期淨利 |
| operatingCashFlow | DECIMAL(18,2) | 營業活動現金流 |
| investingCashFlow | DECIMAL(18,2) | 投資活動現金流 |
| financingCashFlow | DECIMAL(18,2) | 融資活動現金流 |

**索引**：`(symbol, year, quarter, statementType)` 唯一索引

#### 6. `twStockDividends` - 台股股利資訊表

| 欄位名稱 | 型別 | 說明 |
|---------|------|------|
| id | INT (PK) | 主鍵 |
| symbol | VARCHAR(10) | 股票代號 |
| year | INT | 年度 |
| cashDividend | DECIMAL(10,2) | 現金股利 |
| stockDividend | DECIMAL(10,2) | 股票股利 |
| totalDividend | DECIMAL(10,2) | 總股利 |
| exDividendDate | DATE | 除息日 |
| paymentDate | DATE | 發放日 |
| yieldRate | DECIMAL(6,2) | 殖利率 |
| payoutRatio | DECIMAL(6,2) | 配息率 |

**索引**：`(symbol, year)` 唯一索引

#### 7. `twDataSyncStatus` - 資料同步狀態表

| 欄位名稱 | 型別 | 說明 |
|---------|------|------|
| id | INT (PK) | 主鍵 |
| dataType | VARCHAR(50) | 資料類型 |
| source | VARCHAR(50) | 資料來源 |
| lastSyncAt | DATETIME | 最後同步時間 |
| status | ENUM | 狀態（success/partial/failed） |
| recordCount | INT | 記錄數 |
| errorMessage | TEXT | 錯誤訊息 |

#### 8. `twDataSyncErrors` - 資料同步錯誤記錄表

| 欄位名稱 | 型別 | 說明 |
|---------|------|------|
| id | INT (PK) | 主鍵 |
| symbol | VARCHAR(10) | 股票代號 |
| errorType | VARCHAR(50) | 錯誤類型 |
| errorMessage | TEXT | 錯誤訊息 |
| errorStack | TEXT | 錯誤堆疊 |
| retryCount | INT | 重試次數 |
| syncedAt | DATETIME | 同步時間 |

---

## 三、API 整合層

### 3.1 FinMind API 整合

**檔案位置**：`server/integrations/finmind.ts`

**主要功能**：
- 統一的 API 呼叫介面
- 指數退避重試機制（最多重試 3 次）
- 錯誤處理和日誌記錄

**支援的 API**：
1. `fetchFundamentals()` - 取得基本面資料
2. `fetchFinancialStatement()` - 取得財務報表
3. `fetchDividend()` - 取得股利資訊
4. `fetchMonthlyRevenue()` - 取得月營收資料

### 3.2 資料轉換層

**檔案位置**：`server/integrations/dataTransformer.ts`

**主要功能**：
- 將 FinMind API 原始資料轉換為資料庫 Schema 格式
- 價格和百分比解析（使用 DECIMAL 型別）
- 日期解析（支援民國年與西元年）
- 資料驗證和清理

**轉換函數**：
1. `transformFundamentals()` - 基本面資料轉換
2. `transformFinancialStatement()` - 財務報表轉換
3. `transformDividend()` - 股利資訊轉換
4. `calculateTechnicalIndicators()` - 技術指標計算

---

## 四、資料同步機制

### 4.1 自動化排程

**檔案位置**：`server/jobs/syncTwStockData.ts`

**排程時間表**：

| 資料類型 | 執行時間 | 頻率 | 資料來源 |
|---------|---------|------|---------|
| 歷史價格 | 每交易日 14:30 | 每日 | TWSE + TPEx |
| 基本面資料 | 每週日 02:00 | 每週 | FinMind |
| 技術指標 | 每交易日 15:00 | 每日 | 計算 |
| 財務報表 | 每週日 03:00 | 每週 | FinMind |
| 股利資訊 | 每週日 04:00 | 每週 | FinMind |

### 4.2 同步功能

**自動化排程**：
- `scheduleHistoricalPricesSync()` - 歷史價格排程
- `scheduleFundamentalsSync()` - 基本面資料排程
- `scheduleIndicatorsSync()` - 技術指標排程
- `scheduleFinancialsSync()` - 財務報表排程
- `scheduleDividendsSync()` - 股利資訊排程
- `startAllSchedules()` - 啟動所有排程

**手動觸發**：
- `manualSyncHistoricalPrices()` - 手動同步歷史價格
- `manualSyncFundamentals()` - 手動同步基本面資料
- `manualSyncIndicators()` - 手動計算技術指標
- `manualSyncFinancials()` - 手動同步財務報表
- `manualSyncDividends()` - 手動同步股利資訊
- `manualSyncAll()` - 手動執行完整同步

### 4.3 錯誤處理

**指數退避重試機制**：
- 最多重試 3 次
- 等待時間：1秒、2秒、4秒
- 自動記錄錯誤到 `twDataSyncErrors` 表

**部分失敗處理**：
- 記錄失敗的股票代號
- 更新同步狀態為 `partial`
- 發送通知給系統管理員

---

## 五、tRPC API 介面

### 5.1 API Router

**Router 名稱**：`twStock`

**完整路徑**：`/api/trpc/twStock.*`

### 5.2 API 列表

#### 1. 搜尋台股

**路徑**：`twStock.search`

**輸入**：
```typescript
{
  keyword: string;      // 搜尋關鍵字（股票代號或名稱）
  limit?: number;       // 限制結果數量（預設 20）
}
```

**輸出**：
```typescript
Array<{
  symbol: string;
  name: string;
  shortName: string;
  market: string;
  industry: string;
}>
```

#### 2. 獲取股票詳情

**路徑**：`twStock.getDetail`

**輸入**：
```typescript
{
  symbol: string;       // 股票代號
}
```

**輸出**：
```typescript
{
  id: number;
  symbol: string;
  name: string;
  shortName: string;
  market: string;
  industry: string;
  isActive: boolean;
  listedDate: Date;
}
```

#### 3. 獲取歷史價格

**路徑**：`twStock.getHistorical`

**輸入**：
```typescript
{
  symbol: string;       // 股票代號
  startDate: string;    // 開始日期 (YYYY-MM-DD)
  endDate: string;      // 結束日期 (YYYY-MM-DD)
}
```

**輸出**：
```typescript
Array<{
  date: Date;
  open: string;         // DECIMAL 格式
  high: string;
  low: string;
  close: string;
  volume: number;
  amount: string;
  change: string;
  changePercent: string;
}>
```

#### 4. 獲取技術指標

**路徑**：`twStock.getIndicators`

**輸入**：
```typescript
{
  symbol: string;       // 股票代號
  startDate: string;    // 開始日期
  endDate: string;      // 結束日期
}
```

**輸出**：
```typescript
Array<{
  date: Date;
  ma5: string;
  ma10: string;
  ma20: string;
  ma60: string;
  rsi14: string;
  macd: string;
  macdSignal: string;
  macdHistogram: string;
  kValue: string;
  dValue: string;
}>
```

#### 5. 獲取基本面資料

**路徑**：`twStock.getFundamentals`

**輸入**：
```typescript
{
  symbol: string;       // 股票代號
  year?: number;        // 年度（可選）
  quarter?: number;     // 季度（可選）
}
```

**輸出**：
```typescript
Array<{
  year: number;
  quarter: number;
  eps: string;
  pe: string;
  pb: string;
  roe: string;
  dividend: string;
  yieldRate: string;
  revenue: string;
  netIncome: string;
}>
```

#### 6. 獲取財務報表

**路徑**：`twStock.getFinancials`

**輸入**：
```typescript
{
  symbol: string;       // 股票代號
  year?: number;        // 年度（可選）
  quarter?: number;     // 季度（可選）
}
```

**輸出**：
```typescript
Array<{
  year: number;
  quarter: number;
  statementType: string;
  totalAssets: string;
  totalLiabilities: string;
  totalEquity: string;
  revenue: string;
  operatingIncome: string;
  netIncome: string;
  operatingCashFlow: string;
  investingCashFlow: string;
  financingCashFlow: string;
}>
```

#### 7. 獲取股利資訊

**路徑**：`twStock.getDividends`

**輸入**：
```typescript
{
  symbol: string;       // 股票代號
  year?: number;        // 年度（可選）
}
```

**輸出**：
```typescript
Array<{
  year: number;
  cashDividend: string;
  stockDividend: string;
  totalDividend: string;
  exDividendDate: Date;
  paymentDate: Date;
  yieldRate: string;
  payoutRatio: string;
}>
```

### 5.3 分頁查詢 API

所有資料類型都支援分頁查詢，只需在原有 API 名稱後加上 `Paginated` 即可：

- `twStock.getHistoricalPaginated`
- `twStock.getIndicatorsPaginated`
- `twStock.getFundamentalsPaginated`
- `twStock.getFinancialsPaginated`
- `twStock.getDividendsPaginated`

**分頁輸入**：
```typescript
{
  symbol: string;
  page: number;         // 頁碼（從 1 開始）
  pageSize: number;     // 每頁筆數（1-100）
}
```

**分頁輸出**：
```typescript
{
  data: Array<...>;     // 資料陣列
  pagination: {
    page: number;
    pageSize: number;
    total: number;      // 總筆數
    totalPages: number; // 總頁數
  }
}
```

### 5.4 快取機制

所有 API 都使用 Redis 快取，TTL 策略如下：

| 資料類型 | TTL | 快取鍵前綴 |
|---------|-----|-----------|
| 股票基本資料 | 24 小時 | `tw:stock:info:` |
| 即時報價 | 1 分鐘 | `tw:stock:quote:` |
| 歷史價格 | 6 小時 | `tw:stock:prices:` |
| 技術指標 | 6 小時 | `tw:stock:indicators:` |
| 基本面資料 | 24 小時 | `tw:stock:fundamentals:` |
| 財務報表 | 24 小時 | `tw:stock:financials:` |
| 股利資訊 | 24 小時 | `tw:stock:dividends:` |

---

## 六、工具腳本

### 6.1 初始化腳本

**檔案位置**：`scripts/initTwStockData.mjs`

**功能**：一次執行所有資料同步，適合首次建立資料庫時使用

**使用方式**：
```bash
node scripts/initTwStockData.mjs
```

**執行步驟**：
1. 同步歷史價格資料
2. 同步基本面資料
3. 計算技術指標
4. 同步財務報表
5. 同步股利資訊

**預計執行時間**：30-60 分鐘（取決於股票數量和網路速度）

### 6.2 特定資料同步腳本

**檔案位置**：`scripts/syncSpecificData.mjs`

**功能**：同步特定類型的資料

**使用方式**：
```bash
# 只同步歷史價格
node scripts/syncSpecificData.mjs prices

# 只同步基本面資料
node scripts/syncSpecificData.mjs fundamentals

# 只計算技術指標
node scripts/syncSpecificData.mjs indicators

# 只同步財務報表
node scripts/syncSpecificData.mjs financials

# 只同步股利資訊
node scripts/syncSpecificData.mjs dividends
```

### 6.3 資料驗證腳本

**檔案位置**：`scripts/validateData.mjs`

**功能**：檢查資料庫完整性並生成驗證報告

**使用方式**：
```bash
node scripts/validateData.mjs
```

**驗證項目**：
1. 股票基本資料統計
2. 歷史價格資料統計
3. 技術指標資料統計
4. 基本面資料統計
5. 財務報表資料統計
6. 股利資訊資料統計
7. 資料同步狀態檢查
8. 資料完整性評分
9. 改進建議

---

## 七、使用指南

### 7.1 首次部署流程

1. **確認環境變數**
   - 確保 `DATABASE_URL` 已設定
   - 確保 `REDIS_URL` 已設定
   - 確保 FinMind API Token 已設定（如需要）

2. **執行資料庫遷移**
   ```bash
   cd /home/ubuntu/us-stock-analyzer
   pnpm db:push
   ```

3. **執行初始化腳本**
   ```bash
   node scripts/initTwStockData.mjs
   ```

4. **驗證資料完整性**
   ```bash
   node scripts/validateData.mjs
   ```

5. **啟動自動化排程**
   - 排程會在伺服器啟動時自動啟動
   - 檢查 `server/_core/index.ts` 確認已呼叫 `startAllSchedules()`

### 7.2 日常維護

**監控資料同步狀態**：
- 定期檢查 `twDataSyncStatus` 表
- 檢查 `twDataSyncErrors` 表是否有錯誤記錄
- 使用驗證腳本定期檢查資料完整性

**手動補充資料**：
```bash
# 補充特定類型的資料
node scripts/syncSpecificData.mjs <data_type>

# 執行完整同步
node scripts/initTwStockData.mjs
```

**清理快取**：
- Redis 快取會自動過期
- 如需手動清理，可使用 Redis CLI：
  ```bash
  redis-cli KEYS "tw:stock:*" | xargs redis-cli DEL
  ```

### 7.3 API 使用範例

**前端呼叫範例**：

```typescript
import { trpc } from '@/lib/trpc';

// 搜尋台股
const { data: stocks } = trpc.twStock.search.useQuery({
  keyword: '台積電',
  limit: 10,
});

// 獲取股票詳情
const { data: detail } = trpc.twStock.getDetail.useQuery({
  symbol: '2330',
});

// 獲取歷史價格
const { data: prices } = trpc.twStock.getHistorical.useQuery({
  symbol: '2330',
  startDate: '2024-01-01',
  endDate: '2024-12-31',
});

// 獲取技術指標
const { data: indicators } = trpc.twStock.getIndicators.useQuery({
  symbol: '2330',
  startDate: '2024-01-01',
  endDate: '2024-12-31',
});

// 獲取基本面資料
const { data: fundamentals } = trpc.twStock.getFundamentals.useQuery({
  symbol: '2330',
  year: 2024,
  quarter: 1,
});

// 獲取財務報表
const { data: financials } = trpc.twStock.getFinancials.useQuery({
  symbol: '2330',
  year: 2024,
  quarter: 1,
});

// 獲取股利資訊
const { data: dividends } = trpc.twStock.getDividends.useQuery({
  symbol: '2330',
  year: 2024,
});

// 分頁查詢歷史價格
const { data: paginatedPrices } = trpc.twStock.getHistoricalPaginated.useQuery({
  symbol: '2330',
  page: 1,
  pageSize: 50,
});
```

---

## 八、技術特點

### 8.1 資料精確度

- 所有價格和百分比欄位使用 `DECIMAL` 型別
- 避免浮點數運算誤差
- 確保財務計算的準確性

### 8.2 效能優化

- Redis 快取機制減少資料庫查詢
- 合理的 TTL 策略平衡即時性和效能
- 資料庫索引優化查詢速度
- 分頁查詢支援大量資料載入

### 8.3 可靠性

- 指數退避重試機制處理網路錯誤
- 部分失敗處理確保資料完整性
- 錯誤記錄和通知機制
- 資料同步狀態追蹤

### 8.4 可維護性

- 清晰的模組化架構
- 完整的文件和註解
- 工具腳本簡化維護工作
- 驗證腳本確保資料品質

---

## 九、已知限制

1. **FinMind API 限制**
   - 免費版有請求頻率限制
   - 部分歷史資料可能不完整
   - 需要定期檢查 API 可用性

2. **資料更新頻率**
   - 歷史價格：每日收盤後更新
   - 基本面資料：每週更新
   - 財務報表：每季更新
   - 股利資訊：每年更新

3. **技術指標計算**
   - 需要足夠的歷史價格資料
   - 計算結果可能與其他平台略有差異
   - 依賴資料品質

---

## 十、未來擴展建議

1. **資料來源多樣化**
   - 整合其他資料來源作為備援
   - 交叉驗證資料準確性

2. **即時資料支援**
   - 整合即時報價 API
   - WebSocket 推送即時資料

3. **進階技術指標**
   - 新增更多技術指標（布林通道、MACD等）
   - 支援自訂指標計算

4. **資料分析功能**
   - 股票篩選器
   - 投資組合分析
   - 回測功能

5. **效能優化**
   - 資料庫分表策略
   - 讀寫分離
   - 資料壓縮

---

## 十一、聯絡資訊

如有任何問題或建議，請聯繫開發團隊。

---

**文件版本**：v1.0  
**最後更新**：2024年12月
