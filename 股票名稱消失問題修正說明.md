# 「為您推薦」區塊股票名稱消失問題修正說明

## 修正日期
2025-11-30

## 問題描述

在「為您推薦」區塊中，台美股卡片的股票名稱在某些情況下會消失，只顯示股票代碼，影響使用者體驗。

### 問題根源

原始程式碼使用條件渲染 `{displayName && (...)}` 來顯示股票名稱：

```tsx
{/* 股票名稱 */}
{displayName && (
  <p className="text-xs text-muted-foreground text-center line-clamp-2 mb-1 min-h-[2rem] px-1">
    {displayName}
  </p>
)}
```

這導致以下問題：
1. **載入中狀態**：當股價資料尚未完全載入時，`displayName` 為 `null`，名稱區塊完全不顯示
2. **API 資料缺失**：某些股票無法從 API 獲取完整名稱資訊時，名稱區塊消失
3. **視覺不一致**：卡片高度因名稱區塊的顯示/隱藏而變化，造成視覺跳動

## 解決方案

### 1. 優化顯示邏輯

將條件渲染改為三種狀態處理：

```tsx
{/* 股票名稱 */}
<div className="text-center mb-1 min-h-[2rem] px-1">
  {(() => {
    const isLoading = stockDataQueries[index]?.isLoading;
    
    if (isLoading) {
      // 載入中：顯示骨架屏
      return (
        <div className="flex justify-center items-center h-full">
          <div className="h-3 w-24 bg-gradient-to-r from-muted/80 via-muted/60 to-muted/80 rounded animate-pulse"></div>
        </div>
      );
    }
    
    if (displayName) {
      // 有名稱：顯示股票名稱
      return (
        <p className="text-xs text-muted-foreground text-center line-clamp-2">
          {displayName}
        </p>
      );
    }
    
    // 無名稱：顯示股票代碼作為後備
    return (
      <p className="text-xs text-muted-foreground/70 text-center line-clamp-2">
        {displaySymbol}
      </p>
    );
  })()}
</div>
```

### 2. 修正檔案

#### 桌面版推薦卡片
- **檔案**：`client/src/pages/Home.tsx`
- **修正位置**：第 667-697 行
- **修正內容**：優化股票名稱顯示邏輯，新增三種狀態處理

#### 手機版推薦輪播
- **檔案**：`client/src/components/MobileRecommendationCarousel.tsx`
- **修正位置**：第 163-193 行
- **修正內容**：同步優化顯示邏輯，確保跨裝置一致性

### 3. 技術實作細節

#### 三種顯示狀態

1. **載入中狀態**
   - 條件：`isLoading === true`
   - 顯示：漸層骨架屏動畫
   - 樣式：`h-3 w-24 bg-gradient-to-r from-muted/80 via-muted/60 to-muted/80 rounded animate-pulse`

2. **有名稱狀態**
   - 條件：`displayName` 存在且非空
   - 顯示：完整股票名稱
   - 樣式：`text-xs text-muted-foreground text-center line-clamp-2`

3. **後備狀態**
   - 條件：`displayName` 為空或 `null`
   - 顯示：股票代碼
   - 樣式：`text-xs text-muted-foreground/70 text-center line-clamp-2`（透明度降低以區分）

#### 高度一致性

使用 `min-h-[2rem]`（手機版）或 `min-h-[1.5rem] sm:min-h-[2rem]`（桌面版）確保名稱區塊始終保持固定高度，避免視覺跳動。

## 測試驗證

### 單元測試

撰寫 12 個單元測試涵蓋所有顯示情境：

```typescript
// 測試檔案：server/stock-name-display.test.ts

describe('股票名稱顯示邏輯', () => {
  describe('顯示狀態判斷', () => {
    it('應該在載入中時返回 "loading" 狀態', () => { ... });
    it('應該在有名稱時返回 "hasName" 狀態', () => { ... });
    it('應該在無名稱時返回 "fallback" 狀態', () => { ... });
  });
  
  describe('名稱內容生成', () => {
    it('應該在載入中時返回 null（顯示骨架屏）', () => { ... });
    it('應該在有名稱時返回股票名稱', () => { ... });
    it('應該在無名稱時返回股票代碼', () => { ... });
    it('應該在空字串名稱時返回股票代碼', () => { ... });
  });
  
  describe('台股名稱處理', () => {
    it('應該正確顯示台股名稱', () => { ... });
    it('應該在台股無名稱時返回股票代碼', () => { ... });
  });
  
  describe('邊界情況', () => {
    it('應該處理 undefined 名稱', () => { ... });
    it('應該處理只包含空格的名稱', () => { ... });
    it('應該處理超長名稱', () => { ... });
  });
});
```

### 測試結果

```
✓ server/stock-name-display.test.ts (12 tests) 6ms
  ✓ 股票名稱顯示邏輯 (12)
    ✓ 顯示狀態判斷 (3)
      ✓ 應該在載入中時返回 "loading" 狀態 2ms
      ✓ 應該在有名稱時返回 "hasName" 狀態 0ms
      ✓ 應該在無名稱時返回 "fallback" 狀態 0ms
    ✓ 名稱內容生成 (4)
      ✓ 應該在載入中時返回 null（顯示骨架屏） 0ms
      ✓ 應該在有名稱時返回股票名稱 0ms
      ✓ 應該在無名稱時返回股票代碼 0ms
      ✓ 應該在空字串名稱時返回股票代碼 0ms
    ✓ 台股名稱處理 (2)
      ✓ 應該正確顯示台股名稱 0ms
      ✓ 應該在台股無名稱時返回股票代碼 0ms
    ✓ 邊界情況 (3)
      ✓ 應該處理 undefined 名稱 0ms
      ✓ 應該處理只包含空格的名稱 0ms
      ✓ 應該處理超長名稱（應由 CSS line-clamp 處理截斷） 0ms

Test Files  1 passed (1)
Tests  12 passed (12)
```

**測試通過率：12/12 (100%)**

## 視覺一致性

### 配色方案 v3.0 遵循

1. **骨架屏動畫**
   - 使用配色方案定義的 `muted` 色彩變數
   - 漸層效果：`from-muted/80 via-muted/60 to-muted/80`
   - 動畫：`animate-pulse`（全站統一的載入動畫）

2. **文字色彩**
   - 正常顯示：`text-muted-foreground`（符合配色方案的次要文字色彩）
   - 後備顯示：`text-muted-foreground/70`（透明度降低以區分）

3. **字體層級**
   - 手機版：`text-xs`
   - 桌面版：`text-[10px] sm:text-xs lg:text-sm`（響應式字體大小）

### 響應式設計

#### 手機版（375px - 767px）
- 卡片寬度：`flex-[0_0_75%]`（橫向滑動輪播）
- 名稱高度：`min-h-[2rem]`
- 字體大小：`text-xs`

#### 平板版（768px - 1024px）
- 卡片佈局：`sm:grid-cols-3`（3 欄網格）
- 名稱高度：`sm:min-h-[2rem]`
- 字體大小：`sm:text-xs`

#### 桌面版（1920px 以上）
- 卡片佈局：`lg:grid-cols-6`（6 欄網格）
- 名稱高度：`sm:min-h-[2rem]`
- 字體大小：`lg:text-sm`

## 使用者體驗改善

### 修正前
- ❌ 載入時名稱區塊消失，造成視覺跳動
- ❌ 無法獲取名稱時卡片顯示不完整
- ❌ 使用者無法判斷是載入中還是資料缺失

### 修正後
- ✅ 載入時顯示骨架屏動畫，提供視覺回饋
- ✅ 無法獲取名稱時顯示股票代碼作為後備
- ✅ 卡片高度保持一致，無視覺跳動
- ✅ 使用者可清楚判斷載入狀態

## 後續建議

### 短期優化
1. 考慮為台股股票建立更完整的名稱映射表
2. 優化 API 回應速度，減少載入時間
3. 實作錯誤重試機制，提高資料獲取成功率

### 長期優化
1. 建立股票名稱快取機制，減少 API 請求
2. 實作股票名稱本地化（繁體中文/簡體中文/英文）
3. 提供使用者自訂股票別名功能

## 總結

本次修正成功解決了「為您推薦」區塊中股票名稱消失的問題，透過優化顯示邏輯、新增三種狀態處理、撰寫完整的單元測試，確保了功能的穩定性和視覺一致性。修正後的程式碼遵循配色方案 v3.0 設計規範，保持了全站的響應式設計一致性，顯著提升了使用者體驗。
