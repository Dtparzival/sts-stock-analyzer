# STS 投資分析平台 v5.1 版本更新說明

## 更新日期
2025-12-18

## 版本概述
本次更新主要針對資料架構進行優化，移除歷史價格資料表並改用即時 API 呼叫，同時將台股基本資料來源從 FinMind API 改為 TWSE/TPEx 官方 OpenAPI，提升資料的即時性與可靠性。

---

## 主要變更

### 1. 移除歷史價格資料表

**變更內容：**
- 刪除 `twStockPrices` 資料表
- 刪除 `usStockPrices` 資料表
- 價格資料改為即時呼叫 API 取得

**影響範圍：**
- 台股價格：透過 TWSE/TPEx API 即時取得
- 美股價格：透過 TwelveData API 即時取得
- 資料庫儲存空間大幅減少
- 價格資料更即時，不再有 T+1 延遲

**優點：**
- 減少資料庫儲存成本
- 價格資料即時性提升
- 簡化資料同步邏輯
- 避免歷史價格資料過期問題

---

### 2. 台股基本資料來源更新

**變更前：**
- 使用 FinMind API 獲取台股基本資料
- 資料來源為第三方整合

**變更後：**
- 使用 TWSE/TPEx 官方 OpenAPI
- 直接從台灣證券交易所與櫃買中心取得資料

**API 來源：**
| 市場 | API 端點 | 資料類型 |
|------|----------|----------|
| TWSE 上市 | `openapi.twse.com.tw/v1/opendata/t187ap03_L` | 公司基本資料 |
| TWSE 上市 | `openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_ALL` | 每日交易資料 (含 ETF) |
| TPEx 上櫃 | `tpex.org.tw/openapi/v1/mopsfin_t187ap03_O` | 公司基本資料 |
| TPEx 上櫃 | `tpex.org.tw/openapi/v1/tpex_mainboard_quotes` | 每日交易資料 (含 ETF) |

**同步統計：**
| 類別 | 數量 |
|------|------|
| TWSE 上市股票 | 1,121 |
| TWSE 上市 ETF | 205 |
| TPEx 上櫃股票 | 877 |
| TPEx 上櫃 ETF | 106 |
| **總計** | **2,309** |

---

### 3. 新增模組

**`server/integrations/twseOfficial.ts`**

新增 TWSE/TPEx 官方 API 整合模組，提供以下功能：

```typescript
// 取得 TWSE 上市公司基本資料
fetchTwseCompanyList(): Promise<TwseCompanyInfo[]>

// 取得 TWSE 每日交易資料 (含 ETF)
fetchTwseDailyTrading(): Promise<TwseDailyTrading[]>

// 取得 TPEx 上櫃公司基本資料
fetchTpexCompanyList(): Promise<TpexCompanyInfo[]>

// 取得 TPEx 每日交易資料 (含 ETF)
fetchTpexDailyTrading(): Promise<TpexDailyTrading[]>

// 整合同步函數 - 獲取所有台股基本資料
fetchAllTwStockInfo(): Promise<{ stocks: UnifiedStockInfo[], stats: SyncResult }>
```

---

### 4. 同步排程更新

**台股基本資料同步：**
- 排程時間：每週日 02:00 (Asia/Taipei)
- 資料來源：TWSE/TPEx 官方 OpenAPI
- 同步內容：上市櫃股票與 ETF 基本資料

**美股基本資料同步：**
- 排程時間：每週日 06:00 (Asia/Taipei)
- 資料來源：TwelveData API
- 同步內容：S&P 500 成分股與主要 ETF

**啟動時同步檢查：**
- 自動檢查最後同步時間
- 超過 8 天未同步則自動補執行
- 確保資料不會因 sandbox 休眠而過期

---

## 技術細節

### 資料轉換

TWSE/TPEx API 回傳的原始資料會經過轉換，統一為以下格式：

```typescript
interface UnifiedStockInfo {
  symbol: string;      // 股票代號
  name: string;        // 公司名稱
  shortName: string;   // 股票簡稱
  industry: string;    // 產業分類
  market: 'TWSE' | 'TPEx';  // 市場類型
  type: 'stock' | 'etf' | 'other';  // 股票類型
  listedDate: string | null;  // 上市日期
  capital: number | null;     // 實收資本額
  isActive: boolean;   // 是否活躍
}
```

### 產業代碼對照

系統內建 TWSE 與 TPEx 的產業代碼對照表，自動將數字代碼轉換為中文產業名稱。

### 錯誤處理

- 實作指數退避重試機制 (最多 3 次)
- 每次重試間隔 2 秒
- API 請求超時設定為 30 秒
- 錯誤記錄至 `twDataSyncErrors` 表

---

## 相容性說明

### 前端影響
- 無需修改，API 介面保持不變
- 價格資料回應格式相同

### 後端影響
- `twStockPrices` 相關查詢已移除
- `usStockPrices` 相關查詢已移除
- 價格查詢改為即時 API 呼叫

### 測試更新
- 更新 `tests/twStockRouter.test.ts` 移除價格表引用
- 價格相關測試改為測試即時 API 呼叫

---

## 後續規劃

1. **快取機制優化**：實作 Redis 快取層，減少 API 呼叫次數
2. **資料品質監控**：建立資料完整性檢查機制
3. **效能優化**：優化批次查詢邏輯

---

## 更新記錄

| 版本 | 日期 | 說明 |
|------|------|------|
| v5.1 | 2025-12-18 | 移除歷史價格表，改用 TWSE/TPEx 官方 API |
| v5.0 | 2025-12-11 | 混合同步架構，價格改為即時 API |
| v4.0 | 2025-01-03 | 雙市場版本，新增美股支援 |
