# 台股代號格式統一評估報告

## 執行摘要

**建議方案：保持現狀（使用 .TW 後綴）**

經過全面分析，我們**不建議**移除台股代號的 `.TW` 後綴。原因如下：

1. ✅ **已解決的問題**：中文名稱搜尋導致的收藏狀態顯示錯誤已經修正
2. ⚠️ **高風險**：移除 `.TW` 後綴需要大規模數據遷移和代碼重構
3. ⚠️ **技術複雜度高**：需要在多個層級添加格式轉換邏輯
4. ⚠️ **維護成本增加**：與外部 API 整合時需要頻繁的格式轉換
5. ✅ **當前架構穩定**：現有的格式轉換機制運作良好

---

## 詳細分析

### 1. 當前台股代號使用情況

#### 資料庫層面（5 個表）

| 表名 | symbol 欄位 | 當前格式 | 影響記錄數 |
|------|-------------|----------|-----------|
| `watchlist` | varchar(20) | `2330.TW` | 用戶收藏記錄 |
| `searchHistory` | varchar(20) | `2330.TW` | 搜尋歷史記錄（已遷移 48 筆）|
| `analysisCache` | varchar(20) | `2330.TW` | AI 分析緩存 |
| `portfolio` | varchar(20) | `2330.TW` | 投資組合持倉 |
| `stockDataCache` | varchar(20) | `2330.TW` | 股票數據緩存 |
| `twseStockList` | varchar(10) | `2330` | TWSE 股票列表（已是純數字）|

**總計：5 個表需要數據遷移**

#### 後端 API 層面（6 個主要 API）

| API | 當前處理邏輯 | 格式轉換位置 |
|-----|-------------|-------------|
| `stock.getStockData` | 接收 `2330.TW`，調用 TWSE API 時轉換為 `2330` | `convertSymbolToTWSE()` |
| `stock.getStockInsights` | 接收 `2330.TW`，傳遞給 LLM | 無轉換 |
| `stock.getStockHolders` | 接收 `2330.TW`，調用外部 API | 格式轉換 |
| `watchlist.check/add/remove` | 接收 `2330.TW`，直接儲存到資料庫 | 無轉換 |
| `portfolio.*` | 接收 `2330.TW`，直接儲存到資料庫 | 無轉換 |
| `history.addSearchHistory` | 接收 `2330.TW`，儲存到資料庫 | 無轉換 |

**總計：6 個 API 需要修改**

#### 前端頁面層面（5 個主要頁面）

| 頁面 | 當前處理邏輯 | URL 格式 |
|------|-------------|----------|
| `Home.tsx` | 搜尋時自動添加 `.TW` 後綴 | `/stock/2330.TW` |
| `StockDetail.tsx` | 從 URL 讀取 `2330.TW`，傳遞給 API | `/stock/2330.TW` |
| `Watchlist.tsx` | 顯示 `2330 台積電`（移除 `.TW` 後綴顯示）| - |
| `Portfolio.tsx` | 顯示 `2330 台積電`（移除 `.TW` 後綴顯示）| - |
| `SearchHistory.tsx` | 顯示 `2330 台積電`（移除 `.TW` 後綴顯示）| - |

**總計：5 個頁面需要修改**

#### 工具函數層面（4 個核心函數）

| 函數 | 當前邏輯 | 用途 |
|------|----------|------|
| `getMarketFromSymbol()` | 檢測 `.TW` 後綴或 4 位數字 | 判斷市場類型 |
| `cleanTWSymbol()` | 移除 `.TW` 後綴用於顯示 | 前端顯示格式化 |
| `getFullTWSymbol()` | 添加 `.TW` 後綴 | 確保完整格式 |
| `searchTWStockByName()` | 返回 `2330.TW` 格式 | 中文名稱搜尋 |

**總計：4 個工具函數需要修改**

---

### 2. 移除 .TW 後綴的影響範圍

#### 需要修改的代碼文件（預估 20+ 個文件）

**資料庫層面：**
- `drizzle/schema.ts`（5 個表的註釋和驗證邏輯）
- 數據遷移腳本（需要創建 5 個遷移腳本）

**後端層面：**
- `server/routers.ts`（6 個 API 的 symbol 處理邏輯）
- `server/db.ts`（所有資料庫操作函數）
- `server/twse.ts`（TWSE API 整合，格式轉換邏輯）
- `server/dbStockDataCache.ts`（緩存 key 生成邏輯）
- `server/dbTwseStockListCache.ts`（股票列表緩存）

**前端層面：**
- `client/src/pages/Home.tsx`（搜尋邏輯、URL 導航）
- `client/src/pages/StockDetail.tsx`（URL 參數處理、API 調用）
- `client/src/pages/Watchlist.tsx`（收藏列表顯示）
- `client/src/pages/Portfolio.tsx`（投資組合表格）
- `client/src/pages/SearchHistory.tsx`（搜尋歷史記錄）

**共享模組層面：**
- `shared/markets.ts`（4 個工具函數的核心邏輯）
- `shared/twStockNames.ts`（TW_STOCK_NAMES 映射表的 key 格式）

---

### 3. 方案比較

#### 方案 A：完全移除 .TW 後綴（不推薦）

**優點：**
- ✅ URL 更簡潔（`/stock/2330` vs `/stock/2330.TW`）
- ✅ 減少前端顯示時的格式轉換邏輯（不需要 `cleanTWSymbol()`）
- ✅ 與 TWSE API 格式一致（TWSE 使用純數字代碼）

**缺點：**
- ❌ **高風險數據遷移**：需要更新 5 個資料庫表的所有台股記錄（可能數千筆）
- ❌ **大規模代碼重構**：需要修改 20+ 個文件，涉及前後端和共享模組
- ❌ **與外部 API 格式不一致**：Yahoo Finance API 使用 `2330.TW` 格式
- ❌ **增加格式轉換邏輯**：每次調用外部 API 都需要添加 `.TW` 後綴
- ❌ **潛在的 bug 風險**：格式轉換邏輯遺漏可能導致新的 bug
- ❌ **測試成本高**：需要全面測試所有功能（搜尋、收藏、投資組合、分析等）
- ❌ **回滾困難**：一旦遷移完成，回滾成本極高

**實作工作量評估：**
- 數據遷移腳本：5 個（每個表一個）
- 後端 API 修改：6 個主要 API + 10+ 個輔助函數
- 前端頁面修改：5 個主要頁面 + 多個組件
- 工具函數修改：4 個核心函數
- 測試工作：所有功能的完整測試（預估 20+ 個測試場景）
- **預估總工時：40-60 小時**

#### 方案 B：保持現狀（推薦）✅

**優點：**
- ✅ **零風險**：無需數據遷移，無需代碼重構
- ✅ **與外部 API 格式一致**：Yahoo Finance API 使用 `2330.TW` 格式
- ✅ **現有架構穩定**：格式轉換機制運作良好
- ✅ **維護成本低**：無需添加新的格式轉換邏輯
- ✅ **已解決的問題**：中文名稱搜尋導致的收藏狀態錯誤已修正

**缺點：**
- ⚠️ URL 稍長（`/stock/2330.TW` vs `/stock/2330`）
- ⚠️ 前端顯示時需要格式轉換（使用 `cleanTWSymbol()`）

**實作工作量評估：**
- **預估總工時：0 小時**（無需任何修改）

---

### 4. 技術債務分析

#### 當前技術債務（可接受）

1. **格式轉換邏輯分散**：
   - 前端顯示：使用 `cleanTWSymbol()` 移除 `.TW` 後綴
   - 後端 API：使用 `convertSymbolToTWSE()` 轉換為 TWSE 格式
   - **評估：可接受**，這些工具函數已經封裝良好，維護成本低

2. **URL 格式與顯示格式不一致**：
   - URL：`/stock/2330.TW`
   - 顯示：`2330 台積電`
   - **評估：可接受**，用戶不會直接看到 URL，不影響用戶體驗

#### 移除 .TW 後綴後的新技術債務（不可接受）

1. **與外部 API 格式不一致**：
   - 資料庫：`2330`
   - Yahoo Finance API：`2330.TW`
   - **評估：不可接受**，每次調用外部 API 都需要格式轉換，容易遺漏

2. **格式轉換邏輯增加**：
   - 需要在所有調用外部 API 的地方添加 `.TW` 後綴
   - 需要在所有儲存到資料庫的地方移除 `.TW` 後綴
   - **評估：不可接受**，增加維護成本和 bug 風險

---

### 5. 用戶體驗影響

#### 當前用戶體驗（良好）

- ✅ 搜尋功能：支援代號（2330）和中文名稱（台積電）
- ✅ 收藏狀態：所有入口都能正確顯示
- ✅ 顯示格式：統一為「代號在上，名稱在下」
- ✅ URL 格式：`/stock/2330.TW`（用戶不會直接看到）

#### 移除 .TW 後綴後的用戶體驗（無明顯改善）

- ✅ 搜尋功能：與當前相同
- ✅ 收藏狀態：與當前相同
- ✅ 顯示格式：與當前相同
- ✅ URL 格式：`/stock/2330`（稍微簡潔，但用戶不會直接看到）

**結論：用戶體驗無明顯改善**

---

### 6. 風險評估

#### 數據遷移風險（高）

| 風險項目 | 風險等級 | 說明 |
|---------|---------|------|
| 數據丟失 | 🔴 高 | 遷移腳本錯誤可能導致數據丟失 |
| 數據不一致 | 🔴 高 | 部分記錄遷移失敗可能導致格式不一致 |
| 服務中斷 | 🟡 中 | 遷移期間可能需要停機維護 |
| 回滾困難 | 🔴 高 | 一旦遷移完成，回滾成本極高 |

#### 代碼重構風險（高）

| 風險項目 | 風險等級 | 說明 |
|---------|---------|------|
| 格式轉換遺漏 | 🔴 高 | 某些地方忘記添加 `.TW` 後綴 |
| 新 bug 引入 | 🔴 高 | 大規模修改容易引入新 bug |
| 測試覆蓋不全 | 🟡 中 | 難以測試所有邊界情況 |
| 維護成本增加 | 🟡 中 | 格式轉換邏輯分散，維護困難 |

---

## 最終建議

### ✅ 推薦方案：保持現狀（使用 .TW 後綴）

**理由：**

1. **已解決的問題**：
   - 中文名稱搜尋導致的收藏狀態顯示錯誤已經修正
   - 所有入口（搜尋代號、中文名稱、熱門股票、收藏列表）都能正確顯示收藏狀態
   - 現有架構穩定，無已知 bug

2. **成本效益分析**：
   - 移除 `.TW` 後綴的收益：URL 稍微簡潔（用戶不會直接看到）
   - 移除 `.TW` 後綴的成本：40-60 小時工時 + 高風險數據遷移 + 大規模代碼重構
   - **結論：成本遠高於收益**

3. **技術考量**：
   - 與外部 API（Yahoo Finance）格式一致
   - 無需在多個層級添加格式轉換邏輯
   - 維護成本低，技術債務可控

4. **風險考量**：
   - 數據遷移風險高（可能導致數據丟失或不一致）
   - 代碼重構風險高（容易引入新 bug）
   - 回滾困難（一旦遷移完成，回滾成本極高）

---

## 替代方案（如果堅持移除 .TW 後綴）

如果您仍然希望移除 `.TW` 後綴，我們建議採用以下**分階段、低風險**的實作策略：

### 階段 1：準備階段（2-3 小時）

1. 創建完整的資料庫備份
2. 在測試環境中執行數據遷移腳本
3. 驗證遷移結果的正確性

### 階段 2：後端修改（10-15 小時）

1. 修改所有後端 API 的 symbol 處理邏輯
2. 添加格式轉換函數（在調用外部 API 時自動添加 `.TW`）
3. 更新資料庫操作函數
4. 編寫單元測試

### 階段 3：前端修改（10-15 小時）

1. 修改所有前端頁面的 URL 導航邏輯
2. 更新工具函數（`getMarketFromSymbol`、`searchTWStockByName` 等）
3. 移除不必要的格式轉換邏輯（`cleanTWSymbol`）
4. 編寫 E2E 測試

### 階段 4：數據遷移（5-10 小時）

1. 在生產環境中執行數據遷移腳本
2. 驗證遷移結果
3. 監控系統運行狀況
4. 準備回滾方案

### 階段 5：測試與驗證（10-15 小時）

1. 全面測試所有功能（搜尋、收藏、投資組合、分析等）
2. 測試所有入口（搜尋代號、中文名稱、熱門股票、收藏列表）
3. 測試邊界情況（未登入用戶、API 失敗、緩存機制等）
4. 修復發現的 bug

**預估總工時：40-60 小時**
**風險等級：🔴 高**

---

## 結論

基於以上全面分析，我們**強烈建議保持現狀（使用 .TW 後綴）**。

當前架構穩定，所有已知問題已解決，用戶體驗良好。移除 `.TW` 後綴的收益極小（僅 URL 稍微簡潔），但成本和風險極高（40-60 小時工時 + 高風險數據遷移 + 大規模代碼重構）。

如果您仍然希望移除 `.TW` 後綴，請仔細評估上述風險，並遵循分階段、低風險的實作策略。
