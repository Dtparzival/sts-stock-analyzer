# AI 分析準確度追蹤優化功能 SA Spec 規格書

**文件版本：** 1.0  
**撰寫日期：** 2025-11-19  
**撰寫者：** Manus AI  
**專案名稱：** 美股投資分析平台（US Stock Analyzer）

---

## 1. 文件概述

本規格書詳細說明「AI 分析準確度追蹤優化功能」的系統分析與設計規格，涵蓋三個核心功能模組的需求定義、系統架構、技術實作、數據流程、UI/UX 設計以及測試驗收標準。本功能旨在提升用戶對 AI 投資分析建議的信任度，透過多維度的準確度追蹤、視覺化呈現和智能提醒機制，幫助用戶更全面地評估 AI 分析的可靠性，並做出更明智的投資決策。

### 1.1 功能模組概覽

本次優化包含三個相互關聯的功能模組，共同構成完整的 AI 分析準確度追蹤體系：

**準確度時間趨勢分析**模組透過按月份統計 AI 分析準確率，以折線圖視覺化呈現準確率隨時間的變化趨勢。此功能幫助用戶了解 AI 模型是否持續改進，並識別準確率的季節性波動或長期趨勢。用戶可選擇不同的評估時間範圍（7 天、30 天、90 天）來觀察短期和長期的準確度表現。

**個股深度分析報告**模組為每支股票生成專屬的 AI 分析表現報告，包含歷史建議統計、準確率分析、最佳預測案例和最差預測案例的詳細資訊。此功能提供更深入的個股 AI 表現洞察，幫助用戶了解 AI 對特定股票的分析能力，並從成功和失敗的案例中學習投資經驗。

**準確度提醒功能**模組自動識別準確率低於設定閾值的股票，並在準確度追蹤頁面頂部顯示醒目的警告區域。此功能主動提醒用戶謹慎參考低準確率股票的 AI 建議，降低因過度依賴不可靠建議而導致的投資風險。

### 1.2 文件目的

本規格書的主要目的包括：

**需求明確化**：詳細定義每個功能模組的功能需求、業務邏輯和使用場景，確保開發團隊和利害關係人對功能範圍有一致的理解。

**技術指導**：提供完整的技術架構、API 規格、數據結構和演算法設計，作為開發團隊實作的技術藍圖。

**設計規範**：定義 UI/UX 設計原則、視覺元素和互動流程，確保功能符合用戶體驗標準並與現有系統風格一致。

**測試基準**：建立明確的測試規格和驗收標準，作為品質保證團隊進行功能驗證的依據。

**文件化記錄**：為未來的系統維護、功能擴展和知識傳承提供完整的技術文件。

---

## 2. 功能需求規格

### 2.1 功能一：準確度時間趨勢分析

#### 2.1.1 功能概述

準確度時間趨勢分析功能透過按月份統計 AI 分析準確率，以折線圖視覺化呈現準確率隨時間的變化趨勢。此功能的核心價值在於幫助用戶追蹤 AI 模型的長期表現，識別準確率的改進或退化趨勢，並評估 AI 分析在不同市場環境下的穩定性。

#### 2.1.2 業務需求

**需求背景**：用戶需要了解 AI 分析模型是否隨著時間推移而持續改進，或是在特定時期表現不佳。單一時間點的準確率統計無法反映模型的動態表現，因此需要時間序列分析來揭示長期趨勢。

**目標用戶**：所有使用 AI 投資分析功能的平台用戶，特別是長期追蹤多支股票並依賴 AI 建議進行投資決策的活躍用戶。

**業務價值**：透過視覺化的趨勢分析，用戶可以更客觀地評估 AI 分析的可靠性，建立對系統的信任度，並在準確率下降時及時調整投資策略。此功能也為平台運營團隊提供模型表現監控工具，支援持續優化決策。

#### 2.1.3 功能需求

**FR-1.1 時間趨勢數據計算**：系統應按月份統計 AI 分析準確率，計算每個月份內所有分析記錄的準確率。統計範圍應涵蓋所有已完成評估的歷史分析記錄，確保數據的完整性和連續性。

**FR-1.2 多時間範圍支援**：系統應支援三種評估時間範圍的選擇：7 天後準確率、30 天後準確率和 90 天後準確率。用戶可透過下拉選單或按鈕切換不同的時間範圍，系統應即時重新計算並更新趨勢圖表。

**FR-1.3 整體趨勢圖表**：系統應提供整體準確率趨勢折線圖，X 軸為月份（格式：YYYY-MM），Y 軸為準確率百分比（0-100%）。圖表應包含數據點標記、趨勢線和互動式提示框，當用戶滑鼠懸停在數據點上時顯示該月份的詳細統計資訊。

**FR-1.4 按建議類型趨勢圖表**：系統應提供按建議類型（買入、持有、賣出）分類的準確率趨勢圖表，以不同顏色的折線區分各類建議的準確率變化。此功能幫助用戶了解 AI 在不同建議類型上的表現差異。

**FR-1.5 數據不足處理**：當歷史數據不足以生成有意義的趨勢圖時（例如少於 3 個月的數據），系統應顯示友善的提示訊息，說明需要累積更多歷史數據才能生成趨勢分析。

#### 2.1.4 非功能需求

**NFR-1.1 效能要求**：趨勢數據計算應在 3 秒內完成，圖表渲染應在 1 秒內完成，確保用戶體驗流暢。

**NFR-1.2 數據準確性**：準確率計算應精確到小數點後一位（例如 65.3%），確保統計結果的可信度。

**NFR-1.3 視覺化品質**：折線圖應採用專業的圖表庫（如 Recharts），確保圖表清晰、美觀且支援響應式設計，在不同螢幕尺寸下均能正常顯示。

#### 2.1.5 使用場景

**場景 1：長期用戶評估 AI 表現**  
用戶 Alice 使用平台已超過 6 個月，累積了大量的 AI 分析歷史記錄。她想了解 AI 模型在過去半年的表現是否穩定。Alice 進入準確度追蹤頁面，選擇「30 天後準確率」作為評估時間範圍，查看整體準確率趨勢圖。圖表顯示準確率在過去 6 個月從 55% 逐步提升至 68%，顯示 AI 模型持續改進。Alice 對此感到滿意，決定繼續依賴 AI 建議進行投資決策。

**場景 2：識別準確率下降趨勢**  
用戶 Bob 注意到最近幾次 AI 分析的建議似乎不太準確。他進入準確度追蹤頁面，查看「7 天後準確率」趨勢圖，發現最近 2 個月的準確率從 70% 下降至 50%。Bob 進一步查看按建議類型的趨勢圖，發現「買入建議」的準確率下降最為明顯。基於此分析，Bob 決定暫時減少對 AI 買入建議的依賴，轉而更多地依靠自己的判斷。

---

### 2.2 功能二：個股深度分析報告

#### 2.2.1 功能概述

個股深度分析報告功能為每支股票生成專屬的 AI 分析表現報告，包含歷史建議統計、準確率分析、最佳預測案例和最差預測案例的詳細資訊。此功能的核心價值在於提供個股層級的 AI 表現洞察，幫助用戶了解 AI 對特定股票的分析能力，並從成功和失敗的案例中學習投資經驗。

#### 2.2.2 業務需求

**需求背景**：不同股票的市場特性、波動性和基本面差異顯著，AI 模型對不同股票的分析準確率可能存在較大差異。用戶需要了解 AI 對特定股票的歷史表現，以便更準確地評估該股票 AI 建議的可靠性。

**目標用戶**：關注特定股票並希望深入了解 AI 對該股票分析表現的用戶，特別是持有或計劃投資該股票的用戶。

**業務價值**：透過個股層級的深度報告，用戶可以更精準地評估 AI 建議的可靠性，避免因 AI 對特定股票分析能力不足而導致的投資損失。此功能也幫助用戶從最佳和最差案例中學習，提升投資決策能力。

#### 2.2.3 功能需求

**FR-2.1 報告觸發入口**：在準確度追蹤頁面的股票明細表格中，每支股票應提供「查看報告」按鈕。用戶點擊按鈕後，系統應開啟個股深度分析報告對話框，顯示該股票的完整分析表現報告。

**FR-2.2 概覽統計**：報告應包含四個關鍵指標的概覽統計：總分析次數、整體準確率（基於 30 天後評估）、最佳預測獲利金額和最差預測損失金額。這些指標應以卡片形式並排顯示，提供快速的整體印象。

**FR-2.3 歷史建議統計**：報告應顯示該股票的歷史建議類型分布，包含買入建議次數、持有建議次數和賣出建議次數，以及各類建議的準確率。此統計幫助用戶了解 AI 對該股票的建議偏好和各類建議的可靠性。

**FR-2.4 最佳預測案例**：報告應識別並顯示最佳預測案例，定義為「準確且獲利最高」的分析記錄。案例詳情應包含：分析日期、建議類型、分析時價格、30 天後價格、價格變化百分比和假設投資 $10,000 的獲利金額。此案例展示 AI 分析的最佳表現，增強用戶信心。

**FR-2.5 最差預測案例**：報告應識別並顯示最差預測案例，定義為「不準確且損失最大」的分析記錄。案例詳情應包含與最佳案例相同的資訊欄位。此案例提醒用戶 AI 分析的潛在風險，促進謹慎決策。

**FR-2.6 最近分析記錄**：報告應顯示最近 10 次分析記錄的詳細表格，包含分析日期、建議類型、分析時價格、30 天後價格、價格變化百分比和準確性標記。此表格提供時間序列視角，幫助用戶了解 AI 對該股票的最新表現。

**FR-2.7 獲利/損失計算邏輯**：系統應根據建議類型計算假設投資 $10,000 的獲利或損失。買入建議的獲利計算為：價格變化百分比 × $10,000；賣出建議的獲利計算為：-價格變化百分比 × $10,000（模擬做空）；持有建議不計算獲利。

#### 2.2.4 非功能需求

**NFR-2.1 報告生成效能**：個股報告應在 2 秒內生成並顯示，確保用戶體驗流暢。

**NFR-2.2 對話框設計**：報告對話框應採用大尺寸設計（最大寬度 4xl），支援垂直滾動，確保所有內容清晰可見。對話框應包含關閉按鈕，用戶可隨時關閉報告。

**NFR-2.3 數據完整性**：當股票歷史分析記錄不足時（例如少於 3 次分析），系統應顯示友善的提示訊息，說明數據不足以生成完整報告。

#### 2.2.5 使用場景

**場景 1：評估特定股票的 AI 可靠性**  
用戶 Carol 正在考慮投資 Apple Inc. (AAPL)，她想了解 AI 對 AAPL 的歷史分析表現。Carol 進入準確度追蹤頁面，在股票明細表格中找到 AAPL，點擊「查看報告」按鈕。報告顯示 AI 對 AAPL 共進行了 15 次分析，整體準確率為 73.3%，其中買入建議的準確率高達 80%。最佳預測案例顯示，AI 在某次買入建議後，AAPL 股價在 30 天內上漲了 12%，假設投資 $10,000 可獲利 $1,200。基於此報告，Carol 對 AI 對 AAPL 的分析能力感到信心，決定採納 AI 的買入建議。

**場景 2：從失敗案例中學習**  
用戶 David 持有 Tesla Inc. (TSLA)，但最近一次 AI 的買入建議導致他虧損。David 查看 TSLA 的個股深度分析報告，發現最差預測案例顯示，AI 在某次買入建議後，TSLA 股價在 30 天內下跌了 15%，假設投資 $10,000 虧損 $1,500。David 進一步查看最近 10 次分析記錄，發現 AI 對 TSLA 的買入建議準確率僅為 50%。基於此分析，David 決定未來對 TSLA 的 AI 建議保持謹慎態度，並結合其他資訊來源進行決策。

---

### 2.3 功能三：準確度提醒功能

#### 2.3.1 功能概述

準確度提醒功能自動識別準確率低於設定閾值的股票，並在準確度追蹤頁面頂部顯示醒目的警告區域。此功能的核心價值在於主動提醒用戶謹慎參考低準確率股票的 AI 建議，降低因過度依賴不可靠建議而導致的投資風險。

#### 2.3.2 業務需求

**需求背景**：用戶可能未意識到某些股票的 AI 分析準確率偏低，仍然依賴 AI 建議進行投資決策，導致潛在的投資損失。系統需要主動識別並提醒用戶關注低準確率股票，促進更謹慎的決策。

**目標用戶**：所有使用 AI 投資分析功能的平台用戶，特別是依賴 AI 建議進行投資決策的用戶。

**業務價值**：透過主動提醒機制，系統可以降低用戶因過度依賴不可靠 AI 建議而導致的投資風險，提升用戶對平台的信任度和滿意度。此功能也體現平台的責任感和用戶關懷。

#### 2.3.3 功能需求

**FR-3.1 低準確率識別邏輯**：系統應自動識別準確率低於設定閾值的股票。預設閾值為 50%，且股票至少需要有 3 次分析記錄才會被納入評估範圍。此邏輯確保提醒基於足夠的統計樣本，避免誤報。

**FR-3.2 警告區域顯示**：當存在低準確率股票時，系統應在準確度追蹤頁面頂部顯示醒目的警告區域。警告區域應採用黃色背景和警告圖示，標題為「低準確率股票警告」，描述文字說明「以下股票的 AI 分析準確率低於 50%，建議謹慎參考 AI 建議」。

**FR-3.3 警告卡片設計**：警告區域應以網格佈局顯示所有低準確率股票的警告卡片（每行最多 3 張卡片）。每張卡片應包含：股票代號、準確率標籤（紅色徽章）、分析次數、最近建議類型和「查看詳細報告」按鈕。

**FR-3.4 快速查看報告**：用戶點擊警告卡片上的「查看詳細報告」按鈕後，系統應開啟該股票的個股深度分析報告對話框，提供完整的分析表現資訊。

**FR-3.5 動態更新**：警告區域應根據用戶選擇的評估時間範圍（7 天、30 天、90 天）動態更新，確保提醒資訊與當前查看的準確度統計一致。

**FR-3.6 無警告處理**：當所有股票的準確率均高於閾值時，系統不應顯示警告區域，保持頁面簡潔。

#### 2.3.4 非功能需求

**NFR-3.1 視覺突出性**：警告區域應採用醒目的視覺設計（黃色背景、警告圖示），確保用戶能夠立即注意到提醒資訊。

**NFR-3.2 效能要求**：低準確率股票識別應在 1 秒內完成，確保頁面載入流暢。

**NFR-3.3 用戶體驗**：警告區域應設計為非侵入式，不應遮擋其他重要資訊，用戶可自然地滾動頁面查看其他內容。

#### 2.3.5 使用場景

**場景 1：發現低準確率股票**  
用戶 Emma 進入準確度追蹤頁面，頁面頂部顯示黃色警告區域，標題為「低準確率股票警告」。警告區域顯示 3 張卡片，分別對應 GameStop Corp. (GME)、AMC Entertainment (AMC) 和 Palantir Technologies (PLTR)，準確率分別為 35%、42% 和 48%。Emma 點擊 GME 的「查看詳細報告」按鈕，查看該股票的個股深度分析報告。報告顯示 AI 對 GME 的買入建議準確率僅為 30%，最差預測案例導致假設投資 $10,000 虧損 $2,500。基於此提醒，Emma 決定不再依賴 AI 對 GME 的建議，轉而依靠其他資訊來源。

**場景 2：無警告情況**  
用戶 Frank 進入準確度追蹤頁面，頁面頂部未顯示警告區域。Frank 查看股票明細表格，發現所有股票的準確率均高於 50%，最低的準確率為 55%。Frank 對此感到滿意，認為 AI 分析整體表現良好，決定繼續依賴 AI 建議進行投資決策。

---

## 3. 系統架構與技術規格

### 3.1 系統架構概覽

本功能採用前後端分離的架構設計，前端使用 React 19 + TypeScript 構建用戶介面，後端使用 Express 4 + tRPC 11 提供 API 服務，數據庫使用 MySQL/TiDB 儲存歷史分析記錄和準確度統計結果。系統架構遵循分層設計原則，包含表現層（Presentation Layer）、業務邏輯層（Business Logic Layer）和數據存取層（Data Access Layer）。

**表現層**負責用戶介面的渲染和互動邏輯，包含準確度追蹤頁面、個股深度分析報告對話框和各類圖表元件。表現層透過 tRPC 客戶端與後端 API 通訊，獲取準確度統計數據並呈現給用戶。

**業務邏輯層**負責準確度計算、趨勢分析、報告生成和提醒識別等核心業務邏輯。此層包含準確度計算模組（analysisAccuracy.ts）和 tRPC 路由定義（routers.ts），提供標準化的 API 介面供前端調用。

**數據存取層**負責與數據庫的互動，包含歷史分析記錄的查詢、股價數據的獲取和準確度統計結果的儲存。此層包含數據庫操作模組（db.ts）和股價數據獲取模組（twse.ts），提供統一的數據存取介面。

### 3.2 技術棧

**前端技術棧**：React 19、TypeScript、Tailwind CSS 4、Recharts（圖表庫）、Wouter（路由）、tRPC React Query（API 客戶端）、shadcn/ui（UI 元件庫）。

**後端技術棧**：Node.js 22、Express 4、tRPC 11、TypeScript、Zod（輸入驗證）、Drizzle ORM（數據庫 ORM）。

**數據庫**：MySQL/TiDB，使用 Drizzle ORM 進行數據存取。

**圖表庫**：Recharts，提供折線圖、圓餅圖和柱狀圖等多種圖表類型，支援響應式設計和互動功能。

### 3.3 數據結構設計

#### 3.3.1 時間趨勢數據結構

```typescript
interface TrendDataPoint {
  month: string;          // 月份，格式：YYYY-MM
  total: number;          // 該月份的總分析次數
  accurate: number;       // 該月份的準確分析次數
  accuracyRate: number;   // 該月份的準確率（0-1）
}

interface AccuracyTrend {
  overall: TrendDataPoint[];                    // 整體準確率趨勢
  byRecommendation: {                           // 按建議類型的準確率趨勢
    買入: TrendDataPoint[];
    持有: TrendDataPoint[];
    賣出: TrendDataPoint[];
  };
}
```

#### 3.3.2 個股分析報告數據結構

```typescript
interface AnalysisCase {
  id: number;                       // 分析記錄 ID
  date: Date;                       // 分析日期
  recommendation: string;           // 建議類型（買入/持有/賣出）
  priceAtAnalysis: number;          // 分析時價格
  priceAfter30Days: number | null;  // 30 天後價格
  priceChange: number | null;       // 價格變化百分比
  isAccurate: boolean | null;       // 是否準確
  profit: number | null;            // 假設投資 $10,000 的獲利/虧損
}

interface StockAnalysisReport {
  symbol: string;                                   // 股票代號
  totalAnalyses: number;                            // 總分析次數
  recommendationCounts: {                           // 建議類型次數統計
    買入: number;
    持有: number;
    賣出: number;
  };
  accuracyRates: {                                  // 準確率統計
    overall: number;                                // 整體準確率
    買入: number;                                   // 買入建議準確率
    持有: number;                                   // 持有建議準確率
    賣出: number;                                   // 賣出建議準確率
  };
  bestCase: AnalysisCase | null;                    // 最佳預測案例
  worstCase: AnalysisCase | null;                   // 最差預測案例
  recentCases: AnalysisCase[];                      // 最近 10 次分析記錄
}
```

#### 3.3.3 低準確率警告數據結構

```typescript
interface LowAccuracyWarning {
  symbol: string;             // 股票代號
  totalAnalyses: number;      // 總分析次數
  accuracyRate: number;       // 準確率（0-1）
  recommendation: string;     // 最近一次建議類型
}
```

### 3.4 準確度計算邏輯

#### 3.4.1 準確度評估標準

準確度評估基於以下標準，確保評估邏輯符合投資實務：

**買入建議**：如果分析後 N 天股價上漲 ≥ 3%，視為準確。此標準反映買入建議的目標是獲取股價上漲收益，3% 的閾值排除了微小波動的影響。

**賣出建議**：如果分析後 N 天股價下跌 ≥ 3%，視為準確。此標準反映賣出建議的目標是避免股價下跌損失或獲取做空收益。

**持有建議**：如果分析後 N 天股價變化在 ±3% 範圍內，視為準確。此標準反映持有建議的目標是維持現狀，避免不必要的交易成本。

**評估時間範圍**：系統支援 7 天、30 天、90 天三種評估時間範圍，分別對應短期、中期和長期的投資決策視角。

#### 3.4.2 準確率計算公式

整體準確率計算公式：

```
整體準確率 = 準確分析次數 / 總分析次數
```

按建議類型準確率計算公式：

```
買入建議準確率 = 準確的買入建議次數 / 總買入建議次數
持有建議準確率 = 準確的持有建議次數 / 總持有建議次數
賣出建議準確率 = 準確的賣出建議次數 / 總賣出建議次數
```

按股票準確率計算公式：

```
股票 X 準確率 = 股票 X 的準確分析次數 / 股票 X 的總分析次數
```

#### 3.4.3 獲利/損失計算邏輯

假設投資金額為 $10,000，獲利/損失計算邏輯如下：

**買入建議**：獲利 = 價格變化百分比 × $10,000。例如，股價上漲 12%，獲利 = 0.12 × $10,000 = $1,200。

**賣出建議**：獲利 = -價格變化百分比 × $10,000（模擬做空）。例如，股價下跌 15%，獲利 = -(-0.15) × $10,000 = $1,500。

**持有建議**：不計算獲利，因為持有建議不涉及買賣交易。

---

## 4. API 規格

### 4.1 API 架構

本功能使用 tRPC 11 框架構建 API，提供類型安全的端到端通訊。所有 API 定義在 `server/routers.ts` 中的 `analysis` 路由器下，前端透過 tRPC React Query 客戶端調用 API。

### 4.2 API 端點規格

#### 4.2.1 獲取準確度統計 API

**API 名稱**：`analysis.getAccuracyStats`

**請求方法**：Query

**輸入參數**：無

**輸出格式**：

```typescript
{
  overall: {
    total: number;
    accurate7Days: number;
    accurate30Days: number;
    accurate90Days: number;
    accuracyRate7Days: number;
    accuracyRate30Days: number;
    accuracyRate90Days: number;
  };
  byRecommendation: {
    [key: string]: {
      total: number;
      accurate7Days: number;
      accurate30Days: number;
      accurate90Days: number;
      accuracyRate7Days: number;
      accuracyRate30Days: number;
      accuracyRate90Days: number;
    };
  };
  bySymbol: {
    [key: string]: {
      total: number;
      accurate7Days: number;
      accurate30Days: number;
      accurate90Days: number;
      accuracyRate7Days: number;
      accuracyRate30Days: number;
      accuracyRate90Days: number;
    };
  };
  records: AccuracyRecord[];
}
```

**業務邏輯**：調用 `calculateAccuracyStats()` 函數，計算整體準確率、按建議類型準確率和按股票準確率，返回完整的準確度統計結果。

**錯誤處理**：如果數據庫查詢失敗，返回 500 錯誤並記錄錯誤日誌。

#### 4.2.2 獲取準確度時間趨勢 API

**API 名稱**：`analysis.getAccuracyTrend`

**請求方法**：Query

**輸入參數**：

```typescript
{
  timeRange: 7 | 30 | 90;  // 評估時間範圍
}
```

**輸出格式**：

```typescript
{
  overall: TrendDataPoint[];
  byRecommendation: {
    買入: TrendDataPoint[];
    持有: TrendDataPoint[];
    賣出: TrendDataPoint[];
  };
}
```

**業務邏輯**：調用 `calculateAccuracyTrend(timeRange)` 函數，按月份統計準確率，返回整體趨勢和按建議類型趨勢。

**錯誤處理**：如果數據庫查詢失敗或股價數據獲取失敗，返回 500 錯誤並記錄錯誤日誌。

#### 4.2.3 獲取個股深度分析報告 API

**API 名稱**：`analysis.getStockReport`

**請求方法**：Query

**輸入參數**：

```typescript
{
  symbol: string;  // 股票代號
}
```

**輸出格式**：

```typescript
{
  symbol: string;
  totalAnalyses: number;
  recommendationCounts: {
    買入: number;
    持有: number;
    賣出: number;
  };
  accuracyRates: {
    overall: number;
    買入: number;
    持有: number;
    賣出: number;
  };
  bestCase: AnalysisCase | null;
  worstCase: AnalysisCase | null;
  recentCases: AnalysisCase[];
}
```

**業務邏輯**：調用 `generateStockAnalysisReport(symbol)` 函數，生成該股票的完整分析報告，包含歷史建議統計、準確率分析、最佳/最差案例和最近分析記錄。

**錯誤處理**：如果股票代號無效或數據庫查詢失敗，返回 400 或 500 錯誤並記錄錯誤日誌。

#### 4.2.4 獲取低準確率警告 API

**API 名稱**：`analysis.getLowAccuracyWarnings`

**請求方法**：Query

**輸入參數**：

```typescript
{
  threshold: number;        // 準確率閾值，預設 0.5
  timeRange: 7 | 30 | 90;   // 評估時間範圍，預設 30
}
```

**輸出格式**：

```typescript
LowAccuracyWarning[]
```

**業務邏輯**：調用 `checkLowAccuracyStocks(threshold, timeRange)` 函數，識別準確率低於閾值且至少有 3 次分析記錄的股票，返回警告列表並按準確率從低到高排序。

**錯誤處理**：如果數據庫查詢失敗，返回 500 錯誤並記錄錯誤日誌。

---

## 5. UI/UX 設計規格

### 5.1 設計原則

**一致性**：所有 UI 元件應遵循平台現有的設計風格，使用 shadcn/ui 元件庫和 Tailwind CSS 4 樣式系統，確保視覺一致性。

**清晰性**：資訊呈現應清晰明瞭，避免過度複雜的視覺設計。圖表應使用適當的顏色、標籤和圖例，確保用戶能夠快速理解數據。

**互動性**：圖表和表格應支援互動功能，例如滑鼠懸停顯示詳細資訊、點擊查看更多細節等，提升用戶體驗。

**響應式設計**：所有 UI 元件應支援響應式設計，在不同螢幕尺寸（桌面、平板、手機）下均能正常顯示和操作。

**無障礙設計**：UI 元件應遵循無障礙設計原則，支援鍵盤導航、螢幕閱讀器和適當的顏色對比度。

### 5.2 準確度追蹤頁面設計

#### 5.2.1 頁面佈局

準確度追蹤頁面採用垂直佈局，從上到下依序包含：頁面標題與返回按鈕、時間範圍選擇器、低準確率警告區域（條件顯示）、整體準確度統計卡片、準確率圖表區域、準確度時間趨勢圖、股票明細表格和說明卡片。

**頁面標題與返回按鈕**：頁面頂部顯示標題「AI 分析準確度追蹤」和返回首頁的按鈕，提供清晰的導航路徑。

**時間範圍選擇器**：頁面標題下方顯示三個按鈕（7 天、30 天、90 天），用戶點擊按鈕切換評估時間範圍，選中的按鈕顯示為主色調，未選中的按鈕顯示為次要色調。

**低準確率警告區域**：當存在低準確率股票時，在時間範圍選擇器下方顯示黃色警告區域，包含警告標題、描述文字和警告卡片網格。

**整體準確度統計卡片**：顯示三張卡片，分別對應 7 天、30 天、90 天後的整體準確率，卡片包含準確率百分比、準確分析次數和總分析次數。

**準確率圖表區域**：顯示兩張並排的圖表卡片，左側為整體準確率圓餅圖，右側為按建議類型準確率柱狀圖。

**準確度時間趨勢圖**：顯示準確率隨時間變化的折線圖，X 軸為月份，Y 軸為準確率百分比。

**股票明細表格**：顯示所有股票的準確度明細，包含股票代號、分析次數、7 天準確率、30 天準確率、90 天準確率和「查看報告」按鈕。

**說明卡片**：頁面底部顯示準確度評估標準的說明文字，幫助用戶理解準確率的計算邏輯。

#### 5.2.2 低準確率警告區域設計

**背景顏色**：使用黃色背景（`bg-yellow-50`）和黃色邊框（`border-yellow-200`），確保警告區域醒目。

**警告圖示**：標題左側顯示黃色警告圖示（`AlertTriangle`），增強視覺突出性。

**標題文字**：標題為「低準確率股票警告」，使用黃色文字（`text-yellow-800`），字體加粗。

**描述文字**：描述為「以下股票的 AI 分析準確率低於 50%，建議謹慎參考 AI 建議」，使用黃色文字（`text-yellow-700`）。

**警告卡片**：以網格佈局顯示警告卡片（每行最多 3 張），每張卡片包含股票代號、準確率紅色徽章、分析次數、最近建議和「查看詳細報告」按鈕。

#### 5.2.3 準確度時間趨勢圖設計

**圖表類型**：折線圖（LineChart），使用 Recharts 庫實作。

**X 軸**：月份，格式為 YYYY-MM，例如 2025-01。

**Y 軸**：準確率百分比，範圍 0-100%。

**折線顏色**：使用藍色（`#3b82f6`）作為主折線顏色，確保視覺清晰。

**數據點標記**：折線上顯示圓形數據點標記（半徑 4px），滑鼠懸停時放大至半徑 6px。

**網格線**：顯示虛線網格（`strokeDasharray="3 3"`），幫助用戶讀取數值。

**互動提示框**：滑鼠懸停在數據點上時，顯示該月份的準確率百分比（精確到小數點後一位）。

**圖例**：圖表底部顯示圖例，標示「準確率」折線。

### 5.3 個股深度分析報告對話框設計

#### 5.3.1 對話框佈局

對話框採用大尺寸設計（最大寬度 4xl），支援垂直滾動，從上到下依序包含：對話框標題與描述、概覽統計卡片、歷史建議統計卡片、最佳/最差預測案例卡片和最近分析記錄表格。

**對話框標題**：顯示股票代號和「AI 分析表現報告」，例如「AAPL - AI 分析表現報告」。

**對話框描述**：顯示「歷史分析建議回顧、準確率統計和案例分析」。

**概覽統計卡片**：四張並排的卡片，分別顯示總分析次數、整體準確率、最佳預測獲利和最差預測損失。

**歷史建議統計卡片**：顯示買入、持有、賣出建議的次數和準確率，以三欄並排佈局。

**最佳/最差預測案例卡片**：兩張並排的卡片，左側為最佳案例（綠色邊框），右側為最差案例（紅色邊框），顯示案例詳細資訊。

**最近分析記錄表格**：顯示最近 10 次分析記錄的詳細表格，包含分析日期、建議類型、分析時價格、30 天後價格、價格變化和準確性標記。

#### 5.3.2 概覽統計卡片設計

**卡片佈局**：四張卡片以網格佈局並排顯示（`grid-cols-4`），每張卡片包含標題和數值。

**標題樣式**：使用小字體和次要顏色（`text-sm text-muted-foreground`），例如「總分析次數」。

**數值樣式**：使用大字體和加粗樣式（`text-2xl font-bold`），整體準確率使用主色調（`text-primary`），最佳獲利使用綠色（`text-green-600`），最差損失使用紅色（`text-red-600`）。

#### 5.3.3 最佳/最差預測案例卡片設計

**最佳案例卡片**：使用綠色邊框（`border-green-200`），標題為「最佳預測案例」，使用綠色文字（`text-green-600`）。

**最差案例卡片**：使用紅色邊框（`border-red-200`），標題為「最差預測案例」，使用紅色文字（`text-red-600`）。

**案例詳情**：以列表形式顯示日期、建議、分析時價格、30 天後價格、價格變化和假設獲利/損失，價格變化和獲利/損失使用對應的顏色（綠色或紅色）並加粗。

### 5.4 顏色規範

**主色調**：藍色（`#3b82f6`），用於折線圖、按鈕和重要資訊。

**成功色**：綠色（`#10b981`），用於正面資訊，例如準確率高、獲利等。

**警告色**：黃色（`#f59e0b`），用於警告資訊，例如低準確率警告。

**錯誤色**：紅色（`#ef4444`），用於負面資訊，例如準確率低、虧損等。

**次要色**：灰色（`#6b7280`），用於次要文字和邊框。

### 5.5 字體規範

**標題字體**：使用 `text-2xl` 或 `text-3xl`，字體加粗（`font-bold`）。

**正文字體**：使用 `text-base`，正常字重（`font-normal`）。

**次要文字**：使用 `text-sm` 或 `text-xs`，次要顏色（`text-muted-foreground`）。

**數值字體**：使用 `text-2xl` 或 `text-3xl`，字體加粗（`font-bold`），根據數值類型使用對應顏色。

---

## 6. 測試規格與驗收標準

### 6.1 單元測試規格

#### 6.1.1 準確度計算邏輯測試

**測試目標**：驗證準確度計算邏輯的正確性，確保買入、持有、賣出建議的準確性判斷符合預期。

**測試案例 1**：買入建議準確性判斷  
- **輸入**：建議類型 = 買入，分析時價格 = $100，N 天後價格 = $105  
- **預期輸出**：準確（因為股價上漲 5% ≥ 3%）

**測試案例 2**：買入建議不準確性判斷  
- **輸入**：建議類型 = 買入，分析時價格 = $100，N 天後價格 = $98  
- **預期輸出**：不準確（因為股價下跌 2%）

**測試案例 3**：賣出建議準確性判斷  
- **輸入**：建議類型 = 賣出，分析時價格 = $100，N 天後價格 = $95  
- **預期輸出**：準確（因為股價下跌 5% ≥ 3%）

**測試案例 4**：持有建議準確性判斷  
- **輸入**：建議類型 = 持有，分析時價格 = $100，N 天後價格 = $102  
- **預期輸出**：準確（因為股價變化 2% 在 ±3% 範圍內）

#### 6.1.2 時間趨勢計算測試

**測試目標**：驗證時間趨勢計算邏輯的正確性，確保按月份統計準確率的結果符合預期。

**測試案例 1**：單月準確率計算  
- **輸入**：2025-01 月份有 10 次分析，其中 7 次準確  
- **預期輸出**：2025-01 月份準確率 = 70%

**測試案例 2**：多月趨勢計算  
- **輸入**：2025-01 至 2025-03 三個月份的分析記錄  
- **預期輸出**：返回三個 TrendDataPoint，分別對應三個月份的準確率

#### 6.1.3 個股報告生成測試

**測試目標**：驗證個股報告生成邏輯的正確性，確保最佳/最差案例識別和獲利/損失計算符合預期。

**測試案例 1**：最佳案例識別  
- **輸入**：股票 A 有 5 次分析記錄，其中 3 次準確，獲利分別為 $500、$1000、$800  
- **預期輸出**：最佳案例為獲利 $1000 的記錄

**測試案例 2**：最差案例識別  
- **輸入**：股票 A 有 5 次分析記錄，其中 2 次不準確，虧損分別為 -$500、-$1200  
- **預期輸出**：最差案例為虧損 -$1200 的記錄

### 6.2 整合測試規格

#### 6.2.1 API 整合測試

**測試目標**：驗證 API 端點的輸入輸出正確性，確保前後端通訊正常。

**測試案例 1**：獲取準確度統計 API  
- **請求**：調用 `analysis.getAccuracyStats`  
- **預期輸出**：返回包含 overall、byRecommendation、bySymbol 和 records 的完整統計結果

**測試案例 2**：獲取準確度時間趨勢 API  
- **請求**：調用 `analysis.getAccuracyTrend`，輸入 `timeRange = 30`  
- **預期輸出**：返回包含 overall 和 byRecommendation 的趨勢數據

**測試案例 3**：獲取個股深度分析報告 API  
- **請求**：調用 `analysis.getStockReport`，輸入 `symbol = "AAPL"`  
- **預期輸出**：返回 AAPL 的完整分析報告

**測試案例 4**：獲取低準確率警告 API  
- **請求**：調用 `analysis.getLowAccuracyWarnings`，輸入 `threshold = 0.5, timeRange = 30`  
- **預期輸出**：返回準確率低於 50% 的股票列表

#### 6.2.2 前後端整合測試

**測試目標**：驗證前端頁面與後端 API 的整合正確性，確保數據正確顯示。

**測試案例 1**：準確度追蹤頁面載入  
- **操作**：用戶進入準確度追蹤頁面  
- **預期結果**：頁面成功載入，顯示整體準確度統計、圖表和股票明細表格

**測試案例 2**：時間範圍切換  
- **操作**：用戶點擊「7 天」按鈕  
- **預期結果**：頁面重新載入數據，顯示 7 天後準確率的統計和趨勢圖

**測試案例 3**：查看個股報告  
- **操作**：用戶點擊股票明細表格中的「查看報告」按鈕  
- **預期結果**：開啟個股深度分析報告對話框，顯示該股票的完整報告

**測試案例 4**：低準確率警告顯示  
- **操作**：用戶進入準確度追蹤頁面，且存在低準確率股票  
- **預期結果**：頁面頂部顯示黃色警告區域，列出所有低準確率股票

### 6.3 UI/UX 測試規格

#### 6.3.1 視覺一致性測試

**測試目標**：驗證 UI 元件的視覺風格與平台現有設計一致。

**測試案例 1**：顏色規範  
- **檢查項目**：所有按鈕、卡片、圖表和文字的顏色是否符合顏色規範  
- **預期結果**：所有顏色符合規範，無不一致的顏色使用

**測試案例 2**：字體規範  
- **檢查項目**：所有標題、正文和次要文字的字體大小和字重是否符合字體規範  
- **預期結果**：所有字體符合規範，無不一致的字體使用

#### 6.3.2 響應式設計測試

**測試目標**：驗證 UI 元件在不同螢幕尺寸下的顯示和操作正確性。

**測試案例 1**：桌面顯示  
- **測試環境**：1920x1080 解析度的桌面瀏覽器  
- **預期結果**：所有元件正常顯示，佈局合理，無溢出或遮擋

**測試案例 2**：平板顯示  
- **測試環境**：768x1024 解析度的平板瀏覽器  
- **預期結果**：所有元件正常顯示，卡片和圖表自動調整佈局，無溢出或遮擋

**測試案例 3**：手機顯示  
- **測試環境**：375x667 解析度的手機瀏覽器  
- **預期結果**：所有元件正常顯示，卡片和圖表垂直堆疊，無溢出或遮擋

#### 6.3.3 互動功能測試

**測試目標**：驗證 UI 元件的互動功能正確性。

**測試案例 1**：圖表互動  
- **操作**：滑鼠懸停在折線圖的數據點上  
- **預期結果**：顯示互動提示框，包含該月份的準確率百分比

**測試案例 2**：按鈕互動  
- **操作**：點擊時間範圍選擇器的按鈕  
- **預期結果**：按鈕狀態切換，選中的按鈕顯示為主色調，未選中的按鈕顯示為次要色調

**測試案例 3**：對話框互動  
- **操作**：點擊「查看報告」按鈕，然後點擊對話框的關閉按鈕  
- **預期結果**：對話框開啟並顯示報告，點擊關閉按鈕後對話框關閉

### 6.4 效能測試規格

#### 6.4.1 API 響應時間測試

**測試目標**：驗證 API 響應時間符合效能要求。

**測試案例 1**：獲取準確度統計 API  
- **測試條件**：數據庫包含 100 條歷史分析記錄  
- **預期結果**：API 響應時間 < 2 秒

**測試案例 2**：獲取準確度時間趨勢 API  
- **測試條件**：數據庫包含 100 條歷史分析記錄  
- **預期結果**：API 響應時間 < 3 秒

**測試案例 3**：獲取個股深度分析報告 API  
- **測試條件**：該股票有 50 條歷史分析記錄  
- **預期結果**：API 響應時間 < 2 秒

#### 6.4.2 前端渲染效能測試

**測試目標**：驗證前端頁面渲染效能符合要求。

**測試案例 1**：準確度追蹤頁面載入  
- **測試條件**：頁面包含 20 支股票的明細表格和多個圖表  
- **預期結果**：頁面完全載入時間 < 3 秒

**測試案例 2**：圖表渲染  
- **測試條件**：折線圖包含 12 個月份的數據點  
- **預期結果**：圖表渲染時間 < 1 秒

### 6.5 驗收標準

#### 6.5.1 功能完整性驗收

**驗收標準 1**：準確度時間趨勢分析功能完整實作，包含整體趨勢圖和按建議類型趨勢圖，支援三種評估時間範圍切換。

**驗收標準 2**：個股深度分析報告功能完整實作，包含概覽統計、歷史建議統計、最佳/最差案例和最近分析記錄，報告對話框設計符合規格。

**驗收標準 3**：準確度提醒功能完整實作，低準確率警告區域正確顯示，警告卡片包含所有必要資訊，支援快速查看報告。

#### 6.5.2 準確性驗收

**驗收標準 4**：準確度計算邏輯正確，買入、持有、賣出建議的準確性判斷符合評估標準。

**驗收標準 5**：時間趨勢計算邏輯正確，按月份統計準確率的結果準確無誤。

**驗收標準 6**：個股報告生成邏輯正確，最佳/最差案例識別和獲利/損失計算符合預期。

#### 6.5.3 效能驗收

**驗收標準 7**：所有 API 響應時間符合效能要求（< 3 秒）。

**驗收標準 8**：前端頁面載入和圖表渲染時間符合效能要求（< 3 秒）。

#### 6.5.4 用戶體驗驗收

**驗收標準 9**：UI 設計符合設計規格，顏色、字體和佈局一致。

**驗收標準 10**：響應式設計正確，在桌面、平板和手機上均能正常顯示和操作。

**驗收標準 11**：互動功能正常，圖表、按鈕和對話框的互動行為符合預期。

**驗收標準 12**：錯誤處理友善，當數據不足或查詢失敗時，顯示清晰的提示訊息。

---

## 7. 風險與限制

### 7.1 技術風險

**股價數據獲取失敗**：準確度計算依賴歷史股價數據，如果股價數據 API（TWSE API）無法正常運作或返回不完整的數據，將導致準確度計算失敗。緩解措施包含實作數據緩存機制和錯誤重試邏輯，確保數據獲取的穩定性。

**大量數據計算效能**：當歷史分析記錄數量龐大（例如超過 10,000 條）時，準確度計算和趨勢分析可能耗時較長，影響用戶體驗。緩解措施包含實作數據分頁、異步計算和結果緩存機制，降低計算負擔。

**前端圖表渲染效能**：當趨勢圖包含大量數據點（例如超過 100 個月份）時，圖表渲染可能變慢。緩解措施包含限制顯示的數據點數量（例如最多顯示最近 24 個月）和使用虛擬滾動技術。

### 7.2 業務風險

**準確度評估標準的主觀性**：準確度評估標準（例如 3% 的價格變化閾值）具有一定的主觀性，不同用戶可能對「準確」有不同的定義。緩解措施包含在說明卡片中清楚解釋評估標準，並考慮未來提供用戶自訂閾值的功能。

**低準確率警告的誤報**：當股票的歷史分析記錄較少（例如僅 3-5 次）時，準確率統計可能不具代表性，導致誤報低準確率警告。緩解措施包含設定最小分析次數閾值（例如至少 5 次）和在警告卡片中顯示分析次數，提醒用戶注意樣本大小。

**用戶過度依賴準確度統計**：用戶可能過度依賴準確度統計結果，忽略其他重要的投資因素（例如基本面分析、市場環境等）。緩解措施包含在說明卡片中提醒用戶，準確度統計僅供參考，不應作為唯一的投資決策依據。

### 7.3 限制

**歷史數據依賴**：準確度追蹤功能完全依賴歷史分析記錄和股價數據，對於新股票或新用戶，可能無法提供有意義的準確度統計。

**評估時間範圍限制**：系統僅支援 7 天、30 天、90 天三種評估時間範圍，無法滿足所有用戶的需求（例如某些用戶可能希望查看 180 天或 1 年後的準確率）。未來可考慮增加更多時間範圍選項。

**單一市場支援**：當前系統主要支援美股和台股，對於其他市場（例如港股、A 股）的支援有限。未來可考慮擴展至更多市場。

---

## 8. 未來擴展建議

### 8.1 功能擴展

**用戶自訂準確度閾值**：允許用戶自訂準確度提醒閾值（預設 50%），並根據個人風險偏好設定不同的警告等級（例如 < 40% 為高風險警告，40-60% 為中風險提醒）。

**準確度改進追蹤**：添加「準確度改進計畫」功能，當系統識別到某類建議準確率偏低時，自動記錄並追蹤後續改進措施的效果，形成持續優化循環。

**AI 分析參數優化建議**：根據準確度統計結果，為不同產業或市值的股票提供 AI 分析參數調整建議（例如某些產業適合短期分析，某些適合長期分析），提升整體準確率。

**準確度預測功能**：基於歷史趨勢數據，使用機器學習模型預測未來幾個月的準確率趨勢，幫助用戶提前了解 AI 模型的預期表現。

### 8.2 技術優化

**數據緩存機制**：實作準確度統計結果的緩存機制，降低重複計算的負擔，提升 API 響應速度。

**異步計算**：將耗時的準確度計算和趨勢分析改為異步執行，避免阻塞主執行緒，提升系統響應性。

**數據分頁**：對於大量歷史分析記錄，實作數據分頁機制，降低單次查詢的數據量，提升查詢效能。

**圖表優化**：使用更高效的圖表庫或實作虛擬滾動技術，提升大量數據點的圖表渲染效能。

### 8.3 用戶體驗優化

**互動式教學**：為新用戶提供互動式教學（例如引導式導覽），幫助用戶快速了解準確度追蹤功能的使用方法和價值。

**個性化推薦**：根據用戶的投資偏好和歷史行為，推薦最相關的準確度統計資訊和個股報告。

**多語言支援**：提供多語言介面（例如英文、中文、日文），擴大用戶群體。

**無障礙優化**：進一步優化無障礙設計，確保視障用戶和其他特殊需求用戶能夠順利使用功能。

---

## 9. 結論

本 SA Spec 規格書詳細定義了「AI 分析準確度追蹤優化功能」的需求、設計、實作和測試規格，為開發團隊提供完整的技術藍圖。三個核心功能模組（準確度時間趨勢分析、個股深度分析報告、準確度提醒功能）共同構成完整的 AI 分析準確度追蹤體系，幫助用戶更全面地評估 AI 分析的可靠性，並做出更明智的投資決策。

透過嚴格的測試規格和驗收標準，確保功能的正確性、效能和用戶體驗符合預期。同時，本規格書也識別了潛在的技術風險和業務風險，並提出相應的緩解措施。未來可根據用戶反饋和業務需求，進一步擴展功能和優化技術，持續提升平台的競爭力和用戶滿意度。

---

**文件版本歷史**

| 版本 | 日期 | 撰寫者 | 變更說明 |
|------|------|--------|----------|
| 1.0  | 2025-11-19 | Manus AI | 初版完成 |
