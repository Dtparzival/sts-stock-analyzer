# 台股資料庫系統後端實作交付文件

**版本**: v3.0  
**日期**: 2025-01-02  
**專案**: 台股資料庫系統 (us-stock-analyzer)

---

## 一、實作概述

本次實作根據《台股資料庫系統交付文件》與《台股資料庫系統實作總結》，完成了台股資料庫系統的後端核心功能開發，包含 API 整合層、資料同步機制、tRPC API 介面與工具腳本。

### 實作原則

1. **系統效能佳** - 採用批次處理、指數退避重試機制，確保高效能與穩定性
2. **程式簡潔易讀** - 遵循 TypeScript 最佳實踐，程式碼結構清晰，註解完整
3. **易於維護與擴充** - 模組化設計，職責分明，便於未來功能擴充
4. **無重複代碼** - 提取共用邏輯為獨立函數，避免代碼重複

---

## 二、已實作功能

### 2.1 API 整合層

#### 檔案位置
- `server/integrations/finmind.ts` - FinMind API 整合模組
- `server/integrations/dataTransformer.ts` - 資料轉換與驗證模組

#### 核心功能

**FinMind API 整合** (`finmind.ts`)
- `fetchAllStockInfo()` - 獲取所有股票基本資料
- `fetchStockPrice()` - 獲取單一股票歷史價格
- `fetchBatchStockPrices()` - 批次獲取多檔股票價格（支援並行請求）
- 指數退避重試機制（最多重試 3 次）
- 完整的錯誤處理與記錄

**資料轉換** (`dataTransformer.ts`)
- `transformStockInfo()` / `transformStockInfoBatch()` - 股票基本資料轉換
- `transformStockPrice()` / `transformStockPriceBatch()` - 股票價格資料轉換
- `validateStockInfo()` / `validateStockPrice()` - 資料驗證
- 數值轉換工具：`centsToYuan()`, `basisPointsToPercent()`, `formatDate()`

#### 設計特點
- 使用 TypeScript 型別定義確保型別安全
- 價格資料以「分」為單位儲存（避免浮點數精度問題）
- 漲跌幅以「基點」為單位儲存（1 基點 = 0.01%）
- 完整的資料驗證與清理機制

---

### 2.2 資料同步機制

#### 檔案位置
- `server/jobs/syncTwStockData.ts` - 資料同步主程式

#### 核心功能

**同步功能**
- `syncStockInfo()` - 同步股票基本資料
- `syncStockPrices(date)` - 同步單一日期的歷史價格
- `syncStockPricesRange(startDate, endDate)` - 同步日期範圍的歷史價格

**排程功能**
- `scheduleStockInfoSync()` - 股票基本資料同步排程（每週日凌晨 02:00）
- `scheduleStockPriceSync()` - 歷史價格同步排程（每交易日凌晨 02:00，T+1 模式）
- `startAllSchedules()` - 啟動所有排程

**輔助功能**
- `isTradingDay(date)` - 判斷是否為交易日（排除週末與國定假日）
- `getPreviousTradingDay(date)` - 取得前一交易日
- `getHolidayList(year)` - 取得國定假日清單

#### 設計特點
- **T+1 模式**：每日凌晨同步前一交易日的資料，避開盤中時段
- **離峰時間執行**：排程設定在凌晨 02:00，減少對系統的影響
- **完整的錯誤處理**：記錄同步狀態與錯誤詳情，失敗時發送通知
- **批次處理**：支援大量股票的批次同步，提升效能

---

### 2.3 tRPC API 介面

#### 檔案位置
- `server/routers/twStock.ts` - 台股 API 路由模組
- `server/routers.ts` - 主路由（已整合台股路由）

#### API 端點

**查詢類 API**
- `twStock.search` - 搜尋股票（支援代號、名稱、簡稱模糊搜尋）
- `twStock.getDetail` - 獲取股票詳情
- `twStock.getHistorical` - 獲取歷史價格（支援日期範圍查詢）
- `twStock.getLatestPrice` - 獲取最新價格
- `twStock.getBatchLatestPrices` - 批次獲取最新價格（最多 100 檔）
- `twStock.getRecentPrices` - 獲取最近 N 天的價格
- `twStock.getActiveStocks` - 獲取活躍股票清單（支援市場與產業篩選）
- `twStock.getStatistics` - 獲取統計資訊

**管理類 API（需管理員權限）**
- `twStock.getSyncStatus` - 獲取同步狀態
- `twStock.triggerSync` - 手動觸發同步

#### 設計特點
- 使用 Zod 進行輸入驗證
- 完整的錯誤處理與型別定義
- 支援分頁查詢（透過 `limit` 參數）
- 價格資料自動轉換為「元」與「百分比」格式（前端友善）

---

### 2.4 工具腳本

#### 檔案位置
- `scripts/initTwStockData.mjs` - 初始化腳本
- `scripts/syncSpecificData.mjs` - 特定資料同步腳本
- `scripts/validateData.mjs` - 資料驗證腳本

#### 使用方式

**初始化腳本**
```bash
# 完整初始化（股票基本資料 + 最近 30 天價格）
node scripts/initTwStockData.mjs

# 僅初始化股票基本資料
node scripts/initTwStockData.mjs --stocks-only

# 僅初始化歷史價格資料
node scripts/initTwStockData.mjs --prices-only

# 自訂載入天數
node scripts/initTwStockData.mjs --days=90
```

**特定資料同步腳本**
```bash
# 同步股票基本資料
node scripts/syncSpecificData.mjs --type=stocks

# 同步特定日期的價格資料
node scripts/syncSpecificData.mjs --type=prices --date=2024-01-15

# 同步日期範圍的價格資料
node scripts/syncSpecificData.mjs --type=pricesRange --start=2024-01-01 --end=2024-01-31
```

**資料驗證腳本**
```bash
# 驗證所有資料
node scripts/validateData.mjs --type=all

# 驗證股票基本資料
node scripts/validateData.mjs --type=stocks

# 驗證價格資料
node scripts/validateData.mjs --type=prices

# 驗證特定股票的價格資料（詳細模式）
node scripts/validateData.mjs --type=prices --symbol=2330 --verbose

# 驗證同步狀態
node scripts/validateData.mjs --type=sync
```

---

## 三、測試結果

### 3.1 單元測試

已建立完整的單元測試，涵蓋核心功能：

**測試檔案**
- `tests/finmind.test.ts` - FinMind API 整合測試
- `tests/dataTransformer.test.ts` - 資料轉換測試（✓ 10/10 通過）
- `tests/twStockRouter.test.ts` - tRPC API 測試

**測試結果**
```
✓ tests/dataTransformer.test.ts (10 tests) 16ms
  ✓ 資料轉換 (10)
    ✓ 股票基本資料轉換 (4)
      ✓ 應該正確轉換股票基本資料
      ✓ 應該正確處理上櫃股票
      ✓ 應該批次轉換股票基本資料
      ✓ 應該過濾掉無效的股票資料
    ✓ 股票價格資料轉換 (3)
      ✓ 應該正確轉換股票價格資料
      ✓ 應該批次轉換股票價格資料
      ✓ 應該過濾掉無效的價格資料
    ✓ 數值轉換工具 (3)
      ✓ 應該正確轉換分為元
      ✓ 應該正確轉換基點為百分比
      ✓ 應該正確格式化日期
```

### 3.2 功能驗證

- ✅ FinMind API 連接正常
- ✅ 資料轉換與驗證功能正常
- ✅ tRPC API 端點可正常呼叫
- ✅ 排程系統已整合至伺服器啟動流程

---

## 四、系統架構

### 4.1 資料流程

```
FinMind API
    ↓
API 整合層 (finmind.ts)
    ↓
資料轉換層 (dataTransformer.ts)
    ↓
資料庫操作層 (db.ts)
    ↓
tRPC API 層 (twStock.ts)
    ↓
前端應用
```

### 4.2 排程系統

```
伺服器啟動
    ↓
startAllSchedules()
    ├─ scheduleStockInfoSync() → 每週日凌晨 02:00
    └─ scheduleStockPriceSync() → 每交易日凌晨 02:00 (T+1)
```

### 4.3 錯誤處理機制

1. **API 層級**：指數退避重試（最多 3 次）
2. **同步層級**：記錄錯誤詳情至 `twDataSyncErrors` 表
3. **通知機制**：同步失敗時發送通知給系統管理員

---

## 五、資料庫設計

### 5.1 核心資料表

**股票基本資料** (`twStocks`)
- `symbol` - 股票代號（主鍵）
- `name` - 股票名稱
- `shortName` - 股票簡稱
- `market` - 市場類型（TWSE/TPEx）
- `industry` - 產業分類
- `listedDate` - 上市日期
- `isActive` - 是否活躍

**歷史價格資料** (`twStockPrices`)
- `symbol` - 股票代號
- `date` - 交易日期
- `open`, `high`, `low`, `close` - 開高低收（單位：分）
- `volume` - 成交量
- `amount` - 成交金額
- `change` - 漲跌（單位：分）
- `changePercent` - 漲跌幅（單位：基點）

**同步狀態記錄** (`twDataSyncStatus`)
- `dataType` - 資料類型（stocks/prices）
- `source` - 資料來源（finmind）
- `lastSyncAt` - 最後同步時間
- `status` - 同步狀態（success/partial/failed）
- `recordCount` - 記錄數量
- `errorMessage` - 錯誤訊息

**同步錯誤記錄** (`twDataSyncErrors`)
- `dataType` - 資料類型
- `symbol` - 股票代號
- `errorType` - 錯誤類型
- `errorMessage` - 錯誤訊息
- `errorStack` - 錯誤堆疊
- `retryCount` - 重試次數
- `resolved` - 是否已解決
- `syncedAt` - 同步時間

---

## 六、使用指南

### 6.1 首次部署

1. **初始化資料庫**
   ```bash
   pnpm db:push
   ```

2. **載入初始資料**
   ```bash
   node scripts/initTwStockData.mjs
   ```

3. **驗證資料完整性**
   ```bash
   node scripts/validateData.mjs --type=all
   ```

### 6.2 日常維護

**檢查同步狀態**
```bash
node scripts/validateData.mjs --type=sync
```

**手動同步特定日期資料**
```bash
node scripts/syncSpecificData.mjs --type=prices --date=2024-01-15
```

**補齊歷史資料**
```bash
node scripts/syncSpecificData.mjs --type=pricesRange --start=2024-01-01 --end=2024-01-31
```

### 6.3 API 使用範例

**前端呼叫範例**
```typescript
import { trpc } from '@/lib/trpc';

// 搜尋股票
const { data } = await trpc.twStock.search.useQuery({
  query: '台積電',
  limit: 10,
});

// 獲取股票詳情
const { data } = await trpc.twStock.getDetail.useQuery({
  symbol: '2330',
});

// 獲取歷史價格
const { data } = await trpc.twStock.getHistorical.useQuery({
  symbol: '2330',
  startDate: '2024-01-01',
  endDate: '2024-01-31',
});

// 獲取最新價格
const { data } = await trpc.twStock.getLatestPrice.useQuery({
  symbol: '2330',
});
```

---

## 七、注意事項

### 7.1 FinMind API 限制

- **免費版限制**：每分鐘 600 次請求
- **資料延遲**：T+1 模式（前一交易日資料）
- **資料範圍**：僅支援台股（上市、上櫃）

### 7.2 排程時間設定

- **股票基本資料**：每週日凌晨 02:00（資料變動較少）
- **歷史價格資料**：每交易日凌晨 02:00（T+1 模式）
- **建議**：避免在交易時段執行同步，以免影響系統效能

### 7.3 資料儲存格式

- **價格資料**：以「分」為單位儲存（避免浮點數精度問題）
- **漲跌幅**：以「基點」為單位儲存（1 基點 = 0.01%）
- **日期格式**：統一使用 `YYYY-MM-DD` 格式

### 7.4 錯誤處理

- 同步失敗時會記錄至 `twDataSyncErrors` 表
- 系統管理員會收到通知
- 可透過 `validateData.mjs` 腳本檢查錯誤狀態

---

## 八、未來擴充建議

### 8.1 功能擴充

1. **即時報價**：整合證交所即時報價 API
2. **技術指標**：計算 MA、RSI、MACD 等技術指標
3. **基本面資料**：整合財報、股利、營收等資料
4. **自訂警示**：支援價格、成交量等條件警示

### 8.2 效能優化

1. **快取機制**：針對熱門股票建立快取
2. **資料壓縮**：歷史資料壓縮儲存
3. **分散式同步**：支援多節點並行同步

### 8.3 監控與告警

1. **同步監控**：建立 Dashboard 監控同步狀態
2. **效能監控**：追蹤 API 回應時間與錯誤率
3. **資料品質監控**：自動檢測資料異常

---

## 九、交付清單

### 9.1 程式碼檔案

**API 整合層**
- ✅ `server/integrations/finmind.ts`
- ✅ `server/integrations/dataTransformer.ts`

**資料同步機制**
- ✅ `server/jobs/syncTwStockData.ts`
- ✅ `server/_core/index.ts` (已整合排程啟動)

**tRPC API 介面**
- ✅ `server/routers/twStock.ts`
- ✅ `server/routers.ts` (已整合台股路由)

**工具腳本**
- ✅ `scripts/initTwStockData.mjs`
- ✅ `scripts/syncSpecificData.mjs`
- ✅ `scripts/validateData.mjs`

**測試檔案**
- ✅ `tests/finmind.test.ts`
- ✅ `tests/dataTransformer.test.ts`
- ✅ `tests/twStockRouter.test.ts`

### 9.2 文件

- ✅ 本交付文件
- ✅ `todo.md` (開發追蹤清單)

---

## 十、總結

本次實作完成了台股資料庫系統的後端核心功能，包含：

1. **完整的 API 整合層**：支援 FinMind API 呼叫、資料轉換與驗證
2. **穩定的資料同步機制**：支援自動排程與手動觸發，採用 T+1 模式與離峰時間執行
3. **完善的 tRPC API 介面**：提供豐富的查詢功能，支援分頁與批次操作
4. **實用的工具腳本**：支援初始化、同步與驗證等日常維護作業
5. **完整的單元測試**：確保核心功能的正確性與穩定性

系統設計遵循「效能佳、程式簡潔、易維護、無重複」的原則，為後續前端開發與功能擴充奠定了堅實的基礎。

---

**交付日期**: 2025-01-02  
**實作者**: Manus AI Agent  
**版本**: v3.0
